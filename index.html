<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - è·¨è£ç½®åŒæ­¥ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --primary: #d32f2f; --gold: #ffd700; --track-bg: #1a1a1a; 
            --success: #4caf50; --danger: #ff5252; --sprint: #ff5722;
        }
        body { font-family: 'PingFang TC', sans-serif; background: #121212; color: white; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* ç®¡ç†å“¡é¢æ¿ */
        #admin-panel { position: fixed; top: 0; left: 0; width: 100%; background: rgba(211, 47, 47, 0.95); padding: 8px; text-align: center; z-index: 9999; display: none; }
        .emergency-btn { background: white; color: var(--primary); border: none; padding: 4px 12px; font-weight: bold; border-radius: 4px; cursor: pointer; }

        /* æ¨™é¡Œèˆ‡ç™»å…¥å€ */
        .header-title { text-align: center; margin: 15px 0; color: var(--gold); font-size: 24px; }
        #user-login { background: #1e1e1e; padding: 20px; border-radius: 20px; text-align: center; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 400px; border: 2px solid var(--gold); z-index: 100; }
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .name-btn { padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 10px; cursor: pointer; }
        .name-btn.taken { opacity: 0.2; pointer-events: none; }

        /* é¸é¦¬å€ */
        .setup-area { flex-grow: 1; overflow-y: auto; padding: 10px; display: none; }
        .horse-select-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .horse-slot { background: #2a2a2a; padding: 15px; border-radius: 15px; border: 2px solid #3d3d3d; cursor: pointer; position: relative; }
        .horse-slot.my-pick { border: 3px solid var(--success); }
        .horse-slot.occupied { opacity: 0.4; pointer-events: none; }
        .occupied-label { position: absolute; top: 40%; left: 20%; background: var(--primary); color: white; padding: 5px 15px; font-weight: bold; transform: rotate(-10deg); border-radius: 5px; }

        /* è³½é“ - é—œéµä¿®æ­£ï¼šä½¿ç”¨å®¹å™¨å¯¬åº¦ä¾†æ˜ å°„è™›æ“¬åº§æ¨™ */
        .track-container { position: relative; width: 95vw; flex-grow: 1; background: var(--track-bg); border: 2px solid #333; border-radius: 10px; display: none; margin: 10px auto; overflow: hidden; }
        .finish-line { position: absolute; right: 50px; top: 0; bottom: 0; width: 15px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); border-left: 2px solid var(--gold); z-index: 1; }
        .lane { position: relative; border-bottom: 1px solid rgba(255,255,255,0.1); height: calc(100% / 10); display: flex; align-items: center; }
        .horse-container { position: absolute; left: 0; z-index: 10; display: flex; align-items: center; width: 100px; will-change: left; }
        .horse-icon { font-size: 28px; transform: scaleX(-1); }
        .status-bubble { position: absolute; top: -30px; left: 0; font-size: 10px; padding: 2px 6px; border-radius: 5px; display: none; background: var(--primary); color: white; white-space: nowrap; }

        #start-btn { width: 200px; padding: 15px; font-size: 20px; background: var(--primary); color: white; border: none; border-radius: 50px; cursor: pointer; margin: 20px auto; display: none; }
        #leaderboard { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 400px; background: white; color: #111; border-radius: 20px; padding: 20px; z-index: 1000; display: none; text-align: center; box-shadow: 0 0 50px black; }
        .rank-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-weight: bold; }
    </style>
</head>
<body>

    <div id="admin-panel">
        <button class="emergency-btn" onclick="resetData()">ğŸ”§ é‡ç½®æ‰€æœ‰æ•¸æ“š</button>
    </div>

    <h2 class="header-title">ğŸ 2026 AIOT è³½é¦¬ (è·¨å±åŒæ­¥)</h2>

    <div id="user-login">
        <h3>ä½ æ˜¯å“ªä½åŒä»ï¼Ÿ</h3>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="setup" class="setup-area">
        <div class="horse-select-grid" id="select-grid"></div>
    </div>

    <button id="start-btn">ğŸ é–‹è³½ï¼ (ç®¡ç†å“¡)</button>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%;"></div>
    </div>

    <div id="leaderboard">
        <h2 style="color: var(--primary)">ğŸ† æ¯”è³½çµæœ ğŸ†</h2>
        <div id="leaderboard-list"></div>
        <button onclick="resetData()" style="margin-top:15px; padding:10px 20px; cursor:pointer;">é‡å•Ÿä¸‹ä¸€å±€</button>
    </div>

    <audio id="bgm" loop src="https://actions.google.com/config/promo/sdk/v1/sample_audio/gameloop.m4a"></audio>
    <audio id="snd-start" src="https://www.soundjay.com/misc/sounds/starting-pistol-1.mp3"></audio>

<script>
    // --- 1. Firebase é…ç½® ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. è³‡æ–™è¨­å®š ---
    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", spd: 0.60, sta: 0.95 },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", spd: 0.50, sta: 0.65 },
        { id: 2, trait: "çˆ†è‚ç‹", spd: 0.95, sta: 0.25 },
        { id: 3, trait: "æœƒè­°æ©Ÿ", spd: 0.75, sta: 0.60 },
        { id: 4, trait: "å’–å•¡ç‹‚", spd: 0.80, sta: 0.45 },
        { id: 5, trait: "ç”©é‹ç‹", spd: 0.45, sta: 0.85 },
        { id: 6, trait: "é‚Šç·£äºº", spd: 0.55, sta: 0.90 },
        { id: 7, trait: "æˆªç¨¿ç‹", spd: 0.35, sta: 0.70 },
        { id: 8, trait: "å˜´ç ²ç‹", spd: 0.85, sta: 0.50 },
        { id: 9, trait: "ç©©å®šç‹", spd: 0.70, sta: 0.75 }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
    let raceStarted = false;
    let finishedHorses = [];

    // --- 3. åˆå§‹åŒ– ---
    function init() {
        if (isAdmin) { document.getElementById('start-btn').style.display = 'block'; document.getElementById('admin-panel').style.display = 'block'; }
        
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button'); btn.className = 'name-btn'; btn.id = `name-${n}`; btn.innerText = n;
            btn.onclick = () => { myName = n; db.ref(`users/${n}`).set(true); document.getElementById('bgm').play().catch(()=>{}); };
            nameGrid.appendChild(btn);
        });

        const horseGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div'); div.className = 'horse-slot'; div.id = `slot-${i}`;
            div.innerHTML = `<b>NO.${i+1} ${h.trait}</b><br><small>é€Ÿåº¦: ${h.spd*100} é«”åŠ›: ${h.sta*100}</small>`;
            div.onclick = () => { if (myName) db.ref(`assignments/${myName}`).set(i); };
            horseGrid.appendChild(div);
        });
        listenFirebase();
    }

    function listenFirebase() {
        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (!state && raceStarted) location.reload();
            if (state && state.status === 'racing' && !raceStarted) startTheGame(state.seed, state.participants);
        });
        db.ref('users').on('value', snap => {
            const users = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`name-${n}`);
                if (users[n]) { 
                    btn.classList.add('taken'); 
                    if (n === myName) { 
                        document.getElementById('user-login').style.display = 'none'; 
                        document.getElementById('setup').style.display = 'block'; 
                    } 
                }
            });
        });
        db.ref('assignments').on('value', snap => {
            const assigns = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`slot-${i}`);
                slot.classList.remove('occupied', 'my-pick');
                const owner = Object.keys(assigns).find(n => assigns[n] === i);
                if (owner) {
                    if (owner === myName) slot.classList.add('my-pick');
                    else {
                        slot.classList.add('occupied');
                        if(!slot.querySelector('.occupied-label')){
                            const l=document.createElement('div'); l.className='occupied-label'; l.innerText=owner; slot.appendChild(l);
                        }
                    }
                }
            });
        });
    }

    function resetData() { db.ref().set(null); location.reload(); }

    document.getElementById('start-btn').onclick = () => {
        db.ref('assignments').once('value', snap => {
            const p = snap.val() || {};
            if (Object.keys(p).length < 1) return alert("æ²’äººé¸é¦¬ï¼");
            db.ref('gameState').set({ status: 'racing', seed: Math.random(), participants: p });
        });
    };

    // --- 4. è³½é¦¬å¼•æ“ (æ ¸å¿ƒä¿®æ­£ï¼šè™›æ“¬åº§æ¨™ç³»çµ±) ---
    function startTheGame(seed, participants) {
        raceStarted = true;
        document.getElementById('setup').style.display = 'none';
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('user-login').style.display = 'none';
        document.getElementById('track').style.display = 'block';
        document.getElementById('snd-start').play();

        const list = Object.keys(participants).map(name => ({ name, horseData: horseLibrary[participants[name]] }));
        const lanesBox = document.getElementById('lanes-box');
        list.forEach(item => {
            const lane = document.createElement('div'); lane.className = 'lane';
            lane.innerHTML = `<div class="horse-container" id="horse-${item.horseData.id}"><div class="status-bubble" id="status-${item.horseData.id}"></div><div class="horse-icon">ğŸ</div><div style="font-size:10px;">${item.name}</div></div>`;
            lanesBox.appendChild(lane);
        });

        // è™›æ“¬è³½é“è¨­å®š
        const VIRTUAL_FINISH = 1000; // è™›æ“¬é•·åº¦ 1000 å–®ä½
        const trackEl = document.getElementById('track');
        
        // æ ¸å¿ƒåŒæ­¥é‚è¼¯
        let seedVal = seed * 1000000;
        const syncRand = () => { seedVal = (seedVal * 9301 + 49297) % 233280; return seedVal / 233280; };
        
        const horses = list.map(item => ({ ...item.horseData, ownerName: item.name, v_pos: 0, speed: 0, currStamina: 100, finished: false, isStalled: false, stallEndFrame: 0 }));
        let frame = 0;

        const timer = setInterval(() => {
            frame++;
            // æ¯å¹€ç²å–ç•¶å‰è£ç½®çš„å¯¦éš›é¡¯ç¤ºå¯¬åº¦
            const realTrackWidth = trackEl.offsetWidth - 120; 

            horses.forEach(h => {
                if (h.finished) return;

                // --- ç‰©ç†è¨ˆç®— (åŸºæ–¼è™›æ“¬å–®ä½) ---
                if (!h.isStalled) {
                    let cost = (h.speed * 0.05 + 0.1) * (h.id === 2 ? 1.8 : 1.0);
                    h.currStamina = Math.max(0, h.currStamina - cost);
                }
                if (h.currStamina <= 0 && !h.isStalled) {
                    h.speed = 0; h.isStalled = true; h.stallEndFrame = frame + 60;
                    updateBubble(h.id, "ğŸ¤® æ²’é«”åŠ›");
                }
                if (h.isStalled && frame >= h.stallEndFrame) { h.currStamina = 80; h.isStalled = false; updateBubble(h.id, "", false); }

                if (!h.isStalled) {
                    let acc = syncRand() * 0.15; // è™›æ“¬å–®ä½çš„åŠ é€Ÿåº¦
                    if (h.id === 1 && frame > 300) acc += 1.0; // åŒæ­¥æŠ€èƒ½
                    h.speed = (h.speed * 0.95) + acc + (h.spd * 0.05);
                }

                if (!h.isStalled && frame % 40 === 0 && syncRand() < 0.03) {
                    h.v_pos = Math.max(0, h.v_pos - 50); h.isStalled = true; h.stallEndFrame = frame + 40;
                    updateBubble(h.id, "â›¸ï¸ æ»‘å€’!");
                }

                h.v_pos += h.speed;

                // --- æ¸²æŸ“è¨ˆç®— (è™›æ“¬åº§æ¨™ -> å¯¦éš›åƒç´ ) ---
                const realX = (h.v_pos / VIRTUAL_FINISH) * realTrackWidth;
                const el = document.getElementById(`horse-${h.id}`);
                if (el) el.style.left = Math.min(realX, realTrackWidth + 50) + 'px';

                // åˆ¤æ–·åˆ°é” (åŸºæ–¼è™›æ“¬åº§æ¨™)
                if (h.v_pos >= VIRTUAL_FINISH && !h.finished) {
                    h.finished = true;
                    finishedHorses.push(h);
                    if (finishedHorses.length === horses.length) { clearInterval(timer); showLeaderboard(); }
                }
            });
        }, 50);
    }

    function updateBubble(id, text, display = true) {
        const el = document.getElementById(`status-${id}`); if (el) { el.innerText = text; el.style.display = display ? 'block' : 'none'; }
    }

    function showLeaderboard() {
        document.getElementById('leaderboard').style.display = 'block';
        const listEl = document.getElementById('leaderboard-list');
        listEl.innerHTML = finishedHorses.map((h, i) => `<div class="rank-row"><span>#${i+1} ${h.ownerName}</span><span>${h.trait}</span></div>`).join('');
    }

    init();
</script>
</body>
</html>
