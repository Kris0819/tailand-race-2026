<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - Proç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #ff3e3e;
            --gold: #ffcf4b;
            --glass: rgba(255, 255, 255, 0.1);
            --bg: #0f0f13;
            --card-bg: #1a1a24;
        }

        body {
            font-family: 'PingFang TC', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: white;
            margin: 0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* èƒŒæ™¯æµå…‰ç‰¹æ•ˆ */
        body::before {
            content: "";
            position: fixed;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(211,47,47,0.05) 0%, transparent 70%);
            z-index: -1;
        }

        /* æ¨™é¡Œèˆ‡å°èˆª */
        header {
            padding: 20px 10px;
            text-align: center;
            background: linear-gradient(180deg, rgba(0,0,0,0.5) 0%, transparent 100%);
        }
        .logo {
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(to bottom, var(--gold), #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* é¸äººèˆ‡é¸é¦¬å¡ç‰‡å„ªåŒ– */
        .container {
            width: 92%;
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        .name-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .btn-choice {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #ccc;
            padding: 18px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .btn-choice:active { transform: scale(0.95); }
        .btn-choice.taken { opacity: 0.3; filter: grayscale(1); pointer-events: none; border-style: dashed; }
        .btn-choice.me { 
            background: linear-gradient(135deg, #4caf50, #2e7d32); 
            color: white; 
            border-color: #81c784;
            box-shadow: 0 0 20px rgba(76,175,80,0.4);
        }

        /* é¸é¦¬å€å„ªåŒ– */
        .horse-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        .horse-card {
            background: #252530;
            border-radius: 20px;
            padding: 16px;
            display: flex;
            align-items: center;
            position: relative;
            border: 2px solid transparent;
            transition: 0.3s;
        }
        .horse-card.selected { border-color: var(--gold); background: #2a2a3a; }
        .horse-card.occupied { opacity: 0.4; pointer-events: none; }
        
        .horse-avatar { font-size: 40px; margin-right: 15px; }
        .horse-info { flex: 1; }
        .horse-info h4 { margin: 0; color: var(--gold); font-size: 18px; }
        .horse-info p { margin: 4px 0 0; font-size: 12px; color: #aaa; }
        
        .skill-tag {
            font-size: 10px;
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            color: #eee;
        }

        /* è³½é“ - Mobile Ready */
        .track-container {
            width: 100vw;
            flex-grow: 1;
            background: #111;
            display: none;
            position: relative;
            overflow: hidden;
            border-top: 2px solid #333;
        }
        .lane {
            height: 60px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            position: relative;
            background: repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(255,255,255,0.02) 40px, rgba(255,255,255,0.02) 41px);
        }
        .horse-runner {
            position: absolute;
            height: 50px;
            display: flex;
            align-items: center;
            transition: left 0.1s linear;
            z-index: 10;
        }
        .runner-icon { font-size: 30px; transform: scaleX(-1); }
        .runner-name { font-size: 10px; position: absolute; bottom: -5px; width: 100%; text-align: center; }

        /* å€’æ•¸è¨ˆæ™‚ */
        #countdown {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: 900;
            color: var(--gold);
            z-index: 2000;
            display: none;
            text-shadow: 0 0 30px rgba(255,215,0,0.5);
        }

        /* ç®¡ç†å“¡ä»‹é¢ */
        #admin-bar {
            position: fixed;
            bottom: 0; width: 100%;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            display: none;
            justify-content: center;
            z-index: 1000;
        }
        .btn-start {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 0 20px var(--primary);
        }

        /* çµç®—ç•«é¢ */
        #result-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
    </style>
</head>
<body>

<header>
    <div class="logo">2026 AIOT Racing</div>
</header>

<div id="countdown">3</div>

<div id="login-screen" class="container">
    <div class="card">
        <h3 style="text-align: center; margin-top: 0;">é¸æ“‡ä½ çš„åƒè³½èº«ä»½</h3>
        <div class="name-grid" id="name-grid"></div>
    </div>
</div>

<div id="select-screen" class="container" style="display: none;">
    <div class="card">
        <h3 style="text-align: center; margin-top: 0;">æŒ‘é¸ä½ çš„æˆ°é¦¬</h3>
        <div class="horse-grid" id="horse-grid"></div>
    </div>
</div>

<div id="track" class="track-container">
    <div id="lanes"></div>
    <div style="position: absolute; right: 60px; top:0; bottom:0; width:10px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); opacity: 0.5;"></div>
</div>

<div id="admin-bar">
    <button class="btn-start" onclick="triggerStart()">ğŸ æº–å‚™é–‹è³½ï¼</button>
</div>

<div id="result-overlay">
    <h1 style="color:var(--gold)">ğŸ† æ¯”è³½çµæœ ğŸ†</h1>
    <div id="rank-list" style="width: 100%; max-width: 400px;"></div>
    <button class="btn-choice" style="margin-top: 20px; width: 200px;" onclick="location.reload()">å›é¦–é </button>
</div>

<audio id="bgm-lobby" loop src="https://actions.google.com/config/promo/sdk/v1/sample_audio/gameloop.m4a"></audio>
<audio id="bgm-race" loop src="https://www.soundjay.com/free-music/sounds/action-rhythms-01.mp3"></audio>
<audio id="snd-click" src="https://www.soundjay.com/buttons/sounds/button-16.mp3"></audio>
<audio id="snd-countdown" src="https://www.soundjay.com/clocks/sounds/tick-tock-3.mp3"></audio>
<audio id="snd-win" src="https://www.soundjay.com/human/sounds/applause-01.mp3"></audio>

<script>
    // --- Data & Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", emoji: "ğŸ¦¥", skill: "çœé›»æ¨¡å¼ï¼šå¾ŒåŠæ®µé«”åŠ›æ¶ˆè€—æ¸›åŠ", stats: {spd: 60, sta: 95} },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", emoji: "ğŸ†", skill: "æ€¥è‘—å›å®¶ï¼šçµ‚é»å‰ 20% é€Ÿåº¦ç¿»å€", stats: {spd: 55, sta: 65} },
        { id: 2, trait: "çˆ†è‚å·¥ç¨‹å¸«", emoji: "ğŸ”¥", skill: "æ¥µé™è¶…é »ï¼šèµ·æ­¥æ¥µå¿«ä½†æ˜“éç†±", stats: {spd: 95, sta: 30} },
        { id: 3, trait: "æœƒè­°ç™¼è¨€äºº", emoji: "ğŸ¦œ", skill: "å¤§è©±ç²¾ï¼šéš¨æ©Ÿå¹²æ“¾ä»–äººé€Ÿåº¦", stats: {spd: 70, sta: 60} },
        { id: 4, trait: "å’–å•¡èƒå–å“¡", emoji: "â˜•", skill: "å’–å•¡å› å›è£œï¼šé«”åŠ›è€—ç›¡æ™‚ç¬é–“æ¢å¾© 30%", stats: {spd: 75, sta: 45} },
        { id: 5, trait: "ç”©é‹é«˜æ‰‹", emoji: "ğŸ§¤", skill: "æ‘©æ“¦åŠ› 0ï¼šå®Œç¾é¿é–‹æ‰€æœ‰æ»‘å€’äº‹ä»¶", stats: {spd: 50, sta: 80} }
    ];

    const names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';

    // --- Logic ---
    function init() {
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'btn-choice';
            btn.id = `name-${n}`;
            btn.innerText = n;
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        const horseGrid = document.getElementById('horse-grid');
        horseLibrary.forEach((h, i) => {
            const card = document.createElement('div');
            card.className = 'horse-card';
            card.id = `hcard-${i}`;
            card.innerHTML = `
                <div class="horse-avatar">${h.emoji}</div>
                <div class="horse-info">
                    <h4>${h.trait} <span class="skill-tag">${h.skill}</span></h4>
                    <p>é€Ÿåº¦: ${h.stats.spd} | è€åŠ›: ${h.stats.sta}</p>
                </div>
            `;
            card.onclick = () => selectHorse(i);
            horseGrid.appendChild(card);
        });

        if (isAdmin) document.getElementById('admin-bar').style.display = 'flex';
        sync();
    }

    function playSnd(id) { document.getElementById(id).currentTime = 0; document.getElementById(id).play().catch(()=>{}); }

    function login(n) {
        myName = n;
        db.ref(`users/${n}`).set(true);
        playSnd('snd-click');
        document.getElementById('bgm-lobby').play().catch(()=>{});
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('select-screen').style.display = 'block';
    }

    function selectHorse(idx) {
        if (!myName) return;
        db.ref(`assignments/${myName}`).set(idx);
        playSnd('snd-click');
    }

    function sync() {
        db.ref('users').on('value', snap => {
            const users = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`name-${n}`);
                if (users[n]) btn.classList.add('taken');
                if (n === myName) btn.classList.add('me');
            });
        });

        db.ref('assignments').on('value', snap => {
            const assigns = snap.val() || {};
            document.querySelectorAll('.horse-card').forEach(c => c.classList.remove('occupied', 'selected'));
            Object.entries(assigns).forEach(([name, hIdx]) => {
                const card = document.getElementById(`hcard-${hIdx}`);
                if (name === myName) card.classList.add('selected');
                else card.classList.add('occupied');
            });
        });

        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (state && state.status === 'racing') {
                runRaceSequence(state.seed, state.participants);
            }
        });
    }

    function triggerStart() {
        db.ref('assignments').once('value', snap => {
            const parts = snap.val();
            if (!parts) return alert("é‚„æ²’äººé¸é¦¬ï¼");
            db.ref('gameState').set({ status: 'racing', seed: Math.random(), participants: parts });
        });
    }

    async function runRaceSequence(seed, participants) {
        document.getElementById('select-screen').style.display = 'none';
        document.getElementById('track').style.display = 'block';
        document.getElementById('bgm-lobby').pause();
        
        // æ¸²æŸ“è³½é“
        const lanes = document.getElementById('lanes');
        lanes.innerHTML = "";
        const racers = Object.entries(participants).map(([name, hIdx]) => ({
            name, ...horseLibrary[hIdx], pos: 10, speed: 0, finished: false
        }));

        racers.forEach(r => {
            const div = document.createElement('div');
            div.className = 'lane';
            div.innerHTML = `<div class="horse-runner" id="runner-${r.id}" style="left:10px">
                <div class="runner-icon">${r.emoji}</div>
                <div class="runner-name">${r.name}</div>
            </div>`;
            lanes.appendChild(div);
        });

        // å€’æ•¸
        const cd = document.getElementById('countdown');
        cd.style.display = 'block';
        for(let i=3; i>=1; i--) {
            cd.innerText = i;
            playSnd('snd-countdown');
            await new Promise(r => setTimeout(r, 1000));
        }
        cd.innerText = "GO!";
        setTimeout(() => cd.style.display = 'none', 500);
        playSnd('bgm-race');

        // å¼•æ“
        const finishLine = window.innerWidth - 80;
        let winners = [];
        const timer = setInterval(() => {
            racers.forEach(r => {
                if (r.finished) return;
                
                // ç°¡æ˜“ç‰©ç†å¼•æ“ (å¯åŠ å…¥ Skill é‚è¼¯)
                let accel = Math.random() * 0.5 + (r.stats.spd / 100);
                if (r.id === 2 && Math.random() < 0.1) accel += 2; // çˆ†è‚çˆ†ç™¼
                
                r.speed = (r.speed * 0.95) + accel;
                r.pos += r.speed;

                const el = document.getElementById(`runner-${r.id}`);
                el.style.left = r.pos + 'px';

                if (r.pos >= finishLine) {
                    r.finished = true;
                    winners.push(r);
                    if (winners.length === racers.length) {
                        clearInterval(timer);
                        showResults(winners);
                    }
                }
            });
        }, 50);
    }

    function showResults(winners) {
        const overlay = document.getElementById('result-overlay');
        const list = document.getElementById('rank-list');
        overlay.style.display = 'flex';
        playSnd('snd-win');
        confetti({ pixelApectRatio: 2, particleCount: 150, spread: 70, origin: { y: 0.6 } });

        winners.forEach((w, i) => {
            const item = document.createElement('div');
            item.className = 'btn-choice';
            item.style.width = '100%';
            item.style.marginBottom = '10px';
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.innerHTML = `<span>#${i+1} ${w.emoji} ${w.name}</span> <span style="color:var(--gold)">${w.trait}</span>`;
            list.appendChild(item);
        });
    }

    init();
</script>
</body>
</html>
