<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - é¦¬å¹´è¡Œå¤§é‹ </title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #d32f2f; --gold: #ffd700; --track-bg: #2c3e50; --success: #4caf50; --warning: #ffeb3b; --danger: #ff5252; --recover: #00bcd4; --sprint: #ff5722; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: #121212; color: white; margin: 0; padding: 10px; height: 100vh; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        .setup-area { background: #1e1e1e; padding: 20px; border-radius: 20px; width: 95vw; max-width: 1200px; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100; overflow-y: auto; max-height: 80vh; }
        .horse-select-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-top: 15px; }
        .horse-slot { background: linear-gradient(145deg, #252525, #1a1a1a); padding: 15px; border-radius: 12px; border: 2px solid #333; cursor: pointer; transition: 0.3s; position: relative; }
        .horse-slot:hover { border-color: var(--gold); }
        .horse-slot.selected { opacity: 0.5; filter: grayscale(0.8); pointer-events: none; border-color: #555; }
        .selected-badge { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); background: rgba(211, 47, 47, 0.9); color: white; padding: 5px 15px; border: 2px solid white; border-radius: 5px; font-weight: bold; z-index: 5; }
        .track-container { position: relative; width: 98vw; flex-grow: 1; background: var(--track-bg); border: 4px solid #333; border-radius: 10px; display: none; margin-top: 20px; overflow: hidden; padding-top: 40px; }
        .finish-line { position: absolute; right: 80px; top: 0; bottom: 0; width: 30px; background: repeating-linear-gradient(0deg, #fff, #fff 15px, #000 15px, #000 30px); border-left: 4px solid var(--gold); z-index: 1; }
        .lane { position: relative; height: 9.8%; border-bottom: 1px dashed rgba(255,255,255,0.05); display: flex; align-items: center; }
        .horse-container { position: absolute; left: 10px; z-index: 10; display: flex; align-items: center; width: 130px; }
        .horse-icon { font-size: 32px; transform: scaleX(-1); margin-right: 5px; }
        #start-btn { padding: 18px 80px; font-size: 26px; background: linear-gradient(135deg, var(--primary), #8e0000); color: white; border: none; border-radius: 50px; cursor: pointer; margin: 30px; display: none; font-weight: bold; }
        #leaderboard { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; background: white; color: #111; border-radius: 20px; padding: 25px; z-index: 200; display: none; border: 5px solid var(--gold); }
        .admin-controls { position: fixed; bottom: 10px; left: 10px; z-index: 1000; display: none; }
    </style>
</head>
<body>

    <h2 id="main-title" style="margin: 10px; color: var(--gold); text-align:center;">ğŸ’¼ 2026 AIOT å°¾ç‰™è³½é¦¬</h2>

    <div id="setup" class="setup-area">
        <h3 id="picker-title" style="margin:0; text-align: center; color: #fff;">è«‹æŒ‘é¸ä½ çš„é¦¬åŒ¹ (å…ˆåˆ°å…ˆå¾—)</h3>
        <div class="horse-select-grid" id="select-grid"></div>
    </div>

    <button id="start-btn">ğŸ é–‹è³½ï¼(ç®¡ç†è€…å°ˆç”¨)</button>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%;"></div>
    </div>

    <div id="leaderboard">
        <h2 style="text-align:center; color: var(--primary);">ğŸ† FINAL RANK ğŸ†</h2>
        <div id="leaderboard-list"></div>
        <button onclick="resetGame()" style="width:100%; padding:10px; margin-top:10px; cursor:pointer;">é‡æ–°é–‹å§‹(åƒ…é™ç®¡ç†è€…)</button>
    </div>

    <div class="admin-controls" id="admin-ui">
        <button onclick="resetGame()" style="background: #444; color: white;">é‡ç½®æ‰€æœ‰æ•¸æ“š</button>
    </div>

<script>
    // --- 1. è«‹æ›¿æ›æˆä½ çš„ Firebase é…ç½® ---
   const firebaseConfig = {
  apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
  authDomain: "aiot-d53dc.firebaseapp.com",
  databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
  projectId: "aiot-d53dc",
  storageBucket: "aiot-d53dc.firebasestorage.app",
  messagingSenderId: "1021331253049",
  appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
  measurementId: "G-9YDKS70ZE7"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. æ ¸å¿ƒåƒæ•¸ ---
    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, burst: 40}, desc: "æ‡‚å¾—æ‘¸é­šï¼Œç©©å®šæ€§é«˜ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65, burst: 95}, desc: "å¾Œæ®µç™¼åŠ›ï¼Œçœ‹åˆ°çµ‚é»æœƒç˜‹ç‹‚åŠ é€Ÿã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, burst: 80}, desc: "èµ·æ­¥è¶…å¿«ï¼Œä½†å¦‚æœä¸ä¼‘æ¯æœƒçˆ†è‚ã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60, burst: 60}, desc: "æ•¸å€¼å¹³å‡ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, burst: 75}, desc: "ä¾è³´å’–å•¡å› ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, burst: 30}, desc: "å…ç–«æ»‘å€’äº‹ä»¶ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, burst: 50}, desc: "è€åŠ›åè¶³ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70, burst: 99}, desc: "éš±è—ç‹è€…ã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50, burst: 70}, desc: "é«˜æ•ˆç‡ï¼Œçµ¦èº«é‚Šäººå£“åŠ›ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, burst: 65}, desc: "åˆ†é…å¹³è¡¡ã€‚" }
    ];

    const urlParams = new URLSearchParams(window.location.search);
    const isAdmin = urlParams.get('admin') === '1';
    let myName = localStorage.getItem('race_name') || "";
    let isRacing = false;

    if (isAdmin) document.getElementById('admin-ui').style.display = 'block';

    // --- 3. åˆå§‹åŒ–èˆ‡ç›£è½ ---
    function init() {
        const grid = document.getElementById('select-grid');
        grid.innerHTML = "";
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot';
            div.id = `slot-${i}`;
            div.innerHTML = `<b>${h.trait}</b><div style="font-size:24px;">ğŸ</div><p style="font-size:10px;">${h.desc}</p>`;
            div.onclick = () => selectHorse(i);
            grid.appendChild(div);
        });
    }

    // ç›£è½ Firebase ç‹€æ…‹
    db.ref('race_data').on('value', (snapshot) => {
        const data = snapshot.val() || { assignments: {}, status: 'waiting' };
        
        // æ›´æ–°é¦¬åŒ¹é¸æ“‡ç‹€æ…‹
        horseLibrary.forEach((_, i) => {
            const slot = document.getElementById(`slot-${i}`);
            if (data.assignments && data.assignments[i]) {
                slot.classList.add('selected');
                if (!slot.querySelector('.selected-badge')) {
                    slot.innerHTML += `<div class="selected-badge">${data.assignments[i].userName}</div>`;
                }
            } else {
                slot.classList.remove('selected');
                const badge = slot.querySelector('.selected-badge');
                if (badge) badge.remove();
            }
        });

        // ç®¡ç†å“¡é¡¯ç¤ºé–‹å§‹æŒ‰éˆ•
        if (isAdmin && data.status === 'waiting') {
            document.getElementById('start-btn').style.display = 'block';
        }

        // ç›£è½æ˜¯å¦é–‹è³½
        if (data.status === 'racing' && !isRacing) {
            runRace(data.seed, data.assignments);
        }
    });

    // --- 4. äº’å‹•åŠŸèƒ½ ---
    function selectHorse(idx) {
        if (!myName) {
            myName = prompt("è«‹è¼¸å…¥æ‚¨çš„å§“åï¼š");
            if (!myName) return;
            localStorage.setItem('race_name', myName);
        }

        db.ref(`race_data/assignments/${idx}`).transaction((current) => {
            if (current === null) return { userName: myName };
            return; // å·²æœ‰äººé¸
        });
    }

    document.getElementById('start-btn').onclick = function() {
        const seed = Math.random(); // ç”¢ç”ŸåŒæ­¥ç¨®å­
        db.ref('race_data/seed').set(seed);
        db.ref('race_data/status').set('racing');
    };

    function resetGame() {
        if (!isAdmin) return;
        db.ref('race_data').set({ status: 'waiting', assignments: {} });
        location.reload();
    }

    // --- 5. è³½é¦¬é‚è¼¯ (åŒæ­¥åŸ·è¡Œ) ---
    function runRace(seed, assignments) {
        isRacing = true;
        document.getElementById('setup').style.display = 'none';
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('track').style.display = 'block';

        const lanesBox = document.getElementById('lanes-box');
        lanesBox.innerHTML = "";
        
        const participants = Object.keys(assignments).map(hIdx => ({
            ...horseLibrary[hIdx],
            owner: assignments[hIdx].userName,
            pos: 10,
            finished: false
        }));

        participants.forEach((p, i) => {
            const lane = document.createElement('div');
            lane.className = 'lane';
            lane.innerHTML = `<div class="horse-container" id="horse-${p.id}"><div class="horse-icon">ğŸ</div><div>${p.owner}</div></div>`;
            lanesBox.appendChild(lane);
        });

        // ä½¿ç”¨ seed ä¾†ä¿è­‰æ‰€æœ‰äººè·‘çš„ä¸€æ¨£ (ç°¡å–®ç‰ˆï¼šåŒæ­¥æ›´æ–°ä½ç§»)
        let timer = setInterval(() => {
            let allFinished = true;
            participants.forEach(p => {
                if (p.pos < 800) {
                    p.pos += (Math.random() * 5) + (p.stats.spd * 0.05); // é€™è£¡å¯¦æˆ°å»ºè­°ç”¨ seed å‡½æ•¸
                    document.getElementById(`horse-${p.id}`).style.left = p.pos + 'px';
                    allFinished = false;
                }
            });
            if (allFinished) {
                clearInterval(timer);
                alert("æ¯”è³½çµæŸï¼");
            }
        }, 50);
    }

    init();
</script>
</body>

</html>
