<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - è¡Œå‹•å„ªåŒ–ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --primary: #d32f2f; --gold: #ffd700; --track-bg: #1a1a1a; 
            --success: #4caf50; --warning: #ffeb3b; --danger: #ff5252; 
            --recover: #00bcd4; --sprint: #ff5722; --card-bg: #252525;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: #121212; color: white; margin: 0; 
            height: 100vh; width: 100vw;
            display: flex; flex-direction: column; overflow: hidden; 
        }

        /* Admin æ§åˆ¶åˆ— */
        #admin-panel {
            background: #b71c1c; padding: 10px; display: none;
            justify-content: space-around; align-items: center;
            border-bottom: 2px solid var(--gold); z-index: 1000;
        }
        .admin-btn {
            padding: 8px 15px; border-radius: 5px; border: 1px solid white;
            background: rgba(0,0,0,0.3); color: white; font-weight: bold; font-size: 14px;
        }

        /* é ‚éƒ¨æ¨™é¡Œ */
        .app-header { padding: 15px 10px; text-align: center; }
        .app-header h2 { margin: 0; color: var(--gold); font-size: 1.2rem; letter-spacing: 2px; }

        /* é¸äººç•«é¢ - å„ªåŒ–ç‚ºå¤§æŒ‰éˆ• */
        #user-login { 
            padding: 20px; text-align: center; flex-grow: 1;
            display: flex; flex-direction: column; justify-content: center;
        }
        .name-grid { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; 
            margin-top: 20px; max-height: 70vh; overflow-y: auto; padding: 10px;
        }
        .name-btn { 
            height: 60px; background: var(--card-bg); border: 1px solid #444; 
            color: white; border-radius: 12px; font-size: 18px; font-weight: bold;
            box-shadow: 0 4px 0 #000; transition: 0.1s;
        }
        .name-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #000; }
        .name-btn.taken { opacity: 0.3; filter: grayscale(1); }
        .name-btn.me { border: 2px solid var(--gold); background: #333; color: var(--gold); }

        /* é¸é¦¬ç•«é¢ - å¡ç‰‡å¼è¨­è¨ˆ */
        .setup-area { 
            flex-grow: 1; padding: 15px; overflow-y: auto; display: none;
        }
        .horse-select-grid { 
            display: flex; flex-direction: column; gap: 15px; padding-bottom: 100px;
        }
        .horse-slot { 
            background: var(--card-bg); padding: 15px; border-radius: 15px; 
            border: 2px solid #333; position: relative; transition: 0.3s;
        }
        .horse-slot.my-pick { border-color: var(--success); background: #1b2e1b; }
        .horse-slot.occupied { opacity: 0.5; pointer-events: none; }
        .occupied-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: var(--danger); font-size: 24px; transform: rotate(-5deg);
        }

        .horse-main { display: flex; align-items: center; gap: 15px; }
        .horse-emoji { font-size: 40px; }
        .horse-info { flex-grow: 1; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 8px; }
        .stat-bar-bg { height: 6px; background: #000; border-radius: 3px; margin-top: 3px; }
        .stat-fill { height: 100%; border-radius: 3px; background: var(--gold); }

        /* è³½é“å€ - å…¨è¢å¹•å„ªåŒ– */
        .track-container { 
            position: relative; width: 100%; flex-grow: 1; background: #222; 
            display: none; overflow: hidden; border-top: 2px solid #444;
        }
        .finish-line { 
            position: absolute; right: 60px; top: 0; bottom: 0; width: 20px; 
            background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px);
            opacity: 0.5;
        }
        .lane { 
            position: relative; border-bottom: 1px solid rgba(255,255,255,0.1); 
            display: flex; align-items: center; width: 100%;
        }
        .horse-container { 
            position: absolute; left: 5px; display: flex; align-items: center; 
            z-index: 10; transition: left 0.1s linear;
        }
        .horse-icon { font-size: 24px; transform: scaleX(-1); }
        .horse-label { font-size: 10px; white-space: nowrap; max-width: 60px; overflow: hidden; }

        /* æ’è¡Œæ¦œå½ˆçª— */
        #leaderboard { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 90%; max-width: 350px; background: white; color: #111; 
            border-radius: 20px; padding: 20px; z-index: 2000; display: none;
            box-shadow: 0 0 50px rgba(0,0,0,1);
        }

        /* å›ºå®šåœ¨åº•éƒ¨çš„æŒ‰éˆ• */
        #start-btn { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 15px 60px; font-size: 20px; background: var(--primary); 
            color: white; border: none; border-radius: 30px; font-weight: bold;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.5); z-index: 900; display: none;
        }
    </style>
</head>
<body>

    <div id="admin-panel">
        <span style="font-size: 12px;">Admin Mode</span>
        <button class="admin-btn" onclick="triggerStart()">å¼·åˆ¶é–‹è³½</button>
        <button class="admin-btn" style="background: #000;" onclick="resetData()">é‡ç½®å…¨å ´æ•¸æ“š</button>
    </div>

    <div class="app-header">
        <h2 id="main-title">ğŸ’¼ 2026 AIOT å°¾ç‰™è³½é¦¬</h2>
    </div>

    <div id="user-login">
        <h3 style="margin:0; color:var(--gold);">è«‹é¸æ“‡æ‚¨çš„å§“å</h3>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="setup" class="setup-area">
        <div class="horse-select-grid" id="select-grid"></div>
    </div>

    <button id="start-btn" onclick="triggerStart()">ğŸ æ‰€æœ‰äººæº–å‚™å¥½äº†ï¼Œé–‹è³½ï¼</button>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%; width: 100%;"></div>
    </div>

    <div id="leaderboard">
        <h2 style="text-align:center; color: var(--primary); margin: 0;">ğŸ† è‹±é›„æ¦œ ğŸ†</h2>
        <div id="leaderboard-list" style="margin-top: 15px; max-height: 300px; overflow-y: auto;"></div>
        <button onclick="location.reload()" style="width:100%; padding:12px; margin-top:15px; background: #333; color: white; border: none; border-radius: 10px; font-weight: bold;">è¿”å›é¦–é </button>
        <div id="admin-only-reset" style="display:none;">
            <button onclick="resetData()" style="width:100%; padding:10px; margin-top:10px; background: #eee; color: red; border: 1px solid red; border-radius: 10px; font-size: 12px;">(Admin) é‡ç½®æ•¸æ“š</button>
        </div>
    </div>

<script>
    // --- Firebase é…ç½® ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, burst: 40, lck: 70}, desc: "é«”åŠ›æ·±ä¸å¯æ¸¬ï¼Œæ“…é•·æŒä¹…æˆ°ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65, burst: 95, lck: 60}, desc: "15ç§’å¾Œé–‹å•Ÿè¶…é »æ¨¡å¼ã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, burst: 80, lck: 30}, desc: "æ¥µé€Ÿæ¥µé«˜ï¼Œä½†è¦æ³¨æ„çˆ†è‚è™›å¼±ã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60, burst: 60, lck: 80}, desc: "ç¯€å¥ç©©å®šçš„å…¨èƒ½é¸æ‰‹ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, burst: 75, lck: 50}, desc: "é å’–å•¡å› è¡åˆºçš„çˆ†ç™¼å‹ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, burst: 30, lck: 99}, desc: "é‹æ°£æ¥µä½³ï¼Œå…ç–«æ‰€æœ‰æ»‘å€’ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, burst: 50, lck: 60}, desc: "é»˜é»˜è€•è€˜çš„è€åŠ›å¥½æ‰‹ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70, burst: 99, lck: 40}, desc: "æœ€å¾Œä¸€ç§’æœƒç™¼ç”Ÿå¥‡è¹Ÿã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50, burst: 70, lck: 60}, desc: "é æ°£å‹¢é©…å‹•çš„é«˜é€Ÿé¦¬ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, burst: 65, lck: 70}, desc: "å¹³è¡¡æ€§æœ€å¼·ï¼Œç”Ÿå­˜ç‡é«˜ã€‚" }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    const colors = ["#FF5252", "#FFD700", "#E040FB", "#00E676", "#2979FF", "#FF9100", "#40C4FF", "#FF1744", "#F4FF81", "#B2FF59"];

    let myName = localStorage.getItem('my_race_name') || "";
    const urlParams = new URLSearchParams(window.location.search);
    const isAdmin = urlParams.get('admin') === '1';
    let raceStarted = false;
    let finishedHorses = [];

    function init() {
        if (isAdmin) {
            document.getElementById('admin-panel').style.display = 'flex';
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('admin-only-reset').style.display = 'block';
        }
        
        // ç”Ÿæˆåå­—æŒ‰éˆ•
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn';
            btn.id = `name-${n}`;
            btn.innerText = n;
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        // ç”Ÿæˆé¦¬åŒ¹å¡ç‰‡
        const horseGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot';
            div.id = `slot-${i}`;
            div.innerHTML = `
                <div class="horse-main">
                    <div class="horse-emoji" style="transform: scaleX(-1);">ğŸ</div>
                    <div class="horse-info">
                        <div style="display:flex; justify-content:space-between;">
                            <b style="color:var(--gold);">${h.trait}</b>
                            <small style="color:#666;">STAFF-${i+1}</small>
                        </div>
                        <div class="stat-grid">
                            ${renderStat('é€Ÿåº¦', h.stats.spd)}
                            ${renderStat('é«”åŠ›', h.stats.sta)}
                            ${renderStat('çˆ†ç™¼', h.stats.burst)}
                            ${renderStat('å¹¸é‹', h.stats.lck)}
                        </div>
                    </div>
                </div>
                <div style="font-size:11px; color:#aaa; margin-top:8px; font-style:italic;">${h.desc}</div>
            `;
            div.onclick = () => selectHorse(i);
            horseGrid.appendChild(div);
        });

        listenFirebase();
    }

    function renderStat(label, val) {
        return `<div>
            <div style="display:flex; justify-content:space-between; font-size:9px; color:#888;">
                <span>${label}</span><span>${val}%</span>
            </div>
            <div class="stat-bar-bg"><div class="stat-fill" style="width:${val}%"></div></div>
        </div>`;
    }

    function listenFirebase() {
        db.ref('users').on('value', (snap) => {
            const users = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`name-${n}`);
                if (users[n]) {
                    btn.classList.add('taken');
                    if (n === myName) {
                        btn.classList.add('me');
                        document.getElementById('user-login').style.display = 'none';
                        document.getElementById('setup').style.display = 'block';
                    }
                } else {
                    btn.classList.remove('taken', 'me');
                }
            });
        });

        db.ref('assignments').on('value', (snap) => {
            const assignments = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`slot-${i}`);
                slot.classList.remove('occupied', 'my-pick');
                const overlay = slot.querySelector('.occupied-overlay');
                if (overlay) overlay.remove();

                const owner = Object.keys(assignments).find(name => assignments[name] === i);
                if (owner) {
                    if (owner === myName) {
                        slot.classList.add('my-pick');
                    } else {
                        slot.classList.add('occupied');
                        const div = document.createElement('div');
                        div.className = 'occupied-overlay';
                        div.innerText = owner;
                        slot.appendChild(div);
                    }
                }
            });
        });

        db.ref('gameState').on('value', (snap) => {
            const state = snap.val();
            if (state && state.status === 'racing' && !raceStarted) {
                startTheGame(state.seed, state.participants);
            } else if (!state && raceStarted) {
                location.reload(); // è¢« Admin é‡ç½®äº†
            }
        });
    }

    function login(n) {
        myName = n;
        localStorage.setItem('my_race_name', n);
        db.ref(`users/${n}`).set(true);
    }

    function selectHorse(idx) {
        if (!myName) return;
        db.ref(`assignments/${myName}`).set(idx);
    }

    function resetData() {
        if(!confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æ¸…é™¤æ‰€æœ‰ç©å®¶é¸æ“‡èˆ‡éŠæˆ²ç‹€æ…‹ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
        db.ref().set(null);
        localStorage.clear();
        location.href = window.location.pathname + (isAdmin ? "?admin=1" : "");
    }

    function triggerStart() {
        db.ref('assignments').once('value', (snap) => {
            const participants = snap.val() || {};
            if (Object.keys(participants).length === 0) {
                alert("ç›®å‰é‚„æ²’äººé¸é¦¬å–”ï¼");
                return;
            }
            db.ref('gameState').set({
                status: 'racing',
                seed: Math.random(),
                participants: participants
            });
        });
    }

    function startTheGame(seed, participants) {
        raceStarted = true;
        document.getElementById('setup').style.display = 'none';
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('user-login').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'none';
        document.getElementById('track').style.display = 'block';

        const lanesBox = document.getElementById('lanes-box');
        lanesBox.innerHTML = "";

        const list = Object.keys(participants).map((name, idx) => ({
            name: name, horseData: horseLibrary[participants[name]], color: colors[idx % colors.length]
        }));

        const laneHeight = 100 / list.length;
        list.forEach((item, idx) => {
            const lane = document.createElement('div');
            lane.className = 'lane';
            lane.style.height = `${laneHeight}%`;
            lane.innerHTML = `
                <div class="horse-container" id="horse-${item.horseData.id}">
                    <div style="position:relative;">
                        <div class="status-bubble" id="status-${item.horseData.id}" style="position:absolute; top:-30px; left:0; font-size:10px; display:none; background:red; padding:2px 5px; border-radius:5px; white-space:nowrap;"></div>
                        <div class="horse-icon" style="color:${item.color}">ğŸ</div>
                    </div>
                    <div style="margin-left:5px;">
                        <div class="horse-label">${item.name}</div>
                        <div style="width:30px; height:3px; background:#000; border-radius:2px;">
                            <div id="stamina-fill-${item.horseData.id}" style="height:100%; width:100%; background:var(--success);"></div>
                        </div>
                    </div>
                </div>`;
            lanesBox.appendChild(lane);
        });

        runRaceEngine(seed, list);
    }

    function runRaceEngine(seed, list) {
        let seedVal = seed;
        const syncRandom = () => {
            seedVal = (seedVal * 9301 + 49297) % 233280;
            return seedVal / 233280;
        };

        const horses = list.map(item => ({ 
            ...item.horseData, ownerName: item.name, 
            pos: 10, speed: 0, currStamina: 100, 
            lastEventTime: Date.now() + (syncRandom() * 2000),
            nextCooldown: 4000 + (syncRandom() * 4000),
            finished: false, isStalled: false, isBursting: false 
        }));
        
        const finishLinePos = document.getElementById('track').offsetWidth - 80; 
        const raceStart = Date.now();

        const raceInterval = setInterval(() => {
            const raceElapsed = (Date.now() - raceStart) / 1000;

            horses.forEach(h => {
                if (h.finished) return;

                // é«”åŠ›æ¶ˆè€—
                if (!h.isStalled) {
                    let drainMult = h.id === 2 ? 1.8 : (h.id === 0 ? 0.45 : 1.0);
                    h.currStamina = Math.max(0, h.currStamina - ((h.speed * 0.06 + 0.12) * drainMult));
                }

                // çˆ†è‚åˆ¤å®š
                if (h.currStamina <= 0 && !h.isStalled) {
                    h.speed = 0; h.isStalled = true;
                    setTimeout(() => { h.currStamina = 100; h.isStalled = false; }, 4000);
                }

                // é€Ÿåº¦è¨ˆç®—
                if (!h.isStalled) {
                    let accel = (syncRandom() * 0.22);
                    if (h.id === 1 && raceElapsed >= 15) accel += 2.5; // ä¸‹ç­æˆ°ç¥
                    let fatigue = h.currStamina < 20 ? 0.4 : 1.0;
                    h.speed = ((h.speed * 0.93) + accel + (h.stats.spd * 0.002)) * fatigue;
                }

                // éš¨æ©Ÿäº‹ä»¶
                if (Date.now() - h.lastEventTime > h.nextCooldown && !h.isStalled) {
                    h.lastEventTime = Date.now();
                    const roll = syncRandom();
                    if (roll < 0.08 && h.id !== 5) { // æ»‘å€’
                        h.speed = 0; h.pos = Math.max(10, h.pos - 30);
                    } else if (roll > 0.8) { // è¡åˆº
                        h.isBursting = true;
                        setTimeout(() => h.isBursting = false, 2000);
                    }
                }

                h.pos += h.speed + (h.isBursting ? 1.0 : 0);
                const el = document.getElementById(`horse-${h.id}`);
                el.style.left = h.pos + 'px';
                document.getElementById(`stamina-fill-${h.id}`).style.width = h.currStamina + '%';

                if (h.pos >= finishLinePos && !h.finished) {
                    h.finished = true;
                    finishedHorses.push(h);
                    if (finishedHorses.length === horses.length) {
                        clearInterval(raceInterval);
                        setTimeout(showLeaderboard, 1000);
                    }
                }
            });
        }, 50);
    }

    function showLeaderboard() {
        document.getElementById('leaderboard').style.display = 'block';
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = "";
        
        finishedHorses.forEach((h, i) => {
            const rank = i + 1;
            const item = document.createElement('div');
            item.style.cssText = "padding:12px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; font-size:14px;";
            
            let prize = rank === 1 ? "$2500" : (rank <= 5 ? "$1000åˆ¸" : `$${(11-rank)*100}`);
            let medal = rank === 1 ? "ğŸ¥‡" : (rank <= 3 ? "ğŸ¥ˆ" : "ğŸ¥‰");

            item.innerHTML = `
                <div><span style="width:25px; display:inline-block;">${medal}</span> <b>${h.ownerName}</b></div>
                <div style="color:var(--primary); font-weight:bold;">${prize}</div>
            `;
            list.appendChild(item);
        });
    }

    init();
</script>
</body>
</html>
