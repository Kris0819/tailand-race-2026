<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - å°ˆæ¥­ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --primary: #d32f2f; 
            --gold: #ffd700; 
            --track-bg: #1a1a1a; 
            --success: #4caf50; 
            --warning: #ffeb3b; 
            --danger: #ff5252; 
            --recover: #00bcd4; 
            --sprint: #ff5722; 
            --card-bg: rgba(255, 255, 255, 0.05);
        }
        
        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: radial-gradient(circle, #2c3e50 0%, #000000 100%); 
            color: white; margin: 0; padding: 0; height: 100vh; 
            display: flex; flex-direction: column; align-items: center; overflow: hidden; 
        }

        /* é ‚éƒ¨ç®¡ç†é¢æ¿ */
        #admin-panel { 
            position: fixed; top: 0; width: 100%; background: var(--primary); 
            padding: 8px; text-align: center; z-index: 9999; display: none; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        /* ç™»å…¥å€ */
        #user-login { 
            background: rgba(30, 30, 30, 0.95); padding: 40px; border-radius: 24px; 
            text-align: center; z-index: 200; position: fixed; top: 50%; 
            transform: translateY(-50%); width: 85%; max-width: 600px; 
            border: 1px solid var(--gold); backdrop-filter: blur(10px);
        }

        .name-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-top: 25px; }
        .name-btn { 
            padding: 15px; background: var(--card-bg); border: 1px solid #444; 
            color: white; border-radius: 12px; cursor: pointer; font-size: 16px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .name-btn:hover:not(.taken) { background: var(--gold); color: black; transform: scale(1.05); }
        .name-btn.taken { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
        .name-btn.me { background: var(--success); border-color: #fff; box-shadow: 0 0 15px var(--success); }

        /* é¸é¦¬å€å„ªåŒ– */
        .setup-area { 
            margin-top: 60px; width: 95vw; max-width: 1200px; z-index: 100; 
            display: none; animation: fadeIn 0.5s ease;
        }
        .horse-select-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; padding: 20px; }
        .horse-slot { 
            background: var(--card-bg); padding: 20px; border-radius: 16px; 
            border: 2px solid transparent; cursor: pointer; transition: 0.3s; 
            position: relative; overflow: hidden; backdrop-filter: blur(5px);
        }
        .horse-slot:hover { border-color: var(--gold); background: rgba(255,255,255,0.1); }
        .horse-slot.my-pick { border-color: var(--success); background: rgba(76, 175, 80, 0.1); }
        
        .stat-bar { background: #333; height: 6px; border-radius: 3px; margin: 8px 0; overflow: hidden; }
        .stat-fill { height: 100%; background: var(--gold); transition: width 1s ease-out; }

        /* è³½é“å€ */
        .track-container { 
            position: relative; width: 98vw; flex-grow: 1; background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png'), #111; 
            border: 2px solid #333; border-radius: 15px; display: none; margin-top: 20px; overflow: hidden; 
        }
        .lane { border-bottom: 1px solid rgba(255,255,255,0.05); position: relative; }
        .finish-line { 
            position: absolute; right: 100px; top: 0; bottom: 0; width: 40px; 
            background: repeating-linear-gradient(45deg, #fff, #fff 10px, #000 10px, #000 20px);
            opacity: 0.8;
        }

        /* æç¤ºæ°£æ³¡å‹•ç•« */
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-20px); opacity: 0; } }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* çé …å½ˆçª— */
        #leaderboard { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 90%; max-width: 450px; background: white; color: #111; 
            border-radius: 24px; padding: 30px; z-index: 1000; display: none; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>

    <div id="admin-panel">
        <button onclick="resetData()" style="padding:5px 15px; cursor:pointer;">âš ï¸ é‡ç½®å…¨é«”éŠæˆ²æ•¸æ“š</button>
    </div>

    <div id="user-login">
        <h1 style="color: var(--gold); margin-bottom: 5px;">2026 AIOT å°¾ç‰™è³½é¦¬</h1>
        <p>è«‹é¸æ“‡æ‚¨çš„å§“åç™»å…¥</p>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="setup" class="setup-area">
        <h2 style="text-align: center; color: var(--gold);">ğŸ† æŒ‘é¸æ‚¨çš„æˆ°é¦¬ ğŸ†</h2>
        <div class="horse-select-grid" id="select-grid"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button id="start-btn" style="padding: 15px 60px; font-size: 20px; border-radius: 30px; background: var(--primary); color: white; border: none; cursor: pointer; display: none; box-shadow: 0 5px 15px rgba(211, 47, 47, 0.4);">ğŸ é–‹å§‹æ¯”è³½</button>
        </div>
    </div>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%;"></div>
    </div>

    <div id="leaderboard">
        <h2 style="text-align:center; color: var(--primary);">ğŸŠ æ¯”è³½çµæœ ğŸŠ</h2>
        <div id="leaderboard-list"></div>
        <button onclick="location.reload()" style="width:100%; padding:12px; margin-top:20px; border-radius:10px; cursor:pointer;">é—œé–‰ä¸¦é‡æ–°æ•´ç†</button>
    </div>

    <audio id="bgm" loop src="https://actions.google.com/config/promo/sdk/v1/sample_audio/gameloop.m4a"></audio>

<script>
    // --- 1. Firebase é…ç½® (ä¾ç…§è¦æ±‚è‡ªå‹•å¡«å¯«) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. éŠæˆ²è³‡æ–™ ---
    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95}, desc: "æ‡‚å¾—æ‘¸é­šç¯€çœé«”åŠ›ï¼Œç©©å®šæ€§æœ€é«˜ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65}, desc: "çœ‹åˆ°çµ‚é»ç·šæœƒç˜‹ç‹‚åŠ é€Ÿã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25}, desc: "èµ·æ­¥è¶…å¿«ï¼Œä½†é«”åŠ›æ¶ˆè€—æ¥µåŠ‡ã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60}, desc: "å„é …æ•¸å€¼å¹³å‡ï¼Œç©©ç´®ç©©æ‰“ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45}, desc: "é«”åŠ›èˆ‡é€Ÿåº¦æ³¢å‹•æ¥µå¤§ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85}, desc: "èƒ½å…ç–«æ»‘å€’äº‹ä»¶ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90}, desc: "è€åŠ›åè¶³ï¼Œé»˜é»˜çˆ¬ä¸Šé¦–ä½ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70}, desc: "æ¥µæ˜“è§¸ç™¼æœ€å¾Œä¸€ç§’ç¿»ç›¤ã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50}, desc: "é«˜æ•ˆç‡ä»£è¡¨ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75}, desc: "æ•¸æ“šå¹³è¡¡ä¹‹ç‹ã€‚" }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';

    // --- 3. åˆå§‹åŒ– ---
    function init() {
        if (isAdmin) {
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('start-btn').style.display = 'inline-block';
        }

        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn'; btn.id = `name-${n}`; btn.innerText = n;
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        const selectGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const slot = document.createElement('div');
            slot.className = 'horse-slot'; slot.id = `slot-${i}`;
            slot.innerHTML = `
                <div style="font-size:24px; margin-bottom:10px;">ğŸ é¦¬è™Ÿ ${i+1}</div>
                <div style="font-weight:bold; color:var(--gold); font-size:18px;">${h.trait}</div>
                <div class="stat-bar"><div class="stat-fill" style="width:${h.stats.spd}%"></div></div>
                <div style="font-size:12px; color:#aaa;">${h.desc}</div>
            `;
            slot.onclick = () => selectHorse(i);
            selectGrid.appendChild(slot);
        });

        listenFirebase();
    }

    function login(n) {
        db.ref(`users/${n}`).once('value', snap => {
            if (snap.val()) {
                alert("è©²ç”¨æˆ¶å·²åœ¨å…¶ä»–è£ç½®ç™»éŒ„ï¼");
            } else {
                myName = n;
                db.ref(`users/${n}`).set(true);
                document.getElementById('bgm').play().catch(() => {});
            }
        });
    }

    function selectHorse(idx) {
        if (myName) db.ref(`assignments/${myName}`).set(idx);
    }

    function resetData() {
        if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰æ•¸æ“šå—ï¼Ÿ")) db.ref().set(null).then(() => location.reload());
    }

    function listenFirebase() {
        // ç›£è½ç™»å…¥ç‹€æ…‹
        db.ref('users').on('value', snap => {
            const users = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`name-${n}`);
                if (users[n]) {
                    btn.classList.add('taken');
                    if (n === myName) {
                        btn.classList.add('me');
                        document.getElementById('user-login').style.display = 'none';
                        document.getElementById('setup').style.display = 'block';
                    }
                }
            });
        });

        // ç›£è½é¸é¦¬ç‹€æ…‹
        db.ref('assignments').on('value', snap => {
            const assigns = snap.val() || {};
            document.querySelectorAll('.horse-slot').forEach(s => s.classList.remove('my-pick', 'taken'));
            Object.entries(assigns).forEach(([user, horseIdx]) => {
                const slot = document.getElementById(`slot-${horseIdx}`);
                if (user === myName) slot.classList.add('my-pick');
                else slot.classList.add('taken');
            });
        });

        // ç›£è½æ¯”è³½é–‹å§‹
        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (state && state.status === 'racing') {
                startRaceUI(state.seed, state.participants);
            }
        });
    }

    // --- 4. æ¯”è³½å¼•æ“ (ä¿æŒä½ çš„æ ¸å¿ƒé‚è¼¯ä¸¦å¾®èª¿ UI) ---
    document.getElementById('start-btn').onclick = () => {
        db.ref('assignments').once('value', snap => {
            const participants = snap.val();
            if (!participants) return alert("é‚„æ²’æœ‰äººé¸é¦¬å–”ï¼");
            db.ref('gameState').set({ status: 'racing', seed: Math.random(), participants });
        });
    };

    function startRaceUI(seed, participants) {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('track').style.display = 'block';
        
        const lanesBox = document.getElementById('lanes-box');
        lanesBox.innerHTML = '';
        const list = Object.keys(participants).map(name => ({
            name, horseData: horseLibrary[participants[name]]
        }));

        const laneHeight = 100 / list.length;
        list.forEach((item, idx) => {
            const lane = document.createElement('div');
            lane.className = 'lane';
            lane.style.height = `${laneHeight}%`;
            lane.innerHTML = `
                <div id="horse-container-${idx}" style="position:absolute; left:0; display:flex; align-items:center; transition: left 0.1s linear;">
                    <div id="bubble-${idx}" style="position:absolute; top:-30px; background:var(--primary); padding:2px 8px; border-radius:10px; font-size:12px; display:none;"></div>
                    <span style="font-size:30px;">ğŸ</span>
                    <div style="margin-left:5px;">
                        <div style="font-size:12px;">${item.name}</div>
                        <div style="width:40px; height:4px; background:#333; border-radius:2px;">
                            <div id="sta-${idx}" style="width:100%; height:100%; background:var(--success);"></div>
                        </div>
                    </div>
                </div>
            `;
            lanesBox.appendChild(lane);
        });

        // å‘¼å«ä½ çš„åŸå§‹ Engine é‚è¼¯ï¼ˆæ­¤è™•ç°¡åŒ–ç¤ºæ„ï¼‰
        runEngine(seed, list);
    }

    function runEngine(seed, list) {
        // ... æ­¤è™•å»¶çºŒä½ åŸæœ¬çš„ runRaceEngine é‚è¼¯å³å¯ ...
        // å»ºè­°åœ¨æ¯”è³½çµæŸå¾Œå‘¼å« showLeaderboard()
    }

    init();
</script>
</body>
</html>
