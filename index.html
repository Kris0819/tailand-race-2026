<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 å°¾ç‰™è³½é¦¬åŒæ­¥ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        .horse-track { height: 70px; border-bottom: 2px solid #e2e8f0; position: relative; background: white; }
        .horse-emoji { font-size: 40px; position: absolute; transition: left 0.4s linear; bottom: 5px; z-index: 10; }
        .name-tag { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); font-size: 10px; background: #4f46e5; color: white; padding: 1px 4px; border-radius: 4px; white-space: nowrap; }
        .event-popup { animation: fadeUp 1.5s forwards; position: absolute; top: -30px; left: 0; color: #ef4444; font-weight: bold; font-size: 14px; white-space: nowrap; text-shadow: 1px 1px 0 white; }
        @keyframes fadeUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }
        .btn-disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); }
        .finish-line { position: absolute; right: 40px; top: 0; bottom: 0; border-left: 4px dashed #cbd5e1; width: 2px; }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <div id="app" class="max-w-xl mx-auto p-4 min-h-screen">
        <header class="text-center py-6">
            <h1 class="text-4xl font-black text-indigo-700 tracking-tighter">ğŸ RACING 2026</h1>
            <div class="inline-block bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold mt-2">å°¾ç‰™é™å®šæŠ½çç³»çµ±</div>
        </header>

        <section id="step-user" class="bg-white p-6 rounded-3xl shadow-xl border-4 border-indigo-100">
            <h2 class="text-xl font-bold mb-4 flex items-center">ğŸ‘¤ 1. è«‹é»é¸ä½ çš„åå­—</h2>
            <div id="user-list" class="grid grid-cols-2 gap-3"></div>
        </section>

        <section id="step-horse" class="bg-white p-6 rounded-3xl shadow-xl border-4 border-indigo-100 hidden">
            <h2 class="text-xl font-bold mb-4">ğŸ 2. æŒ‘é¸æˆ°é¦¬ (å…ˆé¸å…ˆè´)</h2>
            <div id="horse-selection" class="grid grid-cols-1 gap-3"></div>
        </section>

        <section id="step-race" class="hidden">
            <div id="race-status" class="text-center font-bold text-indigo-600 mb-4 text-xl bg-white p-3 rounded-xl shadow">ç­‰å¾…æ‰€æœ‰äººæº–å‚™å°±ç·’...</div>
            <div id="track-container" class="bg-white rounded-3xl shadow-2xl overflow-hidden border-4 border-white">
                <div class="finish-line"></div>
            </div>
        </section>

        <section id="step-result" class="mt-6 hidden">
            <div class="bg-yellow-400 p-6 rounded-3xl shadow-xl">
                <h2 class="text-2xl font-black text-center mb-4">ğŸ† è³½äº‹æœ€çµ‚çµæœ</h2>
                <div id="rank-list" class="space-y-2"></div>
            </div>
        </section>

        <section id="admin-panel" class="hidden mt-10 p-6 bg-slate-900 text-white rounded-3xl shadow-2xl">
            <h2 class="text-xl font-bold mb-4 text-indigo-400">æ§åˆ¶å° (Admin Only)</h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-slate-800 p-3 rounded-xl">
                    <p class="text-xs text-gray-400">å·²é¸äººå“¡</p>
                    <div id="admin-ready-list" class="text-green-400 font-bold"></div>
                </div>
                <div class="bg-slate-800 p-3 rounded-xl">
                    <p class="text-xs text-gray-400">å°šæœªé¸æ“‡</p>
                    <div id="admin-not-ready-list" class="text-red-400 font-bold"></div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="startGame()" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-3 rounded-xl font-bold flex-1 transition">å•Ÿå‹•è³½äº‹</button>
                <button onclick="resetGame()" class="bg-slate-700 hover:bg-red-600 px-6 py-3 rounded-xl font-bold flex-1 transition">å…¨é«”é‡ç½®</button>
            </div>
        </section>
    </div>

    <audio id="bgm" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3"></audio>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
            authDomain: "aiot-d53dc.firebaseapp.com",
            databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
            projectId: "aiot-d53dc",
            storageBucket: "aiot-d53dc.firebasestorage.app",
            messagingSenderId: "1021331253049",
            appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
            measurementId: "G-9YDKS70ZE7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const players = ["Julia", "Molly", "Juli", "è±ªå“¥", "Don", "Gimme", "å‰å¿—", "Erick", "Jason", "KRIS"];
        const horseData = [
            { id: 0, name: "è¡é‹’é¦¬", emoji: "ğŸ", desc: "ç©©å®šå‹ï¼Œä¸è¼•æ˜“æ”¾æ£„", spd: 5 },
            { id: 1, name: "é–ƒé›»é¦¬", emoji: "âš¡", desc: "èµ·æ­¥è¶…å¿«ï¼Œä½†å¾Œå‹å ªæ†‚", spd: 8 },
            { id: 2, name: "ç¨è§’ç¸", emoji: "ğŸ¦„", desc: "é­”æ³•åŠ æŒï¼Œéš¨æ©Ÿäº‹ä»¶å¤š", spd: 6 },
            { id: 3, name: "æ–‘é¦¬", emoji: "ğŸ¦“", desc: "æ“…é•·åœ¨é»‘ç™½éµä¸Šå¥”è·‘", spd: 5 },
            { id: 4, name: "è‰æ³¥é¦¬", emoji: "ğŸ¦™", desc: "è·‘å¾—ä¸å¿«ä½†æœƒå™´å£æ°´", spd: 4 },
            { id: 5, name: "æ´¾å°é¦¬", emoji: "ğŸ¥³", desc: "é‚Šè·‘é‚Šç©ï¼Œé«”åŠ›é©šäºº", spd: 5 },
            { id: 6, name: "æ—‹è½‰æœ¨é¦¬", emoji: "ğŸ ", desc: "é ­æšˆè…¦è„¹ï¼Œæ–¹å‘æ„Ÿæ¥µå·®", spd: 4 },
            { id: 7, name: "é‡‘é¦¬", emoji: "ğŸ–ï¸", desc: "å½±å¸ç´šè¡¨æ¼”ï¼Œæ¼”æŠ€ä¸€æµ", spd: 6 },
            { id: 8, name: "è³½åšé¦¬", emoji: "ğŸ¤–", desc: "ç¨‹å¼é©…å‹•ï¼Œè¨ˆç®—ç²¾æº–", spd: 7 },
            { id: 9, name: "é»‘é¦¬", emoji: "ğŸ", desc: "æ½›åŠ›è‚¡ï¼Œæœ€å¾Œé—œé ­çˆ†ç™¼", spd: 6 }
        ];
        const prizes = ["$2500 ç¾é‡‘", "æ–°å…‰1000", "500ç¦®å·", "400ç¦®å·", "300ç¦®å·", "200ç¦®å·", "100ç¦®å·", "æ„Ÿè¬åƒèˆ‡", "æ„Ÿè¬åƒèˆ‡", "æ„Ÿè¬åƒèˆ‡"];

        let myName = "";
        let isRacing = false;

        function init() {
            if(window.location.hash === '#admin') document.getElementById('admin-panel').classList.remove('hidden');

            db.ref('gameState').on('value', snapshot => {
                const state = snapshot.val() || { status: 'waiting', selections: {} };
                updatePlayerList(state.selections || {});
                updateHorseSelection(state.selections || {});
                updateAdminLists(state.selections || {});
                
                if(state.status === 'racing' && !isRacing) {
                    prepareRaceTrack(state.selections);
                    startRace(state.seed);
                }
                if(state.status === 'waiting') {
                    // é‡ç½®é‚è¼¯ç”±ç€è¦½å™¨é‡æ–°æ•´ç†é”æˆ
                }
            });
        }

        function updatePlayerList(selections) {
            const container = document.getElementById('user-list');
            container.innerHTML = "";
            const selectedNames = Object.keys(selections);

            players.forEach(p => {
                const isTaken = selectedNames.includes(p);
                const btn = document.createElement('button');
                btn.className = `p-4 rounded-2xl border-2 font-bold transition ${isTaken ? 'btn-disabled bg-gray-100 text-gray-400 border-gray-200' : 'bg-white border-indigo-200 text-indigo-700 hover:border-indigo-500'}`;
                btn.innerHTML = isTaken ? `${p}<br><span class="text-[10px]">å·²ç™»å…¥</span>` : p;
                btn.onclick = () => { if(!isTaken) selectUser(p); };
                container.appendChild(btn);
            });
        }

        function selectUser(name) {
            myName = name;
            document.getElementById('step-user').classList.add('hidden');
            document.getElementById('step-horse').classList.remove('hidden');
        }

        function updateHorseSelection(selections) {
            const container = document.getElementById('horse-selection');
            if(!container) return;
            container.innerHTML = "";
            
            const selectedHorseIds = Object.values(selections).map(s => s.horseId);

            horseData.forEach(h => {
                const owner = Object.keys(selections).find(k => selections[k].horseId === h.id);
                const isTaken = !!owner;
                const div = document.createElement('div');
                div.className = `p-4 border-2 rounded-2xl flex justify-between items-center transition ${isTaken ? 'bg-gray-50 border-gray-200 text-gray-400' : 'border-indigo-400 hover:bg-indigo-50 cursor-pointer'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">${h.emoji}</span>
                        <div>
                            <p class="font-bold">${h.name}</p>
                            <p class="text-[10px]">${h.desc}</p>
                        </div>
                    </div>
                    <div class="font-bold">${isTaken ? 'ğŸ‘¤ '+owner : 'å°šæœªé¸æ“‡'}</div>
                `;
                if(!isTaken) div.onclick = () => pickHorse(h.id);
                container.appendChild(div);
            });
        }

        function pickHorse(id) {
            db.ref(`gameState/selections/${myName}`).set({ horseId: id });
            document.getElementById('step-horse').classList.add('hidden');
            document.getElementById('step-race').classList.remove('hidden');
        }

        function updateAdminLists(selections) {
            const readyList = document.getElementById('admin-ready-list');
            const notReadyList = document.getElementById('admin-not-ready-list');
            if(!readyList) return;

            const selectedNames = Object.keys(selections);
            readyList.innerText = selectedNames.join(', ') || 'ç„¡';
            notReadyList.innerText = players.filter(p => !selectedNames.includes(p)).join(', ') || 'å…¨å“¡åˆ°é½Šï¼';
        }

        function prepareRaceTrack(selections) {
            document.getElementById('step-user').classList.add('hidden');
            document.getElementById('step-horse').classList.add('hidden');
            document.getElementById('step-race').classList.remove('hidden');
            
            const container = document.getElementById('track-container');
            container.innerHTML = '<div class="finish-line"></div>';
            
            Object.entries(selections).forEach(([name, data]) => {
                const horse = horseData[data.horseId];
                const track = document.createElement('div');
                track.className = "horse-track";
                track.innerHTML = `
                    <div id="runner-${data.horseId}" class="horse-emoji" style="left: 0%">
                        <span class="name-tag">${name}</span>
                        ${horse.emoji}
                        <div class="event-msg"></div>
                    </div>
                `;
                container.appendChild(track);
            });
        }

        function startRace(seed) {
            isRacing = true;
            document.getElementById('race-status').innerText = "ğŸ æ¯”è³½æ¿€çƒˆé€²è¡Œä¸­ï¼";
            document.getElementById('bgm').play();
            
            const runners = document.querySelectorAll('[id^="runner-"]');
            const rankings = [];
            const startTime = Date.now();

            const timer = setInterval(() => {
                runners.forEach(el => {
                    const id = el.id.replace('runner-', '');
                    let currentPos = parseFloat(el.style.left);
                    if(currentPos >= 88) return;

                    // é‚è¼¯æ•¸æ“š
                    let move = (Math.random() * 2) + (horseData[id].spd * 0.1);
                    
                    // éš¨æ©Ÿäº‹ä»¶
                    const eventRoll = Math.random();
                    if(eventRoll < 0.03) {
                        move = -5; // æ»‘å€’
                        triggerEvent(el, "ğŸŒ æ»‘å€’å€’é€€!");
                    } else if(eventRoll > 0.97) {
                        move = 10; // è¡åˆº
                        triggerEvent(el, "ğŸ”¥ æ¥µé€Ÿè¡åˆº!");
                    } else if(eventRoll > 0.49 && eventRoll < 0.51) {
                        move = -currentPos; // ç³»çµ± Bug 
                        triggerEvent(el, "ğŸ’» ç¨‹å¼ Bug å›åˆ°èµ·é»!");
                    }

                    let newPos = Math.max(0, currentPos + move);
                    el.style.left = newPos + "%";

                    if(newPos >= 88) {
                        const name = el.querySelector('.name-tag').innerText;
                        if(!rankings.find(r => r.name === name)) {
                            rankings.push(name);
                            if(rankings.length === runners.length) {
                                clearInterval(timer);
                                showRankings(rankings);
                            }
                        }
                    }
                });
            }, 300);
        }

        function triggerEvent(el, msg) {
            const msgContainer = el.querySelector('.event-msg');
            msgContainer.innerHTML = `<div class="event-popup">${msg}</div>`;
        }

        function showRankings(rankings) {
            document.getElementById('step-result').classList.remove('hidden');
            const list = document.getElementById('rank-list');
            list.innerHTML = "";
            rankings.forEach((name, i) => {
                const div = document.createElement('div');
                div.className = `flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border-l-4 ${i===0?'border-red-500':'border-indigo-400'}`;
                div.innerHTML = `
                    <span class="font-bold text-gray-500">No.${i+1}</span>
                    <span class="font-black text-lg">${name}</span>
                    <span class="text-indigo-600 font-bold">${prizes[i] || 'åƒåŠ ç'}</span>
                `;
                list.appendChild(div);
            });
            document.getElementById('race-status').innerText = "ğŸ æ¯”è³½çµæŸï¼æ­å–œå¾—çè€…";
        }

        // Admin Buttons
        function startGame() { db.ref('gameState').update({ status: 'racing', seed: Math.random() }); }
        function resetGame() { db.ref('gameState').set({ status: 'waiting', selections: {} }).then(() => location.reload()); }

        init();
    </script>
</body>
</html>
