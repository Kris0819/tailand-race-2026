<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT è³½é¦¬ - æœ€çµ‚åˆºæ¿€åŒæ­¥ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #d32f2f; --gold: #ffd700; --track-bg: #1a1a1a; --success: #4caf50; --danger: #ff5252; --card-bg: #252525; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'PingFang TC', sans-serif; background: #0f0f0f; color: white; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #admin-panel { background: rgba(211, 47, 47, 0.9); padding: 8px; display: none; border-bottom: 2px solid var(--gold); z-index: 1000; }
        header { padding: 12px; text-align: center; background: #222; }
        h2 { margin: 0; color: var(--gold); font-size: 1.1rem; letter-spacing: 2px; }
        .container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        #user-login, #setup { width: 100%; max-width: 400px; display: none; }
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 20px; }
        .name-btn { height: 55px; background: #333; border: 1px solid #555; color: white; border-radius: 12px; font-weight: bold; }
        .name-btn.taken { opacity: 0.15; pointer-events: none; }
        .identity-bar { display: flex; align-items: center; justify-content: space-between; width: 100%; max-width: 400px; background: #222; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; display: none; }
        .horse-slot { background: var(--card-bg); border-radius: 12px; padding: 15px; border: 2px solid #333; display: flex; align-items: center; gap: 15px; margin-bottom: 12px; width: 100%; }
        .horse-slot.occupied { opacity: 0.3; filter: grayscale(1); pointer-events: none; }
        .horse-slot.my-pick { border-color: var(--success); background: #1b2e1c; }
        .stat-bar { flex: 1; height: 5px; background: #444; border-radius: 3px; overflow: hidden; margin-top: 4px; }
        .stat-fill { height: 100%; background: var(--gold); }
        .track-container { width: 100vw; flex: 1; background: var(--track-bg); display: none; position: relative; overflow: hidden; padding-top: 50px; }
        .lane { position: relative; height: 80px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .horse-container { position: absolute; left: 0%; transition: left 0.15s linear; display: flex; flex-direction: column; align-items: center; width: 90px; }
        .horse-icon { font-size: 35px; transform: scaleX(-1); transition: transform 0.2s; }
        .is-racing .horse-icon { animation: gallop 0.4s infinite ease-in-out; }
        @keyframes gallop { 0%, 100% { transform: scaleX(-1) translateY(0); } 50% { transform: scaleX(-1) translateY(-6px); } }
        .stalled .horse-icon { transform: scaleX(-1) rotate(90deg) !important; animation: none !important; opacity: 0.7; }
        .status-bubble { position: absolute; top: -38px; left: 50%; transform: translateX(-50%); font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold; white-space: nowrap; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .finish-emoji { position: absolute; top: -25px; font-size: 24px; display: none; }
        #start-btn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 15px 50px; font-size: 18px; background: var(--primary); color: white; border: none; border-radius: 30px; font-weight: bold; z-index: 500; display: none; }
        #leaderboard { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
    </style>
</head>
<body>

    <div id="admin-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; max-width:600px; margin:0 auto;">
            <div style="font-size:12px;">æº–å‚™ä¸­: <span id="ready-count">0</span></div>
            <button onclick="hardReset()" style="background:white; color:red; border:none; padding:4px 10px; border-radius:5px; font-size:11px;">é‡ç½®éŠæˆ²</button>
        </div>
    </div>

    <header><h2>ğŸ 2026 AIOT è³½é¦¬ - æ¥µé€Ÿå·”å³°</h2></header>

    <div class="container">
        <div id="user-login">
            <h3 style="text-align:center; color: var(--gold);">èº«åˆ†é©—è­‰</h3>
            <div class="name-grid" id="name-grid"></div>
        </div>
        <div id="identity-area" class="identity-bar">
            <span id="user-badge" style="font-weight:bold; color:var(--success);"></span>
            <button onclick="logout()" style="background:transparent; border:1px solid #666; color:#aaa; font-size:11px; padding:3px 8px; border-radius:5px;">æ›´æ›</button>
        </div>
        <div id="setup">
            <h3 style="text-align: center;">è«‹é¸æ“‡æˆ°é¦¬</h3>
            <div id="select-grid"></div>
        </div>
    </div>

    <button id="start-btn">ğŸ çœ¾é¦¬å¥”é¨°ï¼Œé–‹è³½ï¼</button>
    <div class="track-container" id="track">
        <div style="position:absolute; right:12%; top:0; bottom:0; width:15px; background:repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); border-left:2px solid gold;"></div>
        <div id="lanes-box"></div>
    </div>

    <div id="leaderboard">
        <div style="background:white; color:#111; border-radius:20px; padding:20px; width:100%; max-width:380px;">
            <h2 style="text-align:center; color: var(--primary); margin:0 0 15px 0;">ğŸ æœ€çµ‚æ’å</h2>
            <div id="leaderboard-list"></div>
            <button onclick="hardReset()" style="width:100%; padding:15px; margin-top:20px; background: #1a1a1a; color: white; border: none; border-radius: 12px; font-weight: bold;">è¿”å›å¤§å»³</button>
        </div>
    </div>

    <audio id="bgm" loop src="https://vgmsite.com/soundtracks/f-zero-x-nintendo-64/itvswlyq/03%20-%20Drivin%27%20Through%20on%20Max.mp3"></audio>
    <audio id="snd-start" src="https://www.soundjay.com/misc/sounds/starting-pistol-1.mp3"></audio>
    <audio id="snd-win" src="https://www.soundjay.com/human/sounds/applause-01.mp3"></audio>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95}, desc: "æ‘¸é­šçœé«”åŠ›ï¼Œæ¥µåº¦ç©©å®šã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65}, desc: "æœ€å¾Œä¸€æ®µè·¯é€Ÿåº¦åŠ å€ã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25}, desc: "èµ·æ­¥ç‹è€…ï¼Œæ¥µæ˜“å€’åœ°ã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60}, desc: "å…¨èƒ½å‹é¸æ‰‹ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45}, desc: "é€Ÿåº¦èµ·ä¼åŠ‡çƒˆã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85}, desc: "å…ç–«æ»‘å€’äº‹ä»¶ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90}, desc: "è€åŠ›é©šäººã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70}, desc: "æœ€å¾Œé—œé ­æœ‰æ©Ÿç‡é–ƒç¾ã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50}, desc: "é«˜ç”¢å‡ºä»£è¡¨ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75}, desc: "ç©©ç´®ç©©æ‰“ã€‚" }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
    let raceStarted = false;

    function init() {
        const savedName = localStorage.getItem('aiot_race_name');
        if (isAdmin) { document.getElementById('start-btn').style.display = 'block'; document.getElementById('admin-panel').style.display = 'block'; }
        
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn'; btn.id = `name-${n}`; btn.innerText = n;
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        const selectGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot'; div.id = `slot-${i}`;
            div.innerHTML = `<div style="font-size:28px; transform: scaleX(-1);">ğŸ</div>
                <div style="flex:1">
                    <div style="font-weight:bold; color:var(--gold); font-size:14px;">${h.trait}</div>
                    <div style="font-size:10px; color:#aaa; margin:2px 0;">${h.desc}</div>
                    <div style="display:flex; gap:10px; font-size:9px; color:#aaa;">
                        <div style="flex:1">æ•ˆç‡ <div class="stat-bar"><div class="stat-fill" style="width:${h.stats.spd}%"></div></div></div>
                        <div style="flex:1">é«”åŠ› <div class="stat-bar"><div class="stat-fill" style="width:${h.stats.sta}%"></div></div></div>
                    </div>
                </div>`;
            div.onclick = () => selectHorse(i);
            selectGrid.appendChild(div);
        });
        listenFirebase();
        if (savedName) login(savedName); else document.getElementById('user-login').style.display = 'block';
    }

    function listenFirebase() {
        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (state && state.status === 'racing' && !raceStarted) startRacingView(state.participants);
            if (state && state.status === 'finished') showLeaderboard(state.results);
        });
        db.ref('users').on('value', snap => {
            const users = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`name-${n}`);
                if (users[n]) btn.classList.add('taken'); else btn.classList.remove('taken');
            });
            if(isAdmin) document.getElementById('ready-count').innerText = Object.keys(users).length;
        });
        db.ref('assignments').on('value', snap => {
            const assignments = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`slot-${i}`); slot.classList.remove('occupied', 'my-pick');
                const owner = Object.keys(assignments).find(name => assignments[name] === i);
                if (owner) { if (owner === myName) slot.classList.add('my-pick'); else slot.classList.add('occupied'); }
            });
        });
        // æ ¸å¿ƒåŒæ­¥ï¼šæ¸²æŸ“æ‰€æœ‰æ‰‹æ©Ÿç•«é¢
        db.ref('raceLive').on('value', snap => {
            const liveData = snap.val();
            if (!liveData || !raceStarted) return;
            Object.keys(liveData).forEach(horseId => {
                const data = liveData[horseId];
                const el = document.getElementById(`horse-${horseId}`);
                if (el) {
                    el.style.left = data.pos + '%';
                    document.getElementById(`live-sta-${horseId}`).style.width = data.sta + "%";
                    const bubble = document.getElementById(`status-${horseId}`);
                    if (data.msg) { bubble.innerText = data.msg; bubble.style.display = 'block'; bubble.style.background = data.msgColor; }
                    else bubble.style.display = 'none';
                    if (data.stalled) el.classList.add('stalled'); else el.classList.remove('stalled');
                    if (data.rankEmoji) {
                        document.getElementById(`emoji-${horseId}`).innerText = data.rankEmoji;
                        document.getElementById(`emoji-${horseId}`).style.display = 'block';
                        el.classList.remove('is-racing');
                    }
                }
            });
        });
    }

    function login(n) { myName = n; localStorage.setItem('aiot_race_name', n); db.ref(`users/${n}`).set(true); }
    function logout() { if (confirm("æ›´æ›èº«ä»½ï¼Ÿ")) { db.ref(`users/${myName}`).remove(); db.ref(`assignments/${myName}`).remove(); localStorage.removeItem('aiot_race_name'); location.reload(); } }
    function hardReset() { if (confirm("é‡ç½®éŠæˆ²ï¼Ÿ")) { db.ref().set(null); location.reload(); } }
    function selectHorse(idx) { if (myName) db.ref(`assignments/${myName}`).set(idx); }

    document.getElementById('start-btn').onclick = function() {
        db.ref('assignments').once('value', snap => {
            const p = snap.val() || {};
            if (Object.keys(p).length < 1) return alert("æ²’äººé¸é¦¬ï¼");
            db.ref('gameState').set({ status: 'racing', participants: p });
            runAdminEngine(p);
        });
    };

    function startRacingView(participants) {
        raceStarted = true;
        document.getElementById('setup').style.display = 'none';
        document.getElementById('identity-area').style.display = 'none';
        document.getElementById('track').style.display = 'block';
        document.getElementById('bgm').play().catch(()=>{});
        document.getElementById('snd-start').play();
        const lanesBox = document.getElementById('lanes-box'); lanesBox.innerHTML = "";
        Object.keys(participants).forEach((name, idx) => {
            const horseId = participants[name];
            const color = ["#FF5252","#FFD700","#E040FB","#00E676","#2979FF","#FF9100","#40C4FF","#FF1744","#F4FF81","#B2FF59"][idx%10];
            const lane = document.createElement('div'); lane.className = 'lane';
            lane.innerHTML = `<div class="horse-container is-racing" id="horse-${horseId}">
                <div class="finish-emoji" id="emoji-${horseId}"></div>
                <div class="status-bubble" id="status-${horseId}" style="display:none;"></div>
                <div style="font-size:10px; font-weight:bold; background:rgba(0,0,0,0.6); padding:1px 4px; border-radius:3px;">${name}</div>
                <div class="horse-icon" style="color:${color}">ğŸ</div>
                <div style="width:40px; height:4px; background:#222; border-radius:2px; overflow:hidden;"><div id="live-sta-${horseId}" style="height:100%; background:var(--success); width:100%;"></div></div>
            </div>`;
            lanesBox.appendChild(lane);
        });
    }

    // --- ç®¡ç†è€…è¨ˆç®—å¼•æ“ (Admin Only) ---
    function runAdminEngine(participants) {
        if (!isAdmin) return;
        let horses = Object.keys(participants).map(name => ({
            id: participants[name], owner: name, pos: 0, speed: 0, sta: 100, stalled: false, finished: false,
            stats: horseLibrary[participants[name]].stats, msg: "", msgColor: "", rankEmoji: "", eventCooldown: 0
        }));
        let finishedCount = 0;
        const results = [];
        const emojiMap = {1:"ğŸ¥³", 2:"ğŸ¤©", 3:"ğŸ˜", 4:"ğŸ™‚", 5:"ğŸ˜", 6:"ğŸ™", 7:"ğŸ˜¢", 8:"ğŸ˜°", 9:"ğŸ˜¨", 10:"ğŸ˜­"};

        const interval = setInterval(() => {
            const liveUpdate = {};
            horses.forEach(h => {
                if (h.finished) return;
                
                if (!h.stalled) {
                    // äº‹ä»¶åˆ¤å®š
                    if (h.eventCooldown > 0) h.eventCooldown -= 100;
                    
                    if (h.eventCooldown <= 0) {
                        const r = Math.random();
                        if (r < 0.12 && h.id !== 5) { // æ»‘å€’æ©Ÿç‡
                            h.pos = Math.max(0, h.pos - 60);
                            h.speed = 0; h.msg = "â›¸ï¸ æ»‘å€’!!"; h.msgColor = "#546e7a";
                            h.eventCooldown = 2000;
                            setTimeout(() => { if(h.msg === "â›¸ï¸ æ»‘å€’!!") h.msg = ""; }, 1500);
                        } else if (r < 0.25) { // è¡åˆºæ©Ÿç‡
                            h.speed += 8; h.msg = "âš¡ è¡åˆº!"; h.msgColor = "orange";
                            h.eventCooldown = 2500;
                            setTimeout(() => { if(h.msg === "âš¡ è¡åˆº!") h.msg = ""; }, 1500);
                        }
                    }

                    // é«”åŠ›æ¶ˆè€— (åŠ é€Ÿä¸­æ‰£æ›´å¤š)
                    let staLoss = (h.speed * 0.05 + 0.12);
                    if (h.msg === "âš¡ è¡åˆº!") staLoss *= 1.8;
                    h.sta = Math.max(0, h.sta - staLoss);

                    if (h.sta <= 0) {
                        h.stalled = true; h.speed = 0; h.msg = "ğŸ¤® çˆ†è‚ï¼"; h.msgColor = "red";
                        setTimeout(() => { 
                            let cd = 5; 
                            const timer = setInterval(() => {
                                h.msg = `ğŸ’¤ Zzz... ${cd}s`; h.msgColor = "gray"; cd--;
                                if (cd < 0) { clearInterval(timer); h.stalled = false; h.sta = 100; h.msg = ""; }
                            }, 1000);
                        }, 1000);
                    } else {
                        let acc = Math.random() * 0.4 + (h.stats.spd * 0.005);
                        if (h.id === 1 && h.pos > 750) acc += 1.5; // ä¸‹ç­æˆ°ç¥
                        h.speed = (h.speed * 0.88) + acc;
                    }
                }
                
                h.pos += h.speed * 0.4;
                if (h.pos >= 1000) {
                    h.pos = 1000; h.finished = true; finishedCount++;
                    h.rankEmoji = emojiMap[finishedCount] || "ğŸ˜­";
                    results.push({ name: h.owner, horseId: h.id });
                }
                liveUpdate[h.id] = { pos: Math.min((h.pos/1000)*85, 88), sta: h.sta, msg: h.msg, msgColor: h.msgColor, stalled: h.stalled, rankEmoji: h.rankEmoji };
            });
            db.ref('raceLive').set(liveUpdate);
            if (finishedCount === horses.length) {
                clearInterval(interval);
                db.ref('gameState').update({ status: 'finished', results: results });
            }
        }, 100);
    }

    function showLeaderboard(results) {
        document.getElementById('leaderboard').style.display = 'flex';
        document.getElementById('snd-win').play();
        const listEl = document.getElementById('leaderboard-list'); listEl.innerHTML = "";
        const prizes = {1:"$2500 ç¾é‡‘", 2:"$1000 ç¦®åˆ¸", 3:"$1000 ç¦®åˆ¸", 4:"$1000 ç¦®åˆ¸", 5:"$1000 ç¦®åˆ¸", 6:"$500", 7:"$400", 8:"$300", 9:"$200", 10:"$100"};
        results.forEach((res, i) => {
            const div = document.createElement('div');
            div.style.cssText = `padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; ${i===0?'background:#fffde7; font-weight:bold;':''}`;
            div.innerHTML = `<span>${i+1}. ${res.name}</span><span style="color:var(--primary)">${prizes[i+1] || "$100"}</span>`;
            listEl.appendChild(div);
        });
    }
    init();
</script>
</body>
</html>
