<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - ç‹€æ…‹ä¿®æ­£ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --primary: #d32f2f; --gold: #ffd700; --track-bg: #1a1a1a; 
            --success: #4caf50; --warning: #ffeb3b; --danger: #ff5252; 
            --sprint: #ff5722;
        }

        body { 
            font-family: 'PingFang TC', sans-serif; background: #000; color: white; 
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
        }

        /* é é¢åˆ‡æ›ç³»çµ± */
        .page { display: none; height: 100vh; width: 100vw; overflow: hidden; position: absolute; top: 0; left: 0; }
        .page.active { display: flex; flex-direction: column; }

        /* é ‚éƒ¨å°èˆªæ¬„ */
        .header-bar {
            background: #222; padding: 10px 15px; display: flex; 
            justify-content: space-between; align-items: center; border-bottom: 2px solid #333;
            z-index: 100;
        }
        .user-tag { color: var(--gold); font-weight: bold; font-size: 14px; }
        .back-btn { background: #444; color: #fff; border: none; padding: 5px 12px; border-radius: 5px; font-size: 12px; }

        /* é¸äººç•«é¢ */
        #user-login { background: #121212; align-items: center; justify-content: center; }
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 85%; max-width: 400px; }
        .name-btn { padding: 18px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 12px; font-weight: bold; }
        .name-btn.taken { opacity: 0.2; pointer-events: none; }

        /* é¸é¦¬ç•«é¢ */
        #setup { background: #111; padding: 15px; overflow-y: auto; box-sizing: border-box; }
        .horse-slot { background: #222; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 2px solid #333; position: relative; }
        .horse-slot.my-pick { border-color: var(--success); background: #1a2e1a; }
        .horse-slot.occupied { opacity: 0.4; filter: grayscale(1); }
        
        /* è¦–è¦ºåŒ–å±¬æ€§æ¢ */
        .stat-row { display: flex; align-items: center; margin-bottom: 5px; font-size: 11px; }
        .stat-label { width: 35px; color: #888; }
        .stat-outer { flex-grow: 1; height: 6px; background: #000; border-radius: 3px; overflow: hidden; }
        .stat-inner { height: 100%; background: linear-gradient(90deg, #444, var(--gold)); }

        /* è³½é“ */
        #track { background: #000; }
        #lanes-box { flex-grow: 1; position: relative; width: 100%; }
        .lane { position: relative; border-bottom: 1px solid #222; width: 100%; }
        .horse-container { position: absolute; left: 0; display: flex; align-items: center; width: 120px; transition: left 0.1s linear; }
        .horse-icon { font-size: 32px; transform: scaleX(-1); }
        .stamina-track { width: 45px; height: 5px; background: #000; border-radius: 3px; margin-top: 2px; }
        .stamina-fill { height: 100%; background: var(--success); }
        .finish-line { position: absolute; right: 60px; top: 0; bottom: 0; width: 15px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); border-left: 2px solid var(--gold); }

        /* ç‹€æ…‹æ°£æ³¡ */
        .status-bubble { 
            position: absolute; top: -35px; left: 0; font-size: 11px; padding: 3px 10px; 
            border-radius: 10px; white-space: nowrap; font-weight: bold; border: 1px solid #fff;
            display: none; z-index: 10;
        }

        /* æ’è¡Œæ¦œ */
        #leaderboard { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .lb-box { background: white; color: #111; width: 85%; border-radius: 20px; padding: 25px; }

        /* ç®¡ç†å“¡æ§åˆ¶ */
        .admin-bar { position: fixed; bottom: 20px; left: 0; right: 0; display: none; justify-content: center; gap: 10px; z-index: 3000; }
        .btn-main { padding: 12px 25px; border-radius: 30px; border: none; font-weight: bold; color: white; cursor: pointer; }
    </style>
</head>
<body>

<div class="header-bar" id="header" style="display:none;">
    <div class="user-tag">ğŸ’¼ è§’è‰²ï¼š<span id="my-name-display">å°šæœªç™»å…¥</span></div>
    <button class="back-btn" onclick="logout()">åˆ‡æ›è§’è‰²</button>
</div>

<div id="user-login" class="page active">
    <h2 style="color:var(--gold); letter-spacing: 2px;">2026 AIOT å°¾ç‰™è³½é¦¬</h2>
    <p style="color: #666; margin-bottom: 20px;">è«‹é»æ“Šå§“åç™»å…¥</p>
    <div class="name-grid" id="name-grid"></div>
</div>

<div id="setup" class="page">
    <h3 style="text-align:center; color: var(--gold); margin: 20px 0;">ğŸ æŒ‘é¸æ‚¨çš„æˆ°é¦¬</h3>
    <div id="select-grid"></div>
</div>

<div id="track" class="page">
    <div id="lanes-box">
        <div class="finish-line"></div>
        <div id="lanes-render-area" style="height:100%; width:100%;"></div>
    </div>
</div>

<div id="leaderboard">
    <div class="lb-box">
        <h2 style="text-align:center; color: var(--primary);">ğŸ† æ±ºè³½æˆç¸¾ ğŸ†</h2>
        <div id="leaderboard-list"></div>
        <div id="admin-controls" style="display:none; margin-top: 20px;">
            <button onclick="adminReset()" style="width:100%; padding:15px; background: #333; color: white; border-radius: 10px; font-weight: bold;">å¼·åˆ¶é‡å•Ÿæ–°å±€ (æ‰€æœ‰äººé‡ç™»)</button>
        </div>
        <p id="wait-msg" style="text-align:center; color:#888; font-size: 12px; margin-top: 15px;">ç­‰å¾…ç®¡ç†è€…é‡ç½®éŠæˆ²...</p>
    </div>
</div>

<div id="admin-panel" class="admin-bar">
    <button class="btn-main" style="background:var(--success)" onclick="adminStart()">ğŸ é–‹å§‹æ¯”è³½</button>
    <button class="btn-main" style="background:var(--primary)" onclick="adminReset()">ğŸ”„ å¼·åˆ¶é‡ç½®</button>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, burst: 40, lck: 70}, desc: "é«”åŠ›æ·±ä¸å¯æ¸¬ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65, burst: 95, lck: 60}, desc: "ä¸‹ç­ç¬é–“é–‹å•Ÿè¶…é »ã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, burst: 80, lck: 30}, desc: "èµ·æ­¥å³å·”å³°ï¼Œä½†æ˜“ç´¯ã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60, burst: 60, lck: 80}, desc: "èªé€Ÿæ¥µå¿«ï¼Œç©©å®šå‰é€²ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, burst: 75, lck: 50}, desc: "ä¾è³´èˆˆå¥®åŠ‘æé€Ÿã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, burst: 30, lck: 99}, desc: "å¹¸é‹å€¼æ»¿åˆ†ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, burst: 50, lck: 60}, desc: "é»˜é»˜è¶…è»Šã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70, burst: 99, lck: 40}, desc: "æœ€å¾Œä¸€ç§’æœƒçˆ†ç‚¸æ€§åŠ é€Ÿã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50, burst: 70, lck: 60}, desc: "æ°£å‹¢é©…å‹•å››è‚¢ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, burst: 65, lck: 70}, desc: "æœ€å¹³è¡¡çš„é¸æ“‡ã€‚" }
    ];

    const names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = localStorage.getItem('race_user') || "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
    let serverOffset = 0;
    let currentGameStatus = "idle";

    db.ref(".info/serverTimeOffset").on("value", s => serverOffset = s.val());

    function init() {
        if (isAdmin) {
            document.getElementById('admin-panel').style.display = 'flex';
            document.getElementById('admin-controls').style.display = 'block';
            document.getElementById('wait-msg').style.display = 'none';
        }

        // æ¸²æŸ“åå­—æŒ‰éˆ•
        const nGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const b = document.createElement('button');
            b.className = 'name-btn';
            b.id = `btn-${n}`;
            b.innerText = n;
            b.onclick = () => login(n);
            nGrid.appendChild(b);
        });

        // æ¸²æŸ“é¸é¦¬æŒ‰éˆ•
        const sGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const d = document.createElement('div');
            d.className = 'horse-slot';
            d.id = `slot-${i}`;
            d.innerHTML = `
                <div style="display:flex; justify-content:space-between;"><b>${h.trait}</b><span>#${i+1}</span></div>
                <div class="stat-row" style="margin-top:10px;"><span class="stat-label">é€Ÿåº¦</span><div class="stat-outer"><div class="stat-inner" style="width:${h.stats.spd}%"></div></div></div>
                <div class="stat-row"><span class="stat-label">é«”åŠ›</span><div class="stat-outer"><div class="stat-inner" style="width:${h.stats.sta}%"></div></div></div>
                <p style="font-size:11px; color:#aaa; margin:5px 0 0;">${h.desc}</p>
            `;
            d.onclick = () => selectHorse(i);
            sGrid.appendChild(d);
        });

        listenFirebase();
    }

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
    }

    function login(name) {
        myName = name;
        localStorage.setItem('race_user', name);
        db.ref(`users/${name}`).set(true);
    }

    function logout() {
        if(myName) {
            db.ref(`users/${myName}`).remove();
            db.ref(`assignments/${myName}`).remove();
        }
        localStorage.removeItem('race_user');
        myName = "";
        location.reload();
    }

    function selectHorse(idx) {
        if (!myName) return;
        db.ref(`assignments/${myName}`).set(idx);
    }

    function listenFirebase() {
        // ç›£è½ç”¨æˆ¶ç™»å…¥ç‹€æ…‹
        db.ref('users').on('value', snap => {
            const u = snap.val() || {};
            names.forEach(n => {
                const b = document.getElementById(`btn-${n}`);
                if(b) u[n] ? b.classList.add('taken') : b.classList.remove('taken');
            });
            refreshUI(u);
        });

        // ç›£è½é¸é¦¬ç‹€æ…‹
        db.ref('assignments').on('value', snap => {
            const a = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const s = document.getElementById(`slot-${i}`);
                if(!s) return;
                const owner = Object.keys(a).find(k => a[k] === i);
                s.className = 'horse-slot';
                if (owner === myName) s.classList.add('my-pick');
                else if (owner) s.classList.add('occupied');
            });
        });

        // ç›£è½éŠæˆ²ç‹€æ…‹
        db.ref('gameState').on('value', snap => {
            const s = snap.val();
            if (!s) return;
            currentGameStatus = s.status;
            if (s.status === 'racing') {
                runSyncRace(s);
            } else if (s.status === 'idle') {
                // å¦‚æœç›®å‰åœ¨æ¯”è³½æˆ–æ’è¡Œæ¦œï¼Œå¼·åˆ¶é‡æ•´
                if (document.getElementById('track').classList.contains('active') || 
                    document.getElementById('leaderboard').style.display === 'flex') {
                    location.reload();
                }
            }
        });
    }

    // æ ¸å¿ƒ UI åˆ·æ–°é‚è¼¯ï¼šæ±ºå®šç¾åœ¨è©²é¡¯ç¤ºå“ªä¸€å€‹ Page
    function refreshUI(users) {
        if (currentGameStatus === 'racing') return; // æ¯”è³½ä¸­äº¤çµ¦ Racing é‚è¼¯

        if (myName && users[myName]) {
            // å·²ç™»å…¥ -> é¡¯ç¤ºé¸é¦¬é 
            showPage('setup');
            document.getElementById('header').style.display = 'flex';
            document.getElementById('my-name-display').innerText = myName;
        } else {
            // æœªç™»å…¥ -> é¡¯ç¤ºç™»å…¥é 
            showPage('user-login');
            document.getElementById('header').style.display = 'none';
        }
    }

    // ç®¡ç†å“¡åŠŸèƒ½
    function adminStart() {
        db.ref('assignments').once('value', snap => {
            const a = snap.val();
            if(!a) return alert("æ²’äººé¸é¦¬ï¼");
            const raceData = {};
            Object.entries(a).forEach(([name, hIdx]) => {
                const h = horseLibrary[hIdx];
                const baseTime = 30 - (h.stats.spd / 15) + (Math.random() * 4);
                raceData[name] = {
                    hIdx, totalTime: baseTime, stamina: h.stats.sta,
                    events: [{ t: 8 + Math.random()*5, type: Math.random()>0.7?'slip':'burst' }]
                };
            });
            db.ref('gameState').set({
                status: 'racing',
                startTime: Date.now() + serverOffset + 3000,
                raceData: raceData
            });
        });
    }

    function adminReset() {
        if(confirm("ç¢ºå®šé‡ç½®å…¨å ´ï¼Ÿæ‰€æœ‰äººå°‡è¢«å¼·åˆ¶é‡ç™»ã€‚")) {
            db.ref().set({ gameState: { status: 'idle' } });
        }
    }

    // æ¯”è³½æ¸²æŸ“å¼•æ“
    function runSyncRace(state) {
        showPage('track');
        document.getElementById('header').style.display = 'none';
        const renderArea = document.getElementById('lanes-render-area');
        renderArea.innerHTML = "";
        const players = Object.entries(state.raceData);
        const laneH = 100 / Math.max(players.length, 5);

        players.forEach(([name, data], idx) => {
            const div = document.createElement('div');
            div.className = 'lane';
            div.style.height = `${laneH}%`;
            div.innerHTML = `
                <div class="horse-container" id="horse-wrap-${idx}">
                    <div class="status-bubble" id="bubble-${idx}"></div>
                    <div class="horse-icon">ğŸ</div>
                    <div style="margin-left:5px;">
                        <div style="font-size:12px; font-weight:bold;">${name}</div>
                        <div class="stamina-track"><div class="stamina-fill" id="stam-fill-${idx}"></div></div>
                    </div>
                </div>
            `;
            renderArea.appendChild(div);
        });

        const finishLineX = renderArea.offsetWidth - 110;

        function frame() {
            const now = Date.now() + serverOffset;
            const elapsed = (now - state.startTime) / 1000;
            if (elapsed < 0) { requestAnimationFrame(frame); return; }

            let finished = 0;
            const rankings = [];

            players.forEach(([name, data], idx) => {
                const el = document.getElementById(`horse-wrap-${idx}`);
                const bub = document.getElementById(`bubble-${idx}`);
                const sFill = document.getElementById(`stam-fill-${idx}`);
                
                // é«”åŠ›æ¶ˆè€—
                const drain = 100 / (data.totalTime * 0.75);
                let curStam = Math.max(0, 100 - (elapsed * drain * (100/data.stamina)));
                sFill.style.width = curStam + "%";
                sFill.style.background = curStam < 20 ? 'var(--danger)' : 'var(--success)';

                // ç‹€æ…‹åˆ¤æ–·
                let speedMod = 1.0;
                bub.style.display = "none";
                if (curStam <= 0 && (Math.floor(elapsed)%4 < 2)) {
                    speedMod = 0.3; bub.innerText = "ğŸ¤® çˆ†è‚"; bub.style.display = "block"; bub.style.background = "var(--danger)";
                }
                data.events.forEach(ev => {
                    if (elapsed > ev.t && elapsed < ev.t + 2) {
                        if (ev.type==='slip') { speedMod=0.1; bub.innerText="â›¸ï¸ æ»‘å€’"; bub.style.display="block"; bub.style.background="#555"; }
                        else { speedMod=1.6; bub.innerText="âš¡ è¡åˆº"; bub.style.display="block"; bub.style.background="var(--sprint)"; }
                    }
                });

                let progress = Math.min(1, elapsed / data.totalTime);
                el.style.left = (progress * finishLineX) + "px";

                if (progress >= 1) { finished++; rankings.push({name, time: data.totalTime}); }
            });

            if (finished < players.length) requestAnimationFrame(frame);
            else showLeaderboard(rankings);
        }
        requestAnimationFrame(frame);
    }

    function showLeaderboard(res) {
        const sorted = res.sort((a,b) => a.time - b.time);
        document.getElementById('leaderboard').style.display = 'flex';
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = sorted.map((r, i) => `
            <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee; font-weight:bold;">
                <span>#${i+1} ${r.name}</span>
                <span style="color:var(--primary)">${getPrize(i+1)}</span>
            </div>
        `).join('');
    }

    function getPrize(r) {
        if (r === 1) return "$2500";
        if (r <= 5) return "$1000ç¦®åˆ¸";
        return {6:"$500", 7:"$400", 8:"$300", 9:"$200", 10:"$100"}[r] || "-";
    }

    init();
</script>
</body>
</html>
