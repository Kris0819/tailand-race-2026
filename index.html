<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - å®Œç¾åŒæ­¥è±ªè¯ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #d32f2f; --gold: #ffd700; --track-bg: #2c3e50; --success: #4caf50; --warning: #ffeb3b; --danger: #ff5252; --recover: #00bcd4; --sprint: #ff5722; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: #121212; color: white; margin: 0; padding: 10px; height: 100vh; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        
        /* ç®¡ç†è€…å·¥å…· */
        #admin-toolbar { position: fixed; top: 10px; right: 10px; display: none; gap: 10px; z-index: 9999; }
        .admin-btn { padding: 8px 15px; background: rgba(0,0,0,0.8); color: white; border: 1px solid var(--gold); border-radius: 5px; cursor: pointer; font-size: 12px; }

        /* 1. ç™»å…¥ç•«é¢ */
        #user-login { background: #1e1e1e; padding: 30px; border-radius: 20px; text-align: center; z-index: 200; position: fixed; top: 50%; transform: translateY(-50%); width: 90%; max-width: 500px; border: 2px solid var(--gold); }
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .name-btn { padding: 15px; background: #333; border: 1px solid #555; color: white; border-radius: 10px; cursor: pointer; font-size: 18px; font-weight: bold; }
        .name-btn:hover { background: var(--gold); color: black; }
        .name-btn.taken { opacity: 0.3; pointer-events: none; text-decoration: line-through; }
        
        /* 2. é¸é¦¬ç•«é¢ (æ¢å¾©è©³ç´°ç‰ˆ UI) */
        .setup-area { background: #1e1e1e; padding: 20px; border-radius: 20px; width: 95vw; max-width: 1200px; border: 1px solid #444; z-index: 100; overflow-y: auto; height: 85vh; display: none; flex-direction: column; }
        
        /* é ‚éƒ¨è³‡è¨Šåˆ— (å«è¿”å›æŒ‰éˆ•) */
        .user-info-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #2a2a2a; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid var(--gold); flex-shrink: 0; }
        .btn-reselect { background: #444; border: 1px solid #666; color: #ddd; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-reselect:hover { background: #666; color: white; }

        .horse-select-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-top: 5px; padding-bottom: 60px; }
        
        /* è©³ç´°ç‰ˆé¦¬åŒ¹å¡ç‰‡æ¨£å¼ */
        .horse-slot { background: linear-gradient(145deg, #252525, #1a1a1a); padding: 15px; border-radius: 12px; border: 2px solid #333; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .horse-slot:hover { border-color: var(--gold); transform: translateY(-3px); }
        .horse-slot.my-pick { border: 3px solid var(--success); box-shadow: 0 0 15px rgba(76, 175, 80, 0.3); }
        
        /* è¢«é¸èµ°çš„æ¨£å¼ */
        .horse-slot.occupied { border-color: #444; }
        .occupied-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; }
        .occupied-name { background: var(--primary); color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 10px black; border: 1px solid white; transform: rotate(-5deg); }

        .trait-tag { font-size: 10px; background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; position: absolute; top: 10px; right: 10px; }
        .stat-group { margin-top: 10px; }
        .stat-row { display: flex; align-items: center; margin-top: 5px; font-size: 11px; }
        .stat-label { width: 45px; color: #888; }
        .stat-bar { flex-grow: 1; height: 6px; background: #000; border-radius: 3px; overflow: hidden; border: 1px solid #333; }
        .stat-fill { height: 100%; background: linear-gradient(90deg, #444, var(--gold)); }
        .horse-desc { font-size: 11px; color: #aaa; margin-top: 10px; line-height: 1.4; font-style: italic; min-height: 32px; }

        /* è³½é“å€ */
        .track-container { position: relative; width: 98vw; flex-grow: 1; background: var(--track-bg); border: 4px solid #333; border-radius: 10px; display: none; margin-top: 20px; overflow: hidden; padding-top: 0; }
        .finish-line { position: absolute; right: 90px; top: 0; bottom: 0; width: 30px; background: repeating-linear-gradient(0deg, #fff, #fff 15px, #000 15px, #000 30px); border-left: 4px solid var(--gold); z-index: 1; }
        .lane { position: relative; height: auto; border-bottom: 1px dashed rgba(255,255,255,0.05); display: flex; align-items: center; }
        .horse-container { position: absolute; left: 10px; z-index: 10; display: flex; align-items: center; width: 100px; }
        .horse-icon { font-size: 32px; transform: scaleX(-1); margin-right: 5px; transition: transform 0.2s; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        .status-bubble { position: absolute; top: -30px; left: 0; font-size: 12px; padding: 4px 10px; border-radius: 12px; display: none; z-index: 100; font-weight: bold; color: white; border: 2px solid white; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        #start-btn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 18px 80px; font-size: 26px; background: linear-gradient(135deg, var(--primary), #8e0000); color: white; border: none; border-radius: 50px; cursor: pointer; display: none; font-weight: bold; z-index: 999; box-shadow: 0 0 20px var(--primary); }
        #leaderboard { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 450px; max-width: 90%; background: white; color: #111; border-radius: 20px; padding: 25px; z-index: 1000; display: none; border: 5px solid var(--gold); box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .prize-text { color: var(--primary); font-weight: bold; font-size: 14px; text-align: right; }
    </style>
</head>
<body>

    <div id="admin-toolbar">
        <button class="admin-btn" onclick="resetData()">é‡ç½®æ•´å€‹éŠæˆ²</button>
    </div>

    <div id="user-login">
        <h2 style="color: var(--gold); margin-bottom: 10px;">è«‹é¸æ“‡ä½ çš„åå­—</h2>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="setup" class="setup-area">
        <div class="user-info-bar">
            <span>ç•¶å‰èº«åˆ†ï¼š<b id="my-name-display" style="color:var(--gold); font-size:18px;"></b></span>
            <button class="btn-reselect" onclick="backToLogin()">â† é‡é¸äººç‰©</button>
        </div>
        <h3 style="margin:5px 0 15px 0; text-align: center; color: #ddd; font-size:16px;">è«‹æŒ‘é¸ä½ çš„æˆ°é¦¬ (å…±15åŒ¹)</h3>
        <div class="horse-select-grid" id="select-grid"></div>
    </div>

    <button id="start-btn" onclick="triggerStart()">ğŸ é–‹è³½ï¼</button>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%; display: flex; flex-direction: column;"></div>
    </div>

    <div id="leaderboard">
        <h2 style="text-align:center; color: var(--primary); margin: 0 0 20px 0; font-size: 28px;">ğŸ† FINAL RANK ğŸ†</h2>
        <div id="leaderboard-list"></div>
        <button onclick="location.reload()" style="width:100%; padding:15px; margin-top:20px; background: #1a1a1a; color: white; border-radius: 10px; cursor:pointer; font-weight: bold;">è¿”å›é¦–é </button>
    </div>

<script>
    // --- Firebase è¨­å®š ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- æ“´å……è‡³ 15 éš»é¦¬ï¼Œä¿ç•™è©³ç´°æ•¸å€¼ ---
    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, burst: 40, lck: 70}, desc: "æ“…é•·åœ¨ä¸»ç®¡è¦–ç·šå¤–ç·©æ­¥å‰é€²ï¼Œé«”åŠ›æ¢æ·±ä¸å¯æ¸¬ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65, burst: 95, lck: 60}, desc: "å¹³æ™‚ç¯€èƒ½æ¨¡å¼ï¼Œä¸€æ—¦å¤•é™½è¥¿ä¸‹ä¾¿é–‹å•Ÿè¶…é »æ¨¡å¼ã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, burst: 80, lck: 30}, desc: "èµ·æ­¥ç¬é–“å³å·”å³°ï¼Œä½†éœ€æ³¨æ„å¥åº·è­¦è¨Šã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60, burst: 60, lck: 80}, desc: "ç¯€å¥æ„Ÿæ¥µå¼·ï¼Œèƒ½ä»¥ç©©å®šçš„èªé€Ÿå£“åˆ¶å…¨å ´ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, burst: 75, lck: 50}, desc: "ä¾è³´èˆˆå¥®åŠ‘ï¼Œé€Ÿåº¦å–æ±ºæ–¼æ—©ä¸Šçš„æ‹¿éµæ¿ƒåº¦ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, burst: 30, lck: 99}, desc: "æ“æœ‰ç¥ç´šé–ƒé¿ï¼Œä»»ä½•éšœç¤™èˆ‡è²¬ä»»éƒ½ç¢°ä¸åˆ°ç‰ ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, burst: 50, lck: 60}, desc: "æ²’äººæ³¨æ„åˆ°ç‰ å·²æ‚„æ‚„è·‘åˆ°æœ€å‰é¢ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70, burst: 99, lck: 40}, desc: "åœ¨æœ€å¾Œä¸€ç§’å‰ï¼Œä½ æ°¸é ä¸çŸ¥é“ç‰ æœƒçˆ†ç™¼ä»€éº¼ã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50, burst: 70, lck: 60}, desc: "ç”¨æ°£å‹¢é©…å‹•å››è‚¢ï¼Œé€Ÿåº¦å¿«åˆ°è®“äººç„¡æ³•åé§ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, burst: 65, lck: 70}, desc: "ä¸æ±‚æœ€å¿«ï¼Œä½†çµ•å°æ´»å¾—æ¯”ä»»ä½•é¦¬éƒ½ä¹…ã€‚" },
        // æ–°å¢ 5 éš»
        { id: 10, trait: "AIè© å”±å¸«", stats: {spd: 65, sta: 65, burst: 85, lck: 80}, desc: "åªéœ€è¼¸å…¥å’’èªï¼Œä¾¿èƒ½æ†‘ç©ºç”Ÿæˆç§»å‹•è·é›¢ã€‚" },
        { id: 11, trait: "é€šéˆå¤§å¸«", stats: {spd: 50, sta: 80, burst: 40, lck: 100}, desc: "èƒ½æ„Ÿæ‡‰åˆ°å“ªè£¡æœ‰å‘ï¼Œé–‰è‘—çœ¼ç›ä¹Ÿèƒ½è·‘å®Œå…¨ç¨‹ã€‚" },
        { id: 12, trait: "Bugè£½é€ æ©Ÿ", stats: {spd: 90, sta: 30, burst: 90, lck: 20}, desc: "é€Ÿåº¦æ¥µå¿«ï¼Œä½†éš¨æ™‚å¯èƒ½å› ç‚ºä¸æ˜åŸå› åŸåœ°å´©æ½°ã€‚" },
        { id: 13, trait: "éµç›¤ä¿ ", stats: {spd: 85, sta: 55, burst: 70, lck: 40}, desc: "åœ¨ç¶²è·¯ä¸Šè·‘å¾—æ¯”èª°éƒ½å¿«ï¼Œç¾å¯¦ä¸­éœ€è¦ä¸€é»æ™‚é–“æš–æ©Ÿã€‚" },
        { id: 14, trait: "é›²ç«¯æ¼«æ­¥è€…", stats: {spd: 75, sta: 75, burst: 50, lck: 75}, desc: "é£„å¿½ä¸å®šï¼Œæ²’äººçŸ¥é“ç‰ çš„çœŸå¯¦ä½ç½®åœ¨å“ªè£¡ã€‚" }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = localStorage.getItem('my_race_name') || "";
    const urlParams = new URLSearchParams(window.location.search);
    const isAdmin = urlParams.get('admin') === '1';
    let raceStarted = false;

    function init() {
        if (isAdmin) {
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('admin-toolbar').style.display = 'flex';
        }
        
        // ç”Ÿæˆåå­—æŒ‰éˆ•
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn';
            btn.id = `name-${n}`;
            btn.innerText = n;
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        // ç”Ÿæˆé¦¬åŒ¹å¡ç‰‡ (è©³ç´°ç‰ˆ UI)
        const horseGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot';
            div.id = `slot-${i}`;
            div.innerHTML = `
                <div class="trait-tag">${h.trait}</div>
                <div style="font-size:32px; transform: scaleX(-1); text-align:center; margin: 10px 0;">ğŸ</div>
                <div class="stat-group">
                    <div class="stat-row"><span class="stat-label">é€Ÿåº¦</span><div class="stat-bar"><div class="stat-fill" style="width:${h.stats.spd}%"></div></div></div>
                    <div class="stat-row"><span class="stat-label">é«”åŠ›</span><div class="stat-bar"><div class="stat-fill" style="width:${h.stats.sta}%"></div></div></div>
                    <div class="stat-row"><span class="stat-label">çˆ†ç™¼</span><div class="stat-bar"><div class="stat-fill" style="width:${h.stats.burst}%"></div></div></div>
                    <div class="stat-row"><span class="stat-label">å¹¸é‹</span><div class="stat-bar"><div class="stat-fill" style="width:${h.stats.lck}%"></div></div></div>
                </div>
                <div class="horse-desc">${h.desc}</div>
            `;
            div.onclick = () => selectHorse(i);
            horseGrid.appendChild(div);
        });

        listenFirebase();
    }

    function login(n) {
        myName = n;
        localStorage.setItem('my_race_name', n);
        db.ref(`users/${n}`).set(true);
    }

    // é‡é¸åŠŸèƒ½ (åªåœ¨é¸é¦¬é æœ‰æ•ˆ)
    function backToLogin() {
        if (myName) {
            db.ref(`users/${myName}`).remove();
            db.ref(`assignments/${myName}`).remove();
        }
        myName = "";
        localStorage.removeItem('my_race_name');
        document.getElementById('setup').style.display = 'none';
        document.getElementById('user-login').style.display = 'block';
    }

    function selectHorse(idx) {
        if (!myName) return;
        db.ref(`assignments/${myName}`).set(idx);
    }

    function listenFirebase() {
        db.ref('users').on('value', (snap) => {
            const users = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`name-${n}`);
                if (users[n]) {
                    btn.classList.add('taken');
                    // å¦‚æœé€™æ˜¯æˆ‘é¸çš„åå­—ï¼Œé€²å…¥é¸é¦¬ç•«é¢
                    if (n === myName) {
                        btn.classList.add('me');
                        document.getElementById('user-login').style.display = 'none';
                        document.getElementById('setup').style.display = 'flex';
                        document.getElementById('my-name-display').innerText = myName;
                    }
                } else {
                    btn.classList.remove('taken', 'me');
                }
            });
        });

        db.ref('assignments').on('value', (snap) => {
            const assignments = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`slot-${i}`);
                slot.classList.remove('occupied', 'my-pick');
                const overlay = slot.querySelector('.occupied-overlay');
                if (overlay) overlay.remove();

                const owner = Object.keys(assignments).find(name => assignments[name] === i);
                if (owner) {
                    if (owner === myName) {
                        slot.classList.add('my-pick');
                    } else {
                        slot.classList.add('occupied');
                        // é¡¯ç¤ºæ˜¯èª°é¸äº†
                        const ov = document.createElement('div');
                        ov.className = 'occupied-overlay';
                        ov.innerHTML = `<div class="occupied-name">${owner}</div>`;
                        slot.appendChild(ov);
                    }
                }
            });
        });

        db.ref('gameState').on('value', (snap) => {
            const state = snap.val();
            if (state && state.status === 'racing' && !raceStarted) {
                startRaceEngine(state);
            } else if (!state && raceStarted) {
                location.reload();
            }
        });
    }

    function triggerStart() {
        db.ref('assignments').once('value', (snap) => {
            const participants = snap.val() || {};
            if (Object.keys(participants).length === 0) return alert("é‚„æ²’äººé¸é¦¬ï¼");
            db.ref('gameState').set({
                status: 'racing',
                seed: Math.random(),
                participants: participants,
                startTime: Date.now() + 2000
            });
        });
    }

    function resetData() {
        if(!confirm("ç¢ºå®šé‡ç½®æ•¸æ“šå—ï¼Ÿ")) return;
        db.ref().set(null);
        localStorage.clear();
        location.reload();
    }

    // --- æ ¸å¿ƒé‚è¼¯ï¼šVirtual Frames çµ•å°åŒæ­¥ + ç‹€æ…‹æ¨¡æ“¬ ---
    function startRaceEngine(state) {
        raceStarted = true;
        document.getElementById('setup').style.display = 'none';
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('user-login').style.display = 'none';
        document.getElementById('track').style.display = 'block';

        const lanesBox = document.getElementById('lanes-box');
        lanesBox.innerHTML = "";

        const participants = Object.keys(state.participants).map((name) => {
            const horseIdx = state.participants[name];
            return { name: name, horse: horseLibrary[horseIdx] };
        });

        const laneHeight = participants.length > 0 ? (100 / participants.length) : 100;

        participants.forEach((p, idx) => {
            const lane = document.createElement('div');
            lane.className = 'lane';
            lane.style.height = `${laneHeight}%`;
            lane.innerHTML = `
                <div class="horse-container" id="horse-${idx}">
                    <div class="status-bubble" id="bubble-${idx}"></div>
                    <div class="horse-icon" id="icon-${idx}">ğŸ</div>
                    <div class="horse-info-mini" style="font-size:10px; margin-left:5px;">
                        <div>${p.name}</div>
                    </div>
                </div>`;
            lanesBox.appendChild(lane);
        });

        const totalVirtualLength = 10000; 
        const frameTime = 50; 
        const screenTrackWidth = document.getElementById('track').offsetWidth - 130;
        const finishedList = [];

        const timer = setInterval(() => {
            const now = Date.now();
            const elapsed = now - state.startTime;
            if (elapsed < 0) return;

            const targetFrame = Math.floor(elapsed / frameTime);
            
            // å°æ¯åŒ¹é¦¬é€²è¡Œå¾é ­åˆ°å°¾çš„å¿«é€Ÿæ¨¡æ“¬ï¼Œè¿½è¶•åˆ° targetFrame
            participants.forEach((p, i) => {
                // å¦‚æœé€™åŒ¹é¦¬å·²ç¶“åˆ°äº†ï¼Œå°±ä¸ç®—äº†
                if (finishedList.find(x => x.name === p.name)) return;

                // åˆå§‹åŒ–é€™åŒ¹é¦¬çš„æ¨¡æ“¬ç‹€æ…‹
                let seedVal = state.seed + (i * 999);
                function syncRand() {
                    seedVal = (seedVal * 9301 + 49297) % 233280;
                    return seedVal / 233280;
                }

                let vPos = 0; 
                let vSpeed = 0; 
                let vStamina = 100;
                let isStalled = false; 
                let stallTimer = 0;
                let statusText = "";
                let statusColor = "";
                let finishTime = null;

                // æ¨¡æ“¬è¿´åœˆï¼šè·‘æ‰€æœ‰çš„ Frame
                for (let f = 0; f <= targetFrame; f++) {
                    if (vPos >= totalVirtualLength) {
                        finishTime = f; // ç´€éŒ„æ˜¯å“ªä¸€å¹€è·‘å®Œçš„
                        break; 
                    }

                    // --- åŸå§‹é‚è¼¯å¾©åˆ» ---
                    if (isStalled) {
                        stallTimer--;
                        if (stallTimer <= 0) { isStalled = false; statusText = ""; }
                    } else {
                        // æ‰£é«”åŠ›
                        let drainMult = p.horse.id === 2 ? 1.5 : 1.0; 
                        let staminaDrain = (vSpeed * 0.05 + 0.1) * drainMult;
                        vStamina -= staminaDrain;

                        // é«”åŠ›è€—ç›¡
                        if (vStamina <= 0) {
                            vSpeed = 0; isStalled = true; stallTimer = 50; vStamina = 100;
                            statusText = "ğŸ¤® çˆ†è‚ä¸­..."; statusColor = "var(--danger)";
                        }

                        // é€Ÿåº¦è¨ˆç®—
                        let accel = syncRand() * 0.4 + (p.horse.stats.spd * 0.005);
                        
                        // æˆªç¨¿è¡åˆº (ID 7)
                        if (f > 200 && p.horse.id === 7) { accel += 1.5; statusText = "ğŸ”¥ æ­»ç·šæš´è¡"; statusColor = "var(--sprint)"; }
                        
                        vSpeed = (vSpeed * 0.95) + accel;

                        // éš¨æ©Ÿäº‹ä»¶
                        let roll = syncRand();
                        // æ»‘å€’ (ID 5 ä¸æœƒæ»‘å€’)
                        if (f % 50 === 0 && roll < 0.02 && p.horse.id !== 5) {
                            vSpeed = 0; isStalled = true; stallTimer = 30;
                            statusText = "â›¸ï¸ æ»‘å€’äº†"; statusColor = "#546e7a";
                        }
                        // èººå¹³
                        if (f % 80 === 0 && roll > 0.96) {
                            vSpeed = 0; isStalled = true; stallTimer = 40; vStamina += 30;
                            statusText = "ğŸ›Œ èººå¹³..."; statusColor = "var(--recover)";
                        }
                    }
                    vPos += vSpeed;
                }

                // --- æ¸²æŸ“ç•«é¢ ---
                const el = document.getElementById(`horse-${i}`);
                const bubble = document.getElementById(`bubble-${i}`);
                const icon = document.getElementById(`icon-${i}`);

                if (vPos >= totalVirtualLength) {
                    // æŠµé”çµ‚é»
                    el.style.left = (screenTrackWidth + 40) + 'px';
                    // å³æ™‚æ…¶ç¥
                    if (icon.innerText !== "ğŸ‰") {
                        icon.innerText = "ğŸ‰";
                        icon.style.transform = "scale(1.5)";
                        bubble.style.display = 'none';
                    }
                    finishedList.push({ name: p.name, horse: p.horse, time: finishTime || targetFrame });
                } else {
                    // é‚„åœ¨è·‘
                    const screenX = (vPos / totalVirtualLength) * screenTrackWidth;
                    el.style.left = screenX + 'px';
                    
                    // é¡¯ç¤ºç‹€æ…‹æ°£æ³¡
                    if (statusText) {
                        bubble.style.display = 'block';
                        bubble.innerText = statusText;
                        bubble.style.background = statusColor;
                    } else {
                        bubble.style.display = 'none';
                    }
                }
            });

            if (finishedList.length === participants.length) {
                clearInterval(timer);
                setTimeout(() => showLeaderboard(finishedList), 1000);
            }

        }, frameTime);
    }

    function showLeaderboard(results) {
        // ä¾ç…§ finishTime æ’åº (è¶Šå°è¶Šå¿«)
        results.sort((a, b) => a.time - b.time);

        document.getElementById('leaderboard').style.display = 'block';
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = "";
        
        results.forEach((r, i) => {
            const rank = i + 1;
            const item = document.createElement('div');
            item.style.cssText = "padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; font-weight:bold; align-items:center;";
            
            let prizeInfo = "";
            let medal = `#${rank}`;

            // çé …å¾©åŸ
            if (rank === 1) {
                medal = "ğŸ¥‡ ç¬¬ä¸€å";
                prizeInfo = "$2500";
            } else if (rank >= 2 && rank <= 5) {
                medal = `ğŸ¥ˆ ç¬¬${rank}å`;
                prizeInfo = "æ–°å…‰ç¦®åˆ¸ $1000";
            } else {
                const prizes = {6: "$500", 7: "$400", 8: "$300", 9: "$200", 10: "$100"};
                medal = `ğŸ¥‰ ç¬¬${rank}å`;
                prizeInfo = prizes[rank] || "-";
            }

            item.innerHTML = `<div><span style="color:var(--primary); margin-right:5px;">${medal}</span><span>${r.name}</span></div><div class="prize-text">${prizeInfo}</div>`;
            list.appendChild(item);
        });
    }

    init();
</script>
</body>
</html><!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - å®Œç¾åŒæ­¥è±ªè¯ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #d32f2f; --gold: #ffd700; --track-bg: #2c3e50; --success: #4caf50; --warning: #ffeb3b; --danger: #ff5252; --recover: #00bcd4; --sprint: #ff5722; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: #121212; color: white; margin: 0; padding: 10px; height: 100vh; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        
        /* ç®¡ç†è€…å·¥å…· */
        #admin-toolbar { position: fixed; top: 10px; right: 10px; display: none; gap: 10px; z-index: 9999; }
        .admin-btn { padding: 8px 15px; background: rgba(0,0,0,0.8); color: white; border: 1px solid var(--gold); border-radius: 5px; cursor: pointer; font-size: 12px; }

        /* 1. ç™»å…¥ç•«é¢ */
        #user-login { background: #1e1e1e; padding: 30px; border-radius: 20px; text-align: center; z-index: 200; position: fixed; top: 50%; transform: translateY(-50%); width: 90%; max-width: 500px; border: 2px solid var(--gold); }
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .name-btn { padding: 15px; background: #333; border: 1px solid #555; color: white; border-radius: 10px; cursor: pointer; font-size: 18px; font-weight: bold; }
        .name-btn:hover { background: var(--gold); color: black; }
        .name-btn.taken { opacity: 0.3; pointer-events: none; text-decoration: line-through; }
        
        /* 2. é¸é¦¬ç•«é¢ (æ¢å¾©è©³ç´°ç‰ˆ UI) */
        .setup-area { background: #1e1e1e; padding: 20px; border-radius: 20px; width: 95vw; max-width: 1200px; border: 1px solid #444; z-index: 100; overflow-y: auto; height: 85vh; display: none; flex-direction: column; }
        
        /* é ‚éƒ¨è³‡è¨Šåˆ— (å«è¿”å›æŒ‰éˆ•) */
        .user-info-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #2a2a2a; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid var(--gold); flex-shrink: 0; }
        .btn-reselect { background: #444; border: 1px solid #666; color: #ddd; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-reselect:hover { background: #666; color: white; }

        .horse-select-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-top: 5px; padding-bottom: 60px; }
        
        /* è©³ç´°ç‰ˆé¦¬åŒ¹å¡ç‰‡æ¨£å¼ */
        .horse-slot { background: linear-gradient(145deg, #252525, #1a1a1a); padding: 15px; border-radius: 12px; border: 2px solid #333; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .horse-slot:hover { border-color: var(--gold); transform: translateY(-3px); }
        .horse-slot.my-pick { border: 3px solid var(--success); box-shadow: 0 0 15px rgba(76, 175, 80, 0.3); }
        
        /* è¢«é¸èµ°çš„æ¨£å¼ */
        .horse-slot.occupied { border-color: #444; }
        .occupied-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; }
        .occupied-name { background: var(--primary); color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 10px black; border: 1px solid white; transform: rotate(-5deg); }

        .trait-tag { font-size: 10px; background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; position: absolute; top: 10px; right: 10px; }
        .stat-group { margin-top: 10px; }
        .stat-row { display: flex; align-items: center; margin-top: 5px; font-size: 11px; }
        .stat-label { width: 45px; color: #888; }
        .stat-bar { flex-grow: 1; height: 6px; background: #000; border-radius: 3px; overflow: hidden; border: 1px solid #333; }
        .stat-fill { height: 100%; background: linear-gradient(90deg, #444, var(--gold)); }
        .horse-desc { font-size: 11px; color: #aaa; margin-top: 10px; line-height: 1.4; font-style: italic; min-height: 32px; }

        /* è³½é“å€ */
        .track-container { position: relative; width: 98vw; flex-grow: 1; background: var(--track-bg); border: 4px solid #333; border-radius: 10px; display: none; margin-top: 20px; overflow: hidden; padding-top: 0; }
        .finish-line { position: absolute; right: 90px; top: 0; bottom: 0; width: 30px; background: repeating-linear-gradient(0deg, #fff, #fff 15px, #000 15px, #000 30px); border-left: 4px solid var(--gold); z-index: 1; }
        .lane { position: relative; height: auto; border-bottom: 1px dashed rgba(255,255,255,0.05); display: flex; align-items: center; }
        .horse-container { position: absolute; left: 10px; z-index: 10; display: flex; align-items: center; width: 100px; }
        .horse-icon { font-size: 32px; transform: scaleX(-1); margin-right: 5px; transition: transform 0.2s; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        .status-bubble { position: absolute; top: -30px; left: 0; font-size: 12px; padding: 4px 10px; border-radius: 12px; display: none; z-index: 100; font-weight: bold; color: white; border: 2px solid white; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        #start-btn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 18px 80px; font-size: 26px; background: linear-gradient(135deg, var(--primary), #8e0000); color: white; border: none; border-radius: 50px; cursor: pointer; display: none; font-weight: bold; z-index: 999; box-shadow: 0 0 20px var(--primary); }
        #leaderboard { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 450px; max-width: 90%; background: white; color: #111; border-radius: 20px; padding: 25px; z-index: 1000; display: none; border: 5px solid var(--gold); box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .prize-text { color: var(--primary); font-weight: bold; font-size: 14px; text-align: right; }
    </style>
</head>
<body>

    <div id="admin-toolbar">
        <button class="admin-btn" onclick="resetData()">é‡ç½®æ•´å€‹éŠæˆ²</button>
    </div>

    <div id="user-login">
        <h2 style="color: var(--gold); margin-bottom: 10px;">è«‹é¸æ“‡ä½ çš„åå­—</h2>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="setup" class="setup-area">
        <div class="user-info-bar">
            <span>ç•¶å‰èº«åˆ†ï¼š<b id="my-name-display" style="color:var(--gold); font-size:18px;"></b></span>
            <button class="btn-reselect" onclick="backToLogin()">â† é‡é¸äººç‰©</button>
        </div>
        <h3 style="margin:5px 0 15px 0; text-align: center; color: #ddd; font-size:16px;">è«‹æŒ‘é¸ä½ çš„æˆ°é¦¬ (å…±15åŒ¹)</h3>
        <div class="horse-select-grid" id="select-grid"></div>
    </div>

    <button id="start-btn" onclick="triggerStart()">ğŸ é–‹è³½ï¼</button>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%; display: flex; flex-direction: column;"></div>
    </div>

    <div id="leaderboard">
        <h2 style="text-align:center; color: var(--primary); margin: 0 0 20px 0; font-size: 28px;">ğŸ† FINAL RANK ğŸ†</h2>
        <div id="leaderboard-list"></div>
        <button onclick="location.reload()" style="width:100%; padding:15px; margin-top:20px; background: #1a1a1a; color: white; border-radius: 10px; cursor:pointer; font-weight: bold;">è¿”å›é¦–é </button>
    </div>

<script>
    // --- Firebase è¨­å®š ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- æ“´å……è‡³ 15 éš»é¦¬ï¼Œä¿ç•™è©³ç´°æ•¸å€¼ ---
    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, burst: 40, lck: 70}, desc: "æ“…é•·åœ¨ä¸»ç®¡è¦–ç·šå¤–ç·©æ­¥å‰é€²ï¼Œé«”åŠ›æ¢æ·±ä¸å¯æ¸¬ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65, burst: 95, lck: 60}, desc: "å¹³æ™‚ç¯€èƒ½æ¨¡å¼ï¼Œä¸€æ—¦å¤•é™½è¥¿ä¸‹ä¾¿é–‹å•Ÿè¶…é »æ¨¡å¼ã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, burst: 80, lck: 30}, desc: "èµ·æ­¥ç¬é–“å³å·”å³°ï¼Œä½†éœ€æ³¨æ„å¥åº·è­¦è¨Šã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60, burst: 60, lck: 80}, desc: "ç¯€å¥æ„Ÿæ¥µå¼·ï¼Œèƒ½ä»¥ç©©å®šçš„èªé€Ÿå£“åˆ¶å…¨å ´ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, burst: 75, lck: 50}, desc: "ä¾è³´èˆˆå¥®åŠ‘ï¼Œé€Ÿåº¦å–æ±ºæ–¼æ—©ä¸Šçš„æ‹¿éµæ¿ƒåº¦ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, burst: 30, lck: 99}, desc: "æ“æœ‰ç¥ç´šé–ƒé¿ï¼Œä»»ä½•éšœç¤™èˆ‡è²¬ä»»éƒ½ç¢°ä¸åˆ°ç‰ ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, burst: 50, lck: 60}, desc: "æ²’äººæ³¨æ„åˆ°ç‰ å·²æ‚„æ‚„è·‘åˆ°æœ€å‰é¢ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70, burst: 99, lck: 40}, desc: "åœ¨æœ€å¾Œä¸€ç§’å‰ï¼Œä½ æ°¸é ä¸çŸ¥é“ç‰ æœƒçˆ†ç™¼ä»€éº¼ã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50, burst: 70, lck: 60}, desc: "ç”¨æ°£å‹¢é©…å‹•å››è‚¢ï¼Œé€Ÿåº¦å¿«åˆ°è®“äººç„¡æ³•åé§ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, burst: 65, lck: 70}, desc: "ä¸æ±‚æœ€å¿«ï¼Œä½†çµ•å°æ´»å¾—æ¯”ä»»ä½•é¦¬éƒ½ä¹…ã€‚" },
        // æ–°å¢ 5 éš»
        { id: 10, trait: "AIè© å”±å¸«", stats: {spd: 65, sta: 65, burst: 85, lck: 80}, desc: "åªéœ€è¼¸å…¥å’’èªï¼Œä¾¿èƒ½æ†‘ç©ºç”Ÿæˆç§»å‹•è·é›¢ã€‚" },
        { id: 11, trait: "é€šéˆå¤§å¸«", stats: {spd: 50, sta: 80, burst: 40, lck: 100}, desc: "èƒ½æ„Ÿæ‡‰åˆ°å“ªè£¡æœ‰å‘ï¼Œé–‰è‘—çœ¼ç›ä¹Ÿèƒ½è·‘å®Œå…¨ç¨‹ã€‚" },
        { id: 12, trait: "Bugè£½é€ æ©Ÿ", stats: {spd: 90, sta: 30, burst: 90, lck: 20}, desc: "é€Ÿåº¦æ¥µå¿«ï¼Œä½†éš¨æ™‚å¯èƒ½å› ç‚ºä¸æ˜åŸå› åŸåœ°å´©æ½°ã€‚" },
        { id: 13, trait: "éµç›¤ä¿ ", stats: {spd: 85, sta: 55, burst: 70, lck: 40}, desc: "åœ¨ç¶²è·¯ä¸Šè·‘å¾—æ¯”èª°éƒ½å¿«ï¼Œç¾å¯¦ä¸­éœ€è¦ä¸€é»æ™‚é–“æš–æ©Ÿã€‚" },
        { id: 14, trait: "é›²ç«¯æ¼«æ­¥è€…", stats: {spd: 75, sta: 75, burst: 50, lck: 75}, desc: "é£„å¿½ä¸å®šï¼Œæ²’äººçŸ¥é“ç‰ çš„çœŸå¯¦ä½ç½®åœ¨å“ªè£¡ã€‚" }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = localStorage.getItem('my_race_name') || "";
    const urlParams = new URLSearchParams(window.location.search);
    const isAdmin = urlParams.get('admin') === '1';
    let raceStarted = false;

    function init() {
        if (isAdmin) {
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('admin-toolbar').style.display = 'flex';
        }
        
        // ç”Ÿæˆåå­—æŒ‰éˆ•
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn';
            btn.id = `name-${n}`;
            btn.innerText = n;
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        // ç”Ÿæˆé¦¬åŒ¹å¡ç‰‡ (è©³ç´°ç‰ˆ UI)
        const horseGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot';
            div.id = `slot-${i}`;
            div.innerHTML = `
                <div class="trait-tag">${h.trait}</div>
                <div style="font-size:32px; transform: scaleX(-1); text-align:center; margin: 10px 0;">ğŸ</div>
                <div class="stat-group">
                    <div class="stat-row"><span class="stat-label">é€Ÿåº¦</span><div class="stat-bar"><div class="stat-fill" style="width:${h.stats.spd}%"></div></div></div>
                    <div class="stat-row"><span class="stat-label">é«”åŠ›</span><div class="stat-bar"><div class="stat-fill" style="width:${h.stats.sta}%"></div></div></div>
                    <div class="stat-row"><span class="stat-label">çˆ†ç™¼</span><div class="stat-bar"><div class="stat-fill" style="width:${h.stats.burst}%"></div></div></div>
                    <div class="stat-row"><span class="stat-label">å¹¸é‹</span><div class="stat-bar"><div class="stat-fill" style="width:${h.stats.lck}%"></div></div></div>
                </div>
                <div class="horse-desc">${h.desc}</div>
            `;
            div.onclick = () => selectHorse(i);
            horseGrid.appendChild(div);
        });

        listenFirebase();
    }

    function login(n) {
        myName = n;
        localStorage.setItem('my_race_name', n);
        db.ref(`users/${n}`).set(true);
    }

    // é‡é¸åŠŸèƒ½ (åªåœ¨é¸é¦¬é æœ‰æ•ˆ)
    function backToLogin() {
        if (myName) {
            db.ref(`users/${myName}`).remove();
            db.ref(`assignments/${myName}`).remove();
        }
        myName = "";
        localStorage.removeItem('my_race_name');
        document.getElementById('setup').style.display = 'none';
        document.getElementById('user-login').style.display = 'block';
    }

    function selectHorse(idx) {
        if (!myName) return;
        db.ref(`assignments/${myName}`).set(idx);
    }

    function listenFirebase() {
        db.ref('users').on('value', (snap) => {
            const users = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`name-${n}`);
                if (users[n]) {
                    btn.classList.add('taken');
                    // å¦‚æœé€™æ˜¯æˆ‘é¸çš„åå­—ï¼Œé€²å…¥é¸é¦¬ç•«é¢
                    if (n === myName) {
                        btn.classList.add('me');
                        document.getElementById('user-login').style.display = 'none';
                        document.getElementById('setup').style.display = 'flex';
                        document.getElementById('my-name-display').innerText = myName;
                    }
                } else {
                    btn.classList.remove('taken', 'me');
                }
            });
        });

        db.ref('assignments').on('value', (snap) => {
            const assignments = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`slot-${i}`);
                slot.classList.remove('occupied', 'my-pick');
                const overlay = slot.querySelector('.occupied-overlay');
                if (overlay) overlay.remove();

                const owner = Object.keys(assignments).find(name => assignments[name] === i);
                if (owner) {
                    if (owner === myName) {
                        slot.classList.add('my-pick');
                    } else {
                        slot.classList.add('occupied');
                        // é¡¯ç¤ºæ˜¯èª°é¸äº†
                        const ov = document.createElement('div');
                        ov.className = 'occupied-overlay';
                        ov.innerHTML = `<div class="occupied-name">${owner}</div>`;
                        slot.appendChild(ov);
                    }
                }
            });
        });

        db.ref('gameState').on('value', (snap) => {
            const state = snap.val();
            if (state && state.status === 'racing' && !raceStarted) {
                startRaceEngine(state);
            } else if (!state && raceStarted) {
                location.reload();
            }
        });
    }

    function triggerStart() {
        db.ref('assignments').once('value', (snap) => {
            const participants = snap.val() || {};
            if (Object.keys(participants).length === 0) return alert("é‚„æ²’äººé¸é¦¬ï¼");
            db.ref('gameState').set({
                status: 'racing',
                seed: Math.random(),
                participants: participants,
                startTime: Date.now() + 2000
            });
        });
    }

    function resetData() {
        if(!confirm("ç¢ºå®šé‡ç½®æ•¸æ“šå—ï¼Ÿ")) return;
        db.ref().set(null);
        localStorage.clear();
        location.reload();
    }

    // --- æ ¸å¿ƒé‚è¼¯ï¼šVirtual Frames çµ•å°åŒæ­¥ + ç‹€æ…‹æ¨¡æ“¬ ---
    function startRaceEngine(state) {
        raceStarted = true;
        document.getElementById('setup').style.display = 'none';
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('user-login').style.display = 'none';
        document.getElementById('track').style.display = 'block';

        const lanesBox = document.getElementById('lanes-box');
        lanesBox.innerHTML = "";

        const participants = Object.keys(state.participants).map((name) => {
            const horseIdx = state.participants[name];
            return { name: name, horse: horseLibrary[horseIdx] };
        });

        const laneHeight = participants.length > 0 ? (100 / participants.length) : 100;

        participants.forEach((p, idx) => {
            const lane = document.createElement('div');
            lane.className = 'lane';
            lane.style.height = `${laneHeight}%`;
            lane.innerHTML = `
                <div class="horse-container" id="horse-${idx}">
                    <div class="status-bubble" id="bubble-${idx}"></div>
                    <div class="horse-icon" id="icon-${idx}">ğŸ</div>
                    <div class="horse-info-mini" style="font-size:10px; margin-left:5px;">
                        <div>${p.name}</div>
                    </div>
                </div>`;
            lanesBox.appendChild(lane);
        });

        const totalVirtualLength = 10000; 
        const frameTime = 50; 
        const screenTrackWidth = document.getElementById('track').offsetWidth - 130;
        const finishedList = [];

        const timer = setInterval(() => {
            const now = Date.now();
            const elapsed = now - state.startTime;
            if (elapsed < 0) return;

            const targetFrame = Math.floor(elapsed / frameTime);
            
            // å°æ¯åŒ¹é¦¬é€²è¡Œå¾é ­åˆ°å°¾çš„å¿«é€Ÿæ¨¡æ“¬ï¼Œè¿½è¶•åˆ° targetFrame
            participants.forEach((p, i) => {
                // å¦‚æœé€™åŒ¹é¦¬å·²ç¶“åˆ°äº†ï¼Œå°±ä¸ç®—äº†
                if (finishedList.find(x => x.name === p.name)) return;

                // åˆå§‹åŒ–é€™åŒ¹é¦¬çš„æ¨¡æ“¬ç‹€æ…‹
                let seedVal = state.seed + (i * 999);
                function syncRand() {
                    seedVal = (seedVal * 9301 + 49297) % 233280;
                    return seedVal / 233280;
                }

                let vPos = 0; 
                let vSpeed = 0; 
                let vStamina = 100;
                let isStalled = false; 
                let stallTimer = 0;
                let statusText = "";
                let statusColor = "";
                let finishTime = null;

                // æ¨¡æ“¬è¿´åœˆï¼šè·‘æ‰€æœ‰çš„ Frame
                for (let f = 0; f <= targetFrame; f++) {
                    if (vPos >= totalVirtualLength) {
                        finishTime = f; // ç´€éŒ„æ˜¯å“ªä¸€å¹€è·‘å®Œçš„
                        break; 
                    }

                    // --- åŸå§‹é‚è¼¯å¾©åˆ» ---
                    if (isStalled) {
                        stallTimer--;
                        if (stallTimer <= 0) { isStalled = false; statusText = ""; }
                    } else {
                        // æ‰£é«”åŠ›
                        let drainMult = p.horse.id === 2 ? 1.5 : 1.0; 
                        let staminaDrain = (vSpeed * 0.05 + 0.1) * drainMult;
                        vStamina -= staminaDrain;

                        // é«”åŠ›è€—ç›¡
                        if (vStamina <= 0) {
                            vSpeed = 0; isStalled = true; stallTimer = 50; vStamina = 100;
                            statusText = "ğŸ¤® çˆ†è‚ä¸­..."; statusColor = "var(--danger)";
                        }

                        // é€Ÿåº¦è¨ˆç®—
                        let accel = syncRand() * 0.4 + (p.horse.stats.spd * 0.005);
                        
                        // æˆªç¨¿è¡åˆº (ID 7)
                        if (f > 200 && p.horse.id === 7) { accel += 1.5; statusText = "ğŸ”¥ æ­»ç·šæš´è¡"; statusColor = "var(--sprint)"; }
                        
                        vSpeed = (vSpeed * 0.95) + accel;

                        // éš¨æ©Ÿäº‹ä»¶
                        let roll = syncRand();
                        // æ»‘å€’ (ID 5 ä¸æœƒæ»‘å€’)
                        if (f % 50 === 0 && roll < 0.02 && p.horse.id !== 5) {
                            vSpeed = 0; isStalled = true; stallTimer = 30;
                            statusText = "â›¸ï¸ æ»‘å€’äº†"; statusColor = "#546e7a";
                        }
                        // èººå¹³
                        if (f % 80 === 0 && roll > 0.96) {
                            vSpeed = 0; isStalled = true; stallTimer = 40; vStamina += 30;
                            statusText = "ğŸ›Œ èººå¹³..."; statusColor = "var(--recover)";
                        }
                    }
                    vPos += vSpeed;
                }

                // --- æ¸²æŸ“ç•«é¢ ---
                const el = document.getElementById(`horse-${i}`);
                const bubble = document.getElementById(`bubble-${i}`);
                const icon = document.getElementById(`icon-${i}`);

                if (vPos >= totalVirtualLength) {
                    // æŠµé”çµ‚é»
                    el.style.left = (screenTrackWidth + 40) + 'px';
                    // å³æ™‚æ…¶ç¥
                    if (icon.innerText !== "ğŸ‰") {
                        icon.innerText = "ğŸ‰";
                        icon.style.transform = "scale(1.5)";
                        bubble.style.display = 'none';
                    }
                    finishedList.push({ name: p.name, horse: p.horse, time: finishTime || targetFrame });
                } else {
                    // é‚„åœ¨è·‘
                    const screenX = (vPos / totalVirtualLength) * screenTrackWidth;
                    el.style.left = screenX + 'px';
                    
                    // é¡¯ç¤ºç‹€æ…‹æ°£æ³¡
                    if (statusText) {
                        bubble.style.display = 'block';
                        bubble.innerText = statusText;
                        bubble.style.background = statusColor;
                    } else {
                        bubble.style.display = 'none';
                    }
                }
            });

            if (finishedList.length === participants.length) {
                clearInterval(timer);
                setTimeout(() => showLeaderboard(finishedList), 1000);
            }

        }, frameTime);
    }

    function showLeaderboard(results) {
        // ä¾ç…§ finishTime æ’åº (è¶Šå°è¶Šå¿«)
        results.sort((a, b) => a.time - b.time);

        document.getElementById('leaderboard').style.display = 'block';
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = "";
        
        results.forEach((r, i) => {
            const rank = i + 1;
            const item = document.createElement('div');
            item.style.cssText = "padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; font-weight:bold; align-items:center;";
            
            let prizeInfo = "";
            let medal = `#${rank}`;

            // çé …å¾©åŸ
            if (rank === 1) {
                medal = "ğŸ¥‡ ç¬¬ä¸€å";
                prizeInfo = "$2500";
            } else if (rank >= 2 && rank <= 5) {
                medal = `ğŸ¥ˆ ç¬¬${rank}å`;
                prizeInfo = "æ–°å…‰ç¦®åˆ¸ $1000";
            } else {
                const prizes = {6: "$500", 7: "$400", 8: "$300", 9: "$200", 10: "$100"};
                medal = `ğŸ¥‰ ç¬¬${rank}å`;
                prizeInfo = prizes[rank] || "-";
            }

            item.innerHTML = `<div><span style="color:var(--primary); margin-right:5px;">${medal}</span><span>${r.name}</span></div><div class="prize-text">${prizeInfo}</div>`;
            list.appendChild(item);
        });
    }

    init();
</script>
</body>
</html>
