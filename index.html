<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - åŒæ­¥å„ªåŒ–ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --gold: #ffd700; --primary: #ff5252; --card-bg: #252525;
            --success: #4caf50; --danger: #ff4444;
        }
        body { 
            font-family: 'PingFang TC', sans-serif; background: #121212; color: white; 
            margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; 
        }

        /* ç°¡ç´„ Admin æ‡¸æµ®åˆ— */
        #admin-panel {
            position: fixed; top: 10px; right: 10px; z-index: 9999;
            background: rgba(0,0,0,0.7); padding: 5px; border-radius: 8px;
            display: none; gap: 5px; border: 1px solid #444;
        }
        .admin-btn {
            padding: 8px 12px; border-radius: 5px; border: none;
            color: white; font-size: 12px; cursor: pointer; font-weight: bold;
        }
        .btn-reset { background: #444; }
        .btn-start { background: var(--success); }

        /* é¸é¦¬å€è¡Œå‹•åŒ–å„ªåŒ– */
        .setup-area { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; display: none; }
        .horse-slot { 
            background: var(--card-bg); border-radius: 12px; padding: 12px; 
            margin-bottom: 10px; border: 2px solid #333; position: relative;
        }
        .horse-slot.my-pick { border-color: var(--gold); background: #2d2d1a; }
        .horse-slot.occupied { opacity: 0.4; pointer-events: none; }
        
        .stat-row { display: flex; align-items: center; font-size: 10px; margin-top: 2px; }
        .stat-label { width: 30px; color: #888; }
        .stat-bar { flex: 1; height: 4px; background: #000; border-radius: 2px; margin-left: 5px; }
        .stat-fill { height: 100%; background: var(--gold); border-radius: 2px; }

        /* è³½é“ - ç¢ºä¿æ‰€æœ‰è£ç½®æ¯”ä¾‹ä¸€è‡´ */
        .track-container { 
            flex-grow: 1; background: #1a1a1a; display: none; position: relative;
            border-top: 1px solid #333; overflow: hidden;
        }
        .lane { 
            position: relative; border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; width: 100%;
        }
        .horse-entity {
            position: absolute; left: 0; display: flex; align-items: center;
            transition: transform 0.1s linear; will-change: transform;
        }
        .finish-line {
            position: absolute; right: 50px; top: 0; bottom: 0; width: 10px;
            background: repeating-linear-gradient(0deg, #333, #333 10px, #111 10px, #111 20px);
            border-left: 2px dashed var(--gold);
        }

        /* åå­—ç¶²æ ¼ */
        #user-login { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; padding: 20px; }
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .name-btn { height: 50px; background: #333; border: none; color: white; border-radius: 8px; font-weight: bold; }
        .name-btn.taken { opacity: 0.2; }
        .name-btn.me { background: var(--gold); color: black; }

        #leaderboard {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; background: white; color: black; border-radius: 15px;
            padding: 20px; z-index: 10000; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>

    <div id="admin-panel">
        <button class="admin-btn btn-reset" onclick="resetData()">é‡ç½®</button>
        <button class="admin-btn btn-start" onclick="triggerStart()">é–‹å§‹æ¯”è³½</button>
    </div>

    <div id="user-login">
        <h2 style="text-align:center; color:var(--gold);">Who are you?</h2>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="setup" class="setup-area">
        <h3 style="text-align:center; margin-bottom:15px;">æŒ‘é¸ä½ çš„æˆ°é¦¬</h3>
        <div id="select-grid"></div>
    </div>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%;"></div>
    </div>

    <div id="leaderboard">
        <h2 style="text-align:center; color:var(--danger); margin:0;">ğŸ† æœ€çµ‚æ’å</h2>
        <div id="leaderboard-list" style="margin: 15px 0;"></div>
        <button onclick="location.reload()" style="width:100%; padding:12px; background:#333; color:white; border:none; border-radius:8px;">è¿”å›</button>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
        authDomain: "aiot-d53dc.firebaseapp.com",
        databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
        projectId: "aiot-d53dc",
        storageBucket: "aiot-d53dc.firebasestorage.app",
        messagingSenderId: "1021331253049",
        appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
        measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", speedBase: 0.9, luck: 0.8 },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", speedBase: 0.7, luck: 0.9 },
        { id: 2, trait: "çˆ†è‚ç‹", speedBase: 1.2, luck: 0.3 },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", speedBase: 0.95, luck: 0.6 },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’", speedBase: 1.1, luck: 0.4 },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", speedBase: 0.6, luck: 1.0 },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", speedBase: 0.85, luck: 0.7 },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", speedBase: 0.5, luck: 0.95 },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", speedBase: 1.0, luck: 0.5 },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", speedBase: 0.9, luck: 0.7 }
    ];

    const names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = localStorage.getItem('my_race_name') || "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';

    function init() {
        if (isAdmin) document.getElementById('admin-panel').style.display = 'flex';
        
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn';
            btn.id = `name-${n}`;
            btn.innerText = n;
            btn.onclick = () => {
                myName = n;
                localStorage.setItem('my_race_name', n);
                db.ref(`users/${n}`).set(true);
            };
            nameGrid.appendChild(btn);
        });

        const selectGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot';
            div.id = `slot-${i}`;
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b style="color:var(--gold);">${h.trait}</b>
                    <span style="font-size:20px; transform:scaleX(-1);">ğŸ</span>
                </div>
                <div class="stat-row"><div class="stat-label">SPD</div><div class="stat-bar"><div class="stat-fill" style="width:${h.speedBase*80}%"></div></div></div>
            `;
            div.onclick = () => db.ref(`assignments/${myName}`).set(i);
            selectGrid.appendChild(div);
        });

        listenFirebase();
    }

    function listenFirebase() {
        db.ref('users').on('value', snap => {
            const users = snap.val() || {};
            names.forEach(n => {
                const el = document.getElementById(`name-${n}`);
                el.className = `name-btn ${users[n] ? 'taken' : ''} ${n === myName ? 'me' : ''}`;
                if (n === myName && users[n]) {
                    document.getElementById('user-login').style.display = 'none';
                    document.getElementById('setup').style.display = 'block';
                }
            });
        });

        db.ref('assignments').on('value', snap => {
            const data = snap.val() || {};
            document.querySelectorAll('.horse-slot').forEach((el, i) => {
                el.classList.remove('occupied', 'my-pick');
                const owner = Object.keys(data).find(k => data[k] === i);
                if (owner) {
                    if (owner === myName) el.classList.add('my-pick');
                    else el.classList.add('occupied');
                }
            });
        });

        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (state && state.status === 'racing') {
                startRaceUI(state);
            } else if (!state) {
                location.reload();
            }
        });
    }

    // --- åŒæ­¥æ ¸å¿ƒé‚è¼¯ ---
    function startRaceUI(state) {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('user-login').style.display = 'none';
        document.getElementById('track').style.display = 'block';

        const participants = Object.keys(state.participants).map(name => ({
            name, horse: horseLibrary[state.participants[name]]
        }));

        const lanesBox = document.getElementById('lanes-box');
        lanesBox.innerHTML = '';
        participants.forEach((p, idx) => {
            const lane = document.createElement('div');
            lane.className = 'lane';
            lane.style.height = `${100 / participants.length}%`;
            lane.innerHTML = `
                <div class="horse-entity" id="horse-ent-${idx}">
                    <div style="font-size:24px; transform:scaleX(-1);">ğŸ</div>
                    <div style="font-size:10px; margin-left:5px;">${p.name}</div>
                </div>`;
            lanesBox.appendChild(lane);
        });

        const raceDuration = 30000; // 30ç§’
        const trackWidth = document.getElementById('track').offsetWidth - 100;

        const syncTimer = setInterval(() => {
            const now = Date.now();
            const elapsed = now - state.startTime;
            const progress = Math.min(elapsed / raceDuration, 1.1); // ç¨å¾®è·‘éçµ‚é»

            participants.forEach((p, idx) => {
                // ä½¿ç”¨ seed èˆ‡åƒèˆ‡è€…ç´¢å¼•å‰µé€ å”¯ä¸€çš„ã€Œç¢ºå®šæ€§éš¨æ©Ÿã€
                const horseSeed = state.seed + idx;
                const variance = Math.sin(progress * 10 + horseSeed) * 0.05; // éœ‡ç›ªæ„Ÿ
                const speedMod = p.horse.speedBase * (1 + (Math.sin(horseSeed) * 0.2));
                
                let curPos = progress * speedMod + variance;
                
                // æ¨¡æ“¬çˆ†ç™¼æˆ–æ»‘å€’ï¼ˆåŸºæ–¼æ™‚é–“é»çš„ç¢ºå®šæ€§ï¼‰
                if (progress > 0.8 && p.horse.id === 7) curPos += (progress - 0.8) * 2; // æˆªç¨¿è¡åˆº

                const el = document.getElementById(`horse-ent-${idx}`);
                const x = Math.min(curPos * trackWidth, trackWidth + 60);
                el.style.transform = `translateX(${x}px)`;

                // åˆ¤æ–·æ¯”è³½çµæŸ
                if (progress >= 1.2) {
                    clearInterval(syncTimer);
                    if (idx === 0) showFinalLeaderboard(participants, state.seed, raceDuration);
                }
            });
        }, 50);
    }

    function showFinalLeaderboard(list, seed, duration) {
        // ä½¿ç”¨ç›¸åŒçš„ç¢ºå®šæ€§é‚è¼¯è¨ˆç®—æ’å
        const results = list.map((p, idx) => {
            const horseSeed = seed + idx;
            const speedMod = p.horse.speedBase * (1 + (Math.sin(horseSeed) * 0.2));
            const finalScore = speedMod + (p.horse.id === 7 ? 0.4 : 0); // æ¨¡æ“¬æœ€çµ‚çµæœ
            return { name: p.name, score: finalScore };
        }).sort((a, b) => b.score - a.score);

        const listEl = document.getElementById('leaderboard-list');
        listEl.innerHTML = '';
        results.forEach((r, i) => {
            listEl.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
                <span>#${i+1} ${r.name}</span>
                <span style="color:red; font-weight:bold;">$${i === 0 ? 2500 : (i < 5 ? 1000 : 100)}</span>
            </div>`;
        });
        document.getElementById('leaderboard').style.display = 'block';
    }

    function triggerStart() {
        db.ref('assignments').once('value', snap => {
            const p = snap.val();
            if(!p) return alert("æ²’äººé¸é¦¬ï¼");
            db.ref('gameState').set({
                status: 'racing',
                startTime: Date.now() + 2000, // 2ç§’å¾Œå…¨é«”åŒæ­¥é–‹å§‹
                seed: Math.random(),
                participants: p
            });
        });
    }

    function resetData() {
        if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) db.ref().set(null);
    }

    init();
</script>
</body>
</html>
