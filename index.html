<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT é¦¬å¹´è³½é¦¬å¤§æœƒ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        /* ============================================================
           shadcn-style Design Tokens
           ============================================================ */
        :root {
            /* Zinc palette (shadcn dark) */
            --bg-base:      #09090b; /* zinc-950 */
            --bg-card:      #18181b; /* zinc-900 */
            --bg-card-hover:#1f1f24; /* zinc-900 hover */
            --bg-muted:     #27272a; /* zinc-800 */
            --border:       #3f3f46; /* zinc-700 */
            --border-hover: #52525b; /* zinc-600 */
            --text-primary: #f4f4f5; /* zinc-100 */
            --text-secondary:#a1a1aa;/* zinc-400 */
            --text-muted:   #71717a; /* zinc-500 */

            /* Brand accents */
            --gold:         #ffd700;
            --gold-dim:     rgba(255,215,0,0.12);
            --danger:       #ef4444; /* red-500 */
            --danger-dim:   rgba(239,68,68,0.15);
            --success:      #22c55e; /* green-500 */
            --success-dim:  rgba(34,197,94,0.12);
            --recover:      #38bdf8; /* sky-400 */
            --recover-dim:  rgba(56,189,248,0.15);
            --sprint:       #fb923c; /* orange-400 */

            /* Radius */
            --radius-sm:    4px;
            --radius:       6px;
            --radius-md:    8px;
            --radius-lg:    12px;
            --radius-pill:  9999px;
        }

        /* ============================================================
           Reset + Base
           ============================================================ */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            margin: 0; padding: 0;
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* ============================================================
           Header
           ============================================================ */
        .header-bar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            height: 56px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1000;
        }

        /* ============================================================
           Buttons (shadcn style)
           ============================================================ */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 13px; font-weight: 500;
            padding: 7px 14px;
            cursor: pointer;
            background: var(--bg-muted);
            color: var(--text-primary);
            transition: background 0.15s, border-color 0.15s, transform 0.1s;
            user-select: none;
            -webkit-user-select: none;
        }
        .btn:hover  { background: var(--bg-card-hover); border-color: var(--border-hover); }
        .btn:active { transform: scale(0.97); }

        .btn-primary {
            background: var(--gold);
            color: #000;
            border-color: var(--gold);
            font-weight: 600;
        }
        .btn-primary:hover { background: #e6c200; border-color: #e6c200; }

        .btn-danger  { background: var(--danger); color: #fff; border-color: var(--danger); }
        .btn-danger:hover { background: #dc2626; border-color: #dc2626; }

        .btn-ghost   { background: transparent; border-color: transparent; color: var(--text-secondary); }
        .btn-ghost:hover { background: var(--bg-muted); color: var(--text-primary); border-color: transparent; }

        /* ============================================================
           Pages
           ============================================================ */
        .page {
            display: none;
            height: calc(100vh - 56px);
            width: 100vw;
            position: absolute;
            top: 56px;
            flex-direction: column;
            overflow-y: auto;
        }
        .page.active { display: flex; }

        /* ============================================================
           Login Page â€” Name Cards
           ============================================================ */
        .login-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 16px;
            width: 100%;
        }
        .name-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 28px 12px;
            text-align: center;
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s, transform 0.1s;
        }
        .name-card:hover {
            border-color: var(--gold);
            background: var(--gold-dim);
            transform: translateY(-1px);
        }
        .name-card:active { transform: scale(0.97); }
        .name-card.taken  { opacity: 0.25; filter: grayscale(1); pointer-events: none; cursor: default; }
        .name-card.wide   { grid-column: 1 / -1; }

        /* ============================================================
           Horse Selection Page
           ============================================================ */
        .horse-list { padding: 12px 16px 100px; }

        .horse-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 10px;
            position: relative;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s, transform 0.1s;
        }
        .horse-card:hover { border-color: var(--border-hover); background: var(--bg-card-hover); transform: translateY(-1px); }
        .horse-card:active { transform: scale(0.98); }
        .horse-card.selected { border-color: var(--gold); background: var(--gold-dim); }
        .horse-card.occupied { opacity: 0.4; filter: grayscale(0.6); pointer-events: none; cursor: default; }
        .horse-card.occupied:hover { transform: none; background: var(--bg-card); border-color: var(--border); }

        /* Owner badge â€” pill outline style */
        .owner-badge {
            position: absolute; top: 12px; right: 12px;
            border: 1px solid var(--danger);
            color: var(--danger);
            background: var(--danger-dim);
            padding: 2px 10px;
            border-radius: var(--radius-pill);
            font-size: 11px; font-weight: 500;
            z-index: 2;
        }

        .horse-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .horse-header .horse-icon { font-size: 26px; }
        .horse-header .horse-name { font-size: 16px; font-weight: 600; color: var(--gold); }

        /* Stat bars */
        .stat-grid  { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 16px; }
        .stat-item  { display: flex; flex-direction: column; gap: 4px; }
        .stat-label { font-size: 11px; font-weight: 500; color: var(--text-muted); letter-spacing: 0.3px; }
        .stat-bar   { height: 5px; background: var(--bg-muted); border-radius: var(--radius-pill); overflow: hidden; }
        .stat-fill  { height: 100%; background: var(--gold); border-radius: var(--radius-pill); transition: width 0.3s; }

        .horse-desc {
            font-size: 12px; color: var(--text-secondary);
            font-style: italic;
            border-top: 1px solid var(--border);
            margin-top: 12px; padding-top: 10px;
        }

        /* Rule box */
        .rule-box {
            margin: 12px 16px 4px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 14px 16px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.7;
        }
        .rule-box b { color: var(--text-primary); font-weight: 600; }
        .rule-box .rule-title { color: var(--gold); font-weight: 600; font-size: 13px; margin-bottom: 6px; display: block; }

        /* ============================================================
           Track Page
           ============================================================ */
        #page-track { background: var(--bg-base); top: 0; height: 100vh; }
        .track-bg   { height: 100%; position: relative; }
        #lanes-render-area { display: flex; flex-direction: column; height: 100%; }

        .lane {
            position: relative;
            border-bottom: 1px solid #1a1a1f;
            flex-grow: 1;
            display: flex;
            align-items: center;
            padding-left: 8px;
        }
        .lane:last-child { border-bottom: none; }

        .finish-line {
            position: absolute; right: 0; top: 0; bottom: 0; width: 36px;
            background: repeating-linear-gradient(45deg, #fff, #fff 8px, #1a1a1f 8px, #1a1a1f 16px);
            border-left: 3px solid var(--gold);
            z-index: 5;
        }

        /* Horse pawn */
        .horse-pawn {
            position: absolute; left: 0;
            display: flex; align-items: center;
            width: 140px;
            transition: left 0.15s linear;
        }
        .horse-visual {
            font-size: 36px;
            transform: scaleX(-1);
            animation: gallop 0.4s infinite;
            transition: filter 0.25s;
        }

        .effect-sprint   { filter: drop-shadow(0 0 10px var(--sprint)) scaleX(-1) !important; }
        .effect-exhausted{ filter: drop-shadow(0 0 8px var(--danger))  scaleX(-1) !important; }
        .effect-slip     { animation: slip-shake 0.18s infinite !important; }

        @keyframes gallop {
            0%, 100% { transform: scaleX(-1) translateY(0); }
            50%      { transform: scaleX(-1) translateY(-5px); }
        }
        @keyframes slip-shake {
            0%   { transform: scaleX(-1) rotate(0deg); }
            25%  { transform: scaleX(-1) rotate(18deg)  translateY(-2px); }
            75%  { transform: scaleX(-1) rotate(-18deg) translateY(2px); }
            100% { transform: scaleX(-1) rotate(0deg); }
        }

        /* Speech bubble */
        .speech-bubble {
            position: absolute; top: -48px; left: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 4px 10px;
            border-radius: var(--radius-md);
            font-size: 12px; font-weight: 600;
            box-shadow: 0 2px 6px rgba(0,0,0,0.35);
            z-index: 20; white-space: nowrap;
        }
        .speech-bubble::after {
            content: ''; position: absolute; bottom: -5px; left: 12px;
            border-width: 5px 5px 0; border-style: solid;
            border-color: var(--bg-card) transparent;
        }

        .bubble-danger {
            background: var(--danger-dim);
            border-color: var(--danger);
            color: var(--danger);
        }
        .bubble-danger::after { border-color: var(--danger-dim) transparent; }

        .bubble-recover {
            background: var(--recover-dim);
            border-color: var(--recover);
            color: var(--recover);
        }
        .bubble-recover::after { border-color: var(--recover-dim) transparent; }

        .bubble-sprint {
            background: rgba(251,146,60,0.15);
            border-color: var(--sprint);
            color: var(--sprint);
        }
        .bubble-sprint::after { border-color: rgba(251,146,60,0.15) transparent; }

        .bubble-finish {
            background: var(--gold-dim);
            border-color: var(--gold);
            color: var(--gold);
            font-size: 18px;
        }
        .bubble-finish::after { border-color: var(--gold-dim) transparent; }

        /* Stamina bar under name */
        .pawn-info       { margin-left: 8px; }
        .pawn-name       { font-size: 10px; font-weight: 600; color: var(--text-secondary); letter-spacing: 0.2px; }
        .stamina-track   { width: 44px; height: 3px; background: var(--bg-muted); border-radius: var(--radius-pill); margin-top: 3px; overflow: hidden; }
        .stamina-fill    { height: 100%; background: var(--success); border-radius: var(--radius-pill); transition: width 0.25s; }
        .stamina-fill.low { background: var(--danger); }

        /* ============================================================
           Countdown Overlay
           ============================================================ */
        #countdown-overlay {
            position: fixed; inset: 0;
            background: rgba(9,9,11,0.88);
            display: none; align-items: center; justify-content: center;
            z-index: 2000;
            font-size: 140px; font-weight: 700;
            color: var(--gold);
            letter-spacing: -4px;
        }

        /* ============================================================
           Admin Monitor Box
           ============================================================ */
        .admin-monitor-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            margin: 12px 16px;
            padding: 12px 14px;
            border-radius: var(--radius-lg);
        }
        .admin-monitor-title { font-size: 11px; font-weight: 600; color: var(--gold); margin-bottom: 8px; letter-spacing: 0.4px; }

        .player-status-tag {
            display: inline-flex; align-items: center;
            padding: 3px 10px;
            border-radius: var(--radius-pill);
            font-size: 11px; font-weight: 500;
            margin: 2px 2px;
            background: var(--bg-muted);
            border: 1px solid var(--border);
            color: var(--text-muted);
            transition: border-color 0.15s, color 0.15s;
        }
        .player-status-tag.ready { border-color: var(--success); color: var(--success); }

        /* Admin floating controls */
        .admin-persistent-ctrl {
            position: fixed; bottom: 24px; left: 24px;
            z-index: 9999; display: none;
            flex-direction: column; gap: 8px;
        }

        /* ============================================================
           Leaderboard Overlay (shadcn modal style)
           ============================================================ */
        #leaderboard-overlay {
            position: fixed; inset: 0;
            background: rgba(9,9,11,0.85);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: none; align-items: center; justify-content: center;
        }
        .leaderboard-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 88%; max-width: 420px;
            padding: 28px 24px 24px;
            box-shadow: 0 16px 40px rgba(0,0,0,0.4);
        }
        .leaderboard-title {
            text-align: center;
            font-size: 20px; font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
        }
        .leaderboard-title span { color: var(--gold); }

        .rank-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 11px 0;
            border-bottom: 1px solid var(--border);
        }
        .rank-row:last-of-type { border-bottom: none; }
        .rank-row-left  { display: flex; align-items: center; gap: 12px; }
        .rank-badge {
            width: 28px; height: 28px;
            border-radius: var(--radius-pill);
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 700;
            background: var(--bg-muted); color: var(--text-muted);
            border: 1px solid var(--border);
        }
        .rank-badge.gold   { background: rgba(255,215,0,0.18); border-color: var(--gold);  color: var(--gold);  }
        .rank-badge.silver { background: rgba(192,192,192,0.18); border-color: #c0c0c0; color: #c0c0c0; }
        .rank-badge.bronze { background: rgba(205,127,50,0.18);  border-color: #cd7f32; color: #cd7f32; }

        .rank-name  { font-size: 14px; font-weight: 600; color: var(--text-primary); }

        .lb-reset-btn { display: none; width: 100%; margin-top: 20px; padding: 10px 0; font-size: 14px; }

        /* ============================================================
           Page-level heading helpers
           ============================================================ */
        .page-heading {
            text-align: center; padding: 24px 16px 4px;
        }
        .page-heading h1 {
            margin: 0; font-size: 22px; font-weight: 700;
            color: var(--text-primary); letter-spacing: 2px;
        }
        .page-heading h2 {
            margin: 0; font-size: 18px; font-weight: 600; color: var(--text-primary);
        }
        .page-heading h1 .accent, .page-heading h2 .accent { color: var(--gold); }
        .page-heading p { margin: 6px 0 0; font-size: 13px; color: var(--text-muted); }
    </style>
</head>
<body>

<audio id="bgm" loop src="https://assets.mixkit.co/music/preview/mixkit-fast-game-action-loop-460.mp3"></audio>
<div id="countdown-overlay">READY</div>

<!-- Header -->
<div class="header-bar" id="header">
    <div>
        <button class="btn btn-ghost" id="btn-back" onclick="logout()" style="display:none;">â¬… è¿”å›</button>
    </div>
    <div id="label-user-name" style="font-size:13px; font-weight:600; color:var(--gold);">GUEST</div>
</div>

<!-- ============================================================
     PAGE: Login
     ============================================================ -->
<div id="page-login" class="page active">
    <div id="admin-login-monitor" style="display:none;" class="admin-monitor-box">
        <div class="admin-monitor-title">[ADMIN] å³æ™‚é¸é¦¬é€²åº¦</div>
        <div id="admin-status-grid"></div>
    </div>
    <div class="page-heading">
        <h1><span class="accent">AIOT</span> 2026 é¦¬å¹´è³½é¦¬çé‡‘è³½</h1>
        <p>é»æ“Šä½ çš„åå­—åŠ å…¥æ¯”è³½</p>
    </div>
    <div class="login-grid" id="login-grid"></div>
</div>

<!-- ============================================================
     PAGE: Horse Selection
     ============================================================ -->
<div id="page-setup" class="page">
    <div class="page-heading">
        <h2>ğŸ è«‹é¸æ“‡æ‚¨çš„åƒè³½æˆ°é¦¬</h2>
    </div>
    <div class="rule-box">
        <span class="rule-title">ğŸ“Š å±¬æ€§å½±éŸ¿èªªæ˜</span>
        <b>é€Ÿåº¦</b> åŸºç¤ç§»å‹•é€Ÿåº¦ã€‚é€Ÿåº¦è¶Šå¿«ï¼Œé«”åŠ›æ¶ˆè€—ä¹Ÿè¶Šå¿«ã€‚<br>
        <b>é«”åŠ›</b> å½±éŸ¿çºŒèˆªåŠ›ã€‚æ•¸å€¼è¶Šé«˜ï¼Œè¶Šä¸å®¹æ˜“é€²å…¥ã€Œçˆ†è‚ã€èººå¹³ç‹€æ…‹ã€‚<br>
        <b>çˆ†ç™¼</b> è¡åˆºæ™‚çš„å¢ç›Šå¼·åº¦ã€‚æ•¸å€¼è¶Šé«˜ï¼Œè§¸ç™¼è¡åˆºæ™‚å™´ç™¼è¶Šé ã€‚<br>
        <b>é‹æ°£</b> æ•¸å€¼è¶Šé«˜ï¼Œè¶Šä¸å®¹æ˜“ç™¼ç”Ÿæ»‘å€’æ„å¤–ï¼Œä¸”è§¸ç™¼è¡åˆºæ©Ÿç‡è¶Šé«˜ã€‚
    </div>
    <div class="horse-list" id="horse-selection-list"></div>
</div>

<!-- ============================================================
     PAGE: Track
     ============================================================ -->
<div id="page-track" class="page">
    <div class="track-bg">
        <div class="finish-line"></div>
        <div id="lanes-render-area"></div>
    </div>
</div>

<!-- Admin Controls -->
<div class="admin-persistent-ctrl" id="admin-ctrl">
    <button class="btn btn-primary" id="admin-start-btn" onclick="adminStart()" style="padding:12px 28px; font-size:15px;">ğŸ é–‹å§‹æ¯”è³½</button>
    <button class="btn btn-danger"  id="admin-reset-btn"  onclick="adminReset()"  style="padding:8px 18px;">ğŸ”„ é‡ç½®å…¨å ´</button>
</div>

<!-- ============================================================
     Leaderboard Overlay
     ============================================================ -->
<div id="leaderboard-overlay">
    <div class="leaderboard-card">
        <div class="leaderboard-title">ğŸ† <span>æ’è¡Œæ¦œ</span> ğŸ†</div>
        <div id="rankings-list"></div>
        <button class="btn btn-ghost lb-reset-btn" id="lb-reset-btn" onclick="adminReset()">ä¸‹ä¸€è¼ªæ¯”è³½</button>
    </div>
</div>

<script>
// =====================================================================
// Firebase
// =====================================================================
const firebaseConfig = {
    apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
    authDomain: "aiot-d53dc.firebaseapp.com",
    databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
    projectId: "aiot-d53dc",
    storageBucket: "aiot-d53dc.firebasestorage.app",
    messagingSenderId: "1021331253049",
    appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
    measurementId: "G-9YDKS70ZE7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// =====================================================================
// Data
// =====================================================================
const horseLibrary = [
    { id:0,  trait:"è–ªæ°´å°å·",      stats:{spd:60,sta:95,burst:40,lck:70}, desc:"æ“…é•·åœ¨ä¸»ç®¡è¦–ç·šå¤–ç·©æ­¥å‰é€²ï¼Œé«”åŠ›æ·±ä¸å¯æ¸¬ã€‚" },
    { id:1,  trait:"ä¸‹ç­æˆ°ç¥",       stats:{spd:55,sta:65,burst:95,lck:60}, desc:"ä¸€æ—¦å¤•é™½è¥¿ä¸‹ï¼Œé«”åŠ›å†ä½ä¹Ÿèƒ½çˆ†ç™¼è¡åˆºã€‚" },
    { id:2,  trait:"çˆ†è‚ç‹",         stats:{spd:95,sta:25,burst:85,lck:30}, desc:"èµ·æ­¥ç¬é–“å³å·”å³°ï¼Œä½†çˆ†è‚å€’æ•¸æ˜¯ä»–çš„æ—¥å¸¸ã€‚" },
    { id:3,  trait:"æœƒè­°æˆ°é¬¥æ©Ÿ",     stats:{spd:75,sta:60,burst:60,lck:80}, desc:"ç¯€å¥æ„Ÿæ¥µå¼·ï¼Œä»¥ç©©å®šçš„é«˜èªé€Ÿå£“åˆ¶å…¨å ´ã€‚" },
    { id:4,  trait:"å’–å•¡ä¸­æ¯’è€…",     stats:{spd:80,sta:45,burst:75,lck:55}, desc:"ä¾è³´å’–å•¡å› æé€Ÿï¼Œæ²’å’–å•¡æ™‚é«”åŠ›æ‰è¶…å¿«ã€‚" },
    { id:5,  trait:"ç”©é‹å°ˆæ¥­æˆ¶",     stats:{spd:45,sta:85,burst:30,lck:99}, desc:"æ‹¥æœ‰ç¥ç´šé–ƒé¿ï¼Œå¹¾ä¹ä¸æœƒæ»‘å€’ï¼Œé‹æ°£é»æ»¿ã€‚" },
    { id:6,  trait:"åŠ ç­é‚Šç·£äºº",     stats:{spd:55,sta:90,burst:50,lck:65}, desc:"é›–ç„¶æ²’å­˜åœ¨æ„Ÿï¼Œä½†é«”åŠ›é©šäººä¸”è·‘å¾—ç•°å¸¸ç©©ã€‚" },
    { id:7,  trait:"æˆªç¨¿è¡åˆº",       stats:{spd:40,sta:70,burst:99,lck:40}, desc:"å¹³æ™‚éƒ½åœ¨æ··ï¼Œæœ€å¾Œé—œé ­è¡åˆºåŠ›é‡ç„¡äººèƒ½åŠã€‚" },
    { id:8,  trait:"ç”¨å˜´åšäº‹",       stats:{spd:85,sta:50,burst:70,lck:65}, desc:"ç”¨æ°£å‹¢é©…å‹•å››è‚¢ï¼Œçˆ†ç™¼åŠ›èˆ‡é€Ÿåº¦å…¼å…·çš„å‹ç”·ã€‚" },
    { id:9,  trait:"ä¸­åº¸ä¹‹é“",       stats:{spd:70,sta:75,burst:65,lck:70}, desc:"ä¸æ±‚æœ€å¿«ï¼Œä½†é«”åŠ›èˆ‡é‹æ°£è®“ä»–å§‹çµ‚åœ¨ç¬¬ä¸€æ¢¯éšŠã€‚" },
    { id:10, trait:"é€šéˆç‹",         stats:{spd:50,sta:50,burst:40,lck:100},desc:"èƒ½é çŸ¥éœ€æ±‚ï¼Œé è‘—ç¥ç´šç›´è¦ºé¿é–‹æ‰€æœ‰éšœç¤™ã€‚" },
    { id:11, trait:"ç°¡å ±å¤§å¸«",       stats:{spd:90,sta:30,burst:90,lck:40}, desc:"ç•«é¢å¾ˆè¯éº—ï¼Œä½†çºŒèˆªåŠ›æ¥µä½ï¼Œæ²’è¬›å®Œå°±æ–·é›»ã€‚" },
    { id:12, trait:"Debugç‹",        stats:{spd:65,sta:65,burst:65,lck:95}, desc:"åªè¦ä»–åœ¨ï¼Œç¨‹å¼ç¢¼è‡ªå‹•ä¿®å¾©ï¼Œæ€éº¼ä¿®çš„?ä¸çŸ¥é“ï¼Œé‹æ°£å°±æ˜¯ä¸€åˆ‡ã€‚" },
    { id:13, trait:"èŒ¶æ°´é–“å®ˆé–€å“¡",   stats:{spd:40,sta:100,burst:20,lck:80},desc:"æ¯å¤©æº–æ™‚å ±åˆ°ï¼Œé«”åŠ›å…¨å ´æœ€ç¡¬ï¼Œæ…¢æ…¢ç£¨åˆ°çµ‚é»ã€‚" },
    { id:14, trait:"Teasm æ½›æ°´å“¡",   stats:{spd:75,sta:75,burst:50,lck:50}, desc:"æ²’äº‹ä¸å›è¨Šï¼Œä¸€æ—¦å›è¨Šæ¯å°±æ˜¯ä¸€é³´é©šäººã€‚" }
];

const names = ["Greg","Julia","Molly","DON","è±ªå“¥","Gimme","Erick","éŸ‹å¿—","Juli","Jason","Kris"];

// Finish-line emojis indexed 0-based: rank 1 = index 0
const rankEmojis = ["ğŸ¥³","ğŸ˜","ğŸ˜Š","ğŸ˜","ğŸ¤”","ğŸ˜“","ğŸ˜«","ğŸ˜­","ğŸ’€","ğŸª¦","ğŸ‘»"];

let myName = localStorage.getItem('race_user') || "";
const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
let serverOffset = 0;

db.ref(".info/serverTimeOffset").on("value", s => { serverOffset = s.val() || 0; });

// =====================================================================
// Init
// =====================================================================
function init() {
    if (isAdmin) {
        document.getElementById('admin-ctrl').style.display = 'flex';
        document.getElementById('admin-login-monitor').style.display = 'block';
        document.getElementById('lb-reset-btn').style.display = 'inline-flex';
        document.getElementById('label-user-name').innerText = "ADMIN";
    }

    // Login grid
    const loginGrid = document.getElementById('login-grid');
    names.forEach((n, idx) => {
        const d = document.createElement('div');
        d.className = 'name-card' + (idx === 0 ? ' wide' : '');
        d.id = `user-${n}`; d.innerText = n;
        d.onclick = () => {
            myName = n;
            localStorage.setItem('race_user', n);
            db.ref(`users/${n}`).set(true);
            document.getElementById('bgm').play();
        };
        loginGrid.appendChild(d);
    });

    // Horse cards
    const setupGrid = document.getElementById('horse-selection-list');
    horseLibrary.forEach((h, i) => {
        const d = document.createElement('div');
        d.className = 'horse-card'; d.id = `slot-${i}`;
        d.innerHTML = `
            <div class="owner-badge" id="owner-${i}" style="display:none;"></div>
            <div class="horse-header">
                <span class="horse-icon">ğŸ</span>
                <span class="horse-name">${h.trait}</span>
            </div>
            <div class="stat-grid">
                ${renderStat("é€Ÿåº¦", h.stats.spd)}
                ${renderStat("é«”åŠ›", h.stats.sta)}
                ${renderStat("çˆ†ç™¼", h.stats.burst)}
                ${renderStat("é‹æ°£", h.stats.lck)}
            </div>
            <div class="horse-desc">${h.desc}</div>
        `;
        d.onclick = () => {
            if (!myName) return;
            db.ref('assignments').once('value', snap => {
                const a = snap.val() || {};
                if (Object.entries(a).some(([p, idx]) => idx === i && p !== myName)) {
                    alert("æ…¢äº†ï¼è¢«é¸èµ°å›‰ï¼");
                } else {
                    db.ref(`assignments/${myName}`).set(i);
                }
            });
        };
        setupGrid.appendChild(d);
    });

    listenFirebase();
}

function renderStat(label, val) {
    return `<div class="stat-item">
                <span class="stat-label">${label}</span>
                <div class="stat-bar"><div class="stat-fill" style="width:${val}%"></div></div>
            </div>`;
}

function logout() {
    if (myName) { db.ref(`users/${myName}`).remove(); db.ref(`assignments/${myName}`).remove(); }
    localStorage.removeItem('race_user'); myName = ""; location.reload();
}

// =====================================================================
// Firebase Listeners
// =====================================================================
let isRacingNow = false;

function listenFirebase() {
    // --- users ---
    db.ref('users').on('value', snap => {
        const u = snap.val();
        if (!u && myName && !isAdmin) { localStorage.removeItem('race_user'); location.reload(); return; }
        const users = u || {};
        names.forEach(n => {
            const el = document.getElementById(`user-${n}`);
            users[n] ? el.classList.add('taken') : el.classList.remove('taken');
        });
        if (myName && users[myName]) {
            if (!isRacingNow) switchPage('page-setup');
            if (!isAdmin) document.getElementById('label-user-name').innerText = myName;
            document.getElementById('btn-back').style.display = 'inline-flex';
        } else {
            switchPage('page-login');
            document.getElementById('btn-back').style.display = 'none';
        }
        updateAdminMonitor(users);
    });

    // --- assignments ---
    db.ref('assignments').on('value', snap => {
        const a = snap.val() || {};
        horseLibrary.forEach((_, i) => {
            const el    = document.getElementById(`slot-${i}`);
            const badge = document.getElementById(`owner-${i}`);
            const owner = Object.keys(a).find(k => a[k] === i);
            el.classList.remove('selected','occupied');
            if (owner) {
                badge.style.display = 'block';
                badge.innerText = `${owner} å·²é¸`;
                owner === myName ? el.classList.add('selected') : el.classList.add('occupied');
            } else { badge.style.display = 'none'; }
        });
    });

    // --- gameState / status only ---
    db.ref('gameState/status').on('value', snap => {
        const status = snap.val();
        if (status === 'racing') {
            isRacingNow = true;
            if (isAdmin) document.getElementById('admin-start-btn').style.display = 'none';
            db.ref('gameState').once('value', fullSnap => {
                const s = fullSnap.val();
                if (!s || s.status !== 'racing') return;
                switchPage('page-track');
                setupTrackLanes(s.raceData);
                startListeningSnapshot();
            });
        } else if (status === 'finished') {
            isRacingNow = false;
            db.ref('gameState/results').once('value', rSnap => {
                const results = rSnap.val();
                if (results) showLeaderboard(results);
            });
        } else {
            isRacingNow = false;
            if (isAdmin) document.getElementById('admin-start-btn').style.display = 'inline-flex';
            document.getElementById('leaderboard-overlay').style.display = 'none';
            stopListeningSnapshot();
            if (document.getElementById('page-track').classList.contains('active')) {
                setTimeout(() => location.reload(), 500);
            }
        }
    });
}

function updateAdminMonitor(users) {
    if (!isAdmin) return;
    db.ref('assignments').once('value', snap => {
        const a = snap.val() || {};
        document.getElementById('admin-status-grid').innerHTML =
            Object.keys(users).map(name =>
                `<span class="player-status-tag ${a[name] !== undefined ? 'ready' : ''}">${name}: ${a[name] !== undefined ? horseLibrary[a[name]].trait : "æœªé¸é¦¬"}</span>`
            ).join('');
    });
}

function switchPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.getElementById('header').style.display = (id === 'page-track') ? 'none' : 'flex';
}

// =====================================================================
// ADMIN â€” Game Loop
// =====================================================================
let adminLoopTimer = null;

function adminStart() {
    db.ref('assignments').once('value', snap => {
        const players = snap.val();
        if (!players) return alert("ç„¡äººåƒè³½ï¼");

        const raceData = {};
        Object.entries(players).forEach(([name, hIdx]) => {
            const h = horseLibrary[hIdx];
            const events = [];
            for (let j = 0; j < 3; j++) {
                const t    = 8 + (j * 8) + Math.random() * 5;
                const type = (Math.random() * 100 < h.stats.lck) ? 'burst' : 'slip';
                events.push({ t, type });
            }
            raceData[name] = { hIdx, events };
        });

        const startTime = Date.now() + serverOffset + 4000;
        db.ref('gameState').set({ status: 'racing', startTime, raceData });
        startAdminGameLoop(startTime, raceData);
    });
}

function startAdminGameLoop(startTime, raceData) {
    if (adminLoopTimer) clearInterval(adminLoopTimer);

    const runners = Object.entries(raceData).map(([name, data]) => ({
        name,
        stats: horseLibrary[data.hIdx].stats,
        events: data.events,
        progress: 0,
        stamina: 100,
        isRecovering: false,
        recoveryEndTime: 0,
        finished: false,
        finishTime: null,
        finishRank: null,        // â† å®Œæˆæ™‚çš„åæ¬¡ï¼ˆ1-basedï¼‰
        exhaustedUntil: 0,       // â† çˆ†è‚å‹•ç•«æŒçºŒåˆ°å¹¾ç§’ï¼ˆelapsed å–®ä½ï¼‰ï¼ŒæœŸé–“é–ä½ exhausted ç‹€æ…‹
        activeEffect: null
    }));

    let lastElapsed = -999;
    let finishedCount = 0;       // â† ç´¯è¨ˆå·²å®Œæˆäººæ•¸

    adminLoopTimer = setInterval(() => {
        const now     = Date.now() + serverOffset;
        const elapsed = (now - startTime) / 1000;

        if (elapsed < 0) { lastElapsed = elapsed; return; }

        const dt = (lastElapsed < 0) ? 0.1 : (elapsed - lastElapsed);
        lastElapsed = elapsed;

        runners.forEach(r => {
            if (r.finished) return;

            // --- æ¢å¾©ä¸­ ---
            if (r.isRecovering) {
                // çˆ†è‚å‹•ç•«æŒçºŒæœŸé–“ï¼šé–ä½ exhaustedï¼Œä¸åˆ‡åˆ° recovering
                if (elapsed < r.exhaustedUntil) {
                    r.activeEffect = 'exhausted';
                } else {
                    r.activeEffect = 'recovering';
                }
                if (elapsed >= r.recoveryEndTime) {
                    r.isRecovering = false;
                    r.stamina      = 100;
                    r.activeEffect = null;
                }
                return;
            }

            // --- è¨ˆç®— ---
            let spd   = (r.stats.spd / 100) * 0.035;
            let drain = (1.5 - r.stats.sta / 100) * 2.5;
            r.activeEffect = null;

            r.events.forEach(ev => {
                if (elapsed >= ev.t && elapsed <= ev.t + 1.5) {
                    if (ev.type === 'burst') {
                        spd   *= (1.5 + r.stats.burst / 100);
                        drain *= 5;
                        r.activeEffect = 'burst';
                    } else {
                        r.progress     = Math.max(0, r.progress - 0.012 * dt);
                        r.activeEffect = 'slip';
                    }
                }
            });

            r.progress += spd * dt;
            r.stamina   = Math.max(0, r.stamina - drain * dt);

            // é«”åŠ›è€—ç›¡
            if (r.stamina <= 0) {
                r.isRecovering      = true;
                r.recoveryEndTime   = elapsed + 5;
                r.exhaustedUntil    = elapsed + 1.5;   // â† çˆ†è‚å‹•ç•«å…ˆé– 1.5 ç§’
                r.activeEffect      = 'exhausted';
            }

            // åˆ°é”çµ‚é» â†’ è¨˜éŒ„åæ¬¡
            if (r.progress >= 1) {
                r.progress     = 1;
                r.finished     = true;
                r.finishTime   = elapsed;
                finishedCount++;
                r.finishRank   = finishedCount;   // â† å¹¾è™Ÿå®Œæˆå°±å¹¾å
                r.activeEffect = 'finished';
            }
        });

        // --- å¯«å¿«ç…§ ---
        const snapshot = {};
        runners.forEach(r => {
            snapshot[r.name] = {
                progress:            r.progress,
                stamina:             r.stamina,
                activeEffect:        r.activeEffect,
                isRecovering:        r.isRecovering,
                recoveryEndTime:     r.recoveryEndTime,
                recoverySecondsLeft: r.isRecovering ? Math.max(0, Math.ceil(r.recoveryEndTime - elapsed)) : 0,
                finished:            r.finished,
                finishTime:          r.finishTime,
                finishRank:          r.finishRank    // â† å‚³çµ¦ client
            };
        });
        db.ref('gameState/snapshot').set(snapshot);

        // --- å…¨éƒ¨è·‘å®Œ ---
        if (runners.every(r => r.finished)) {
            clearInterval(adminLoopTimer);
            adminLoopTimer = null;
            setTimeout(() => {
                const sorted  = [...runners].sort((a, b) => a.finishTime - b.finishTime);
                const results = sorted.map((r, i) => ({ name: r.name, finishTime: r.finishTime, rank: i + 1 }));
                db.ref('gameState').update({ status: 'finished', results });
            }, 1200);
        }
    }, 100);
}

function stopAdminGameLoop() { if (adminLoopTimer) { clearInterval(adminLoopTimer); adminLoopTimer = null; } }

function adminReset() {
    stopAdminGameLoop();
    stopListeningSnapshot();
    db.ref('users').remove();
    db.ref('assignments').remove();
    db.ref('gameState').set({ status: 'idle' });
}

// =====================================================================
// CLIENT â€” Snapshot Renderer
// =====================================================================
let snapshotListener = null;
let trackSetupDone   = false;
let playerOrder      = [];

function setupTrackLanes(raceData) {
    if (trackSetupDone) return;
    trackSetupDone = true;
    playerOrder = Object.keys(raceData);

    const area = document.getElementById('lanes-render-area');
    area.innerHTML = "";

    playerOrder.forEach((name, idx) => {
        const div = document.createElement('div');
        div.className = 'lane';
        div.innerHTML = `
            <div class="horse-pawn" id="pawn-${idx}">
                <div id="bubble-${idx}"></div>
                <div class="horse-visual" id="vis-${idx}">ğŸ</div>
                <div class="pawn-info">
                    <div class="pawn-name">${name}</div>
                    <div class="stamina-track"><div class="stamina-fill" id="stam-${idx}" style="width:100%"></div></div>
                </div>
            </div>`;
        area.appendChild(div);
    });
}

function startListeningSnapshot() {
    if (snapshotListener) return;

    db.ref('gameState/startTime').once('value', snap => {
        if (snap.val()) handleCountdown(snap.val());
    });

    snapshotListener = db.ref('gameState/snapshot').on('value', snap => {
        const snapshot = snap.val();
        if (snapshot) renderFromSnapshot(snapshot);
    });
}

function stopListeningSnapshot() {
    if (snapshotListener) { db.ref('gameState/snapshot').off('value', snapshotListener); snapshotListener = null; }
    trackSetupDone = false;
    playerOrder    = [];
}

// Countdown (client-local, cosmetic only)
function handleCountdown(startTime) {
    (function tick() {
        const rem = (startTime - (Date.now() + serverOffset)) / 1000;
        if (rem > 0) {
            const ov = document.getElementById('countdown-overlay');
            ov.style.display = 'flex';
            ov.innerText = rem > 3 ? "READY" : Math.ceil(rem);
            requestAnimationFrame(tick);
        } else {
            document.getElementById('countdown-overlay').style.display = 'none';
        }
    })();
}

// =====================================================================
// Core renderer â€” called every time a new snapshot arrives
// =====================================================================
function renderFromSnapshot(snapshot) {
    const area = document.getElementById('lanes-render-area');
    if (!area) return;
    const finishLineX = area.offsetWidth - 140;

    playerOrder.forEach((name, i) => {
        const data = snapshot[name];
        if (!data) return;

        const pawn     = document.getElementById(`pawn-${i}`);
        const vis      = document.getElementById(`vis-${i}`);
        const bub      = document.getElementById(`bubble-${i}`);
        const stamFill = document.getElementById(`stam-${i}`);
        if (!pawn || !vis || !bub || !stamFill) return;

        // Position
        pawn.style.left = (data.progress * finishLineX) + "px";

        // Stamina bar + colour
        stamFill.style.width = data.stamina + "%";
        stamFill.classList.toggle('low', data.stamina < 25);

        // Reset visual classes
        vis.className  = "horse-visual";
        bub.className  = "";
        bub.innerText  = "";

        switch (data.activeEffect) {
            // â”€â”€ è¡åˆº â”€â”€
            case 'burst':
                vis.classList.add('effect-sprint');
                bub.className  = "speech-bubble bubble-sprint";
                bub.innerText  = "ğŸ”¥ è¡åˆºï¼";
                break;

            // â”€â”€ æ»‘å€’ â”€â”€
            case 'slip':
                vis.classList.add('effect-slip');
                bub.className  = "speech-bubble bubble-danger";
                bub.innerText  = "â›¸ï¸ æ»‘å€’ï¼";
                break;

            // â”€â”€ é«”åŠ›è€—ç›¡ï¼ˆè§¸ç™¼é‚£ä¸€å¹€ï¼‰â”€â”€
            case 'exhausted':
                vis.classList.add('effect-exhausted');
                bub.className  = "speech-bubble bubble-danger";
                bub.innerText  = "ğŸ˜µ å·²çˆ†è‚ï¼";
                break;

            // â”€â”€ èººå¹³æ¢å¾©ä¸­ + å€’æ•¸ç§’æ•¸ â”€â”€
            case 'recovering':
                vis.classList.add('effect-exhausted');
                bub.className  = "speech-bubble bubble-recover";
                bub.innerText  = `ğŸ©¹ èººå¹³ä¸­ ${data.recoverySecondsLeft}s`;
                break;

            // â”€â”€ æŠµé”çµ‚é»ï¼šæ ¹æ“šåæ¬¡é¡¯ç¤ºå°æ‡‰è¡¨æƒ… â”€â”€
            case 'finished':
                const emoji = rankEmojis[(data.finishRank || 1) - 1] || "ğŸ";
                bub.className  = "speech-bubble bubble-finish";
                bub.innerText  = emoji;
                break;
        }
    });
}

// =====================================================================
// Leaderboard
// =====================================================================
function showLeaderboard(results) {
    document.getElementById('leaderboard-overlay').style.display = 'flex';

    const medalClass = i => i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';

    document.getElementById('rankings-list').innerHTML = results.map((r, i) =>
        `<div class="rank-row">
            <div class="rank-row-left">
                <div class="rank-badge ${medalClass(i)}">#${i+1}</div>
                <span class="rank-name">${rankEmojis[i] || ""} ${r.name}</span>
            </div>
         </div>`
    ).join('');
}

// =====================================================================
init();
</script>
</body>
</html>
