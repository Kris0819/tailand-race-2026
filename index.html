<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT è³½é¦¬ - PO æ——è‰¦ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --primary: #d32f2f; --gold: #ffd700; --track-bg: #1a1a1a; 
            --success: #4caf50; --warning: #ffeb3b; --danger: #ff5252; 
            --recover: #00bcd4; --sprint: #ff5722; --card-bg: #252525;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: #0f0f0f; color: white; margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        #admin-panel { background: rgba(211, 47, 47, 0.95); padding: 10px; display: none; border-bottom: 2px solid var(--gold); z-index: 1000; }
        .admin-flex { display: flex; justify-content: space-between; align-items: center; max-width: 600px; margin: 0 auto; }

        header { padding: 12px 10px; text-align: center; background: linear-gradient(to bottom, #222, #0f0f0f); z-index: 10; position: relative; }
        h2 { margin: 0; color: var(--gold); font-size: 1.2rem; letter-spacing: 2px; }

        .container { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; align-items: center; }

        /* èº«åˆ†æ¬„ */
        .identity-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; display: none; }
        .user-badge { background: var(--success); color: white; padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; }
        .change-btn { background: #444; color: #ccc; border: none; padding: 5px 10px; border-radius: 15px; font-size: 11px; }

        /* é¸é¦¬å€èƒ½åŠ›æ¢ */
        .horse-slot { background: var(--card-bg); border-radius: 12px; padding: 15px; border: 2px solid #333; position: relative; display: flex; align-items: center; gap: 12px; width: 100%; max-width: 400px; margin-bottom: 10px; }
        .horse-slot.occupied { opacity: 0.3; filter: grayscale(1); pointer-events: none; }
        .horse-slot.my-pick { border-color: var(--success); background: #1b2e1c; }
        .stat-container { flex: 1; }
        .stat-row { display: flex; align-items: center; gap: 8px; font-size: 10px; margin: 2px 0; }
        .stat-bar { flex: 1; height: 4px; background: #444; border-radius: 2px; overflow: hidden; }
        .stat-fill { height: 100%; background: var(--gold); }

        /* è³½é“ */
        .track-container { width: 100vw; flex: 1; background: var(--track-bg); display: none; position: relative; overflow-x: hidden; padding-top: 45px; }
        .finish-line { position: absolute; right: 12%; top: 0; bottom: 0; width: 15px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); border-left: 2px solid var(--gold); }
        .lane { position: relative; border-bottom: 1px solid rgba(255,255,255,0.05); height: 75px; display: flex; align-items: center; width: 100%; }
        
        /* é¦¬åŒ¹å®¹å™¨ */
        .horse-container { position: absolute; left: 0%; z-index: 10; display: flex; flex-direction: column; align-items: center; width: 80px; transition: left 0.1s linear; }
        .horse-icon { font-size: 32px; transform: scaleX(-1); }
        .owner-name { font-size: 10px; font-weight: bold; background: rgba(0,0,0,0.6); padding: 1px 4px; border-radius: 3px; margin-bottom: 2px; }
        
        /* æ¯”è³½ä¸­é«”åŠ›æ¢ */
        .live-stamina { width: 40px; height: 4px; background: #222; border-radius: 2px; overflow: hidden; border: 1px solid #444; }
        .live-stamina-fill { height: 100%; background: var(--success); width: 100%; transition: width 0.2s; }

        /* çµ‚é»ç‰¹æ•ˆ */
        .horse-container.finished-pop { animation: finish-effect 0.6s ease-out forwards; z-index: 100; }
        @keyframes finish-effect {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1.2); }
        }
        .trophy { position: absolute; top: -20px; font-size: 20px; animation: trophy-float 1s infinite; display: none; }
        @keyframes trophy-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .status-bubble { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); font-size: 10px; padding: 3px 8px; border-radius: 10px; font-weight: bold; white-space: nowrap; z-index: 100; }

        #start-btn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 15px 50px; font-size: 18px; background: var(--primary); color: white; border: none; border-radius: 30px; font-weight: bold; z-index: 500; display: none; }
        #leaderboard { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .win-card { background: white; color: #111; border-radius: 20px; padding: 20px; width: 100%; max-width: 380px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="admin-panel">
        <div class="admin-flex">
            <div style="font-size:12px;">ğŸ“Š æº–å‚™ä¸­: <span id="ready-count">0</span></div>
            <button class="change-btn" style="background:white; color:red;" onclick="hardReset()">ç¡¬é‡ç½®éŠæˆ²</button>
        </div>
    </div>

    <header><h2>ğŸ 2026 AIOT è³½é¦¬</h2></header>

    <div class="container">
        <div id="identity-area" class="identity-bar">
            <div id="user-badge" class="user-badge"></div>
            <button class="change-btn" onclick="logout()">æ›´æ›èº«ä»½</button>
        </div>

        <div id="user-login">
            <h3 style="text-align:center; color: var(--gold);">è«‹é¸æ“‡æ‚¨çš„å§“å</h3>
            <div class="name-grid" id="name-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;"></div>
        </div>

        <div id="setup" class="setup-area">
            <h3 style="text-align: center;">æŒ‘é¸æˆ°é¦¬</h3>
            <div id="select-grid"></div>
        </div>
    </div>

    <button id="start-btn">ğŸ çœ¾é¦¬å¥”é¨°ï¼Œé–‹è³½ï¼</button>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box"></div>
    </div>

    <div id="leaderboard">
        <div class="win-card">
            <h2 style="text-align:center; color: var(--primary); margin:0 0 15px 0;">ğŸŠ æ¯”è³½çµæœ ğŸŠ</h2>
            <div id="leaderboard-list"></div>
            <button onclick="hardReset()" style="width:100%; padding:15px; margin-top:20px; background: #1a1a1a; color: white; border: none; border-radius: 12px; font-weight: bold;">å›é¦–é </button>
        </div>
    </div>

    <audio id="bgm" loop src="https://vgmsite.com/soundtracks/super-mario-kart-snes/oyurkqog/13%20-%20Course%20Intro%20%26%20Race%20Start.mp3"></audio>
    <audio id="snd-start" src="https://www.soundjay.com/misc/sounds/starting-pistol-1.mp3"></audio>
    <audio id="snd-win" src="https://www.soundjay.com/human/sounds/applause-01.mp3"></audio>

<script>
    // --- 1. Firebase é…ç½® (å·²å¥—ç”¨æ‚¨çš„é…ç½®) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. æ•¸æ“š ---
    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95}, desc: "æ‡‚å¾—æ‘¸é­šç¯€çœé«”åŠ›ï¼Œç©©å®šæ€§é«˜ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65}, desc: "çµ‚é»è¡åˆºåŠ›é‡å¼·å¤§ã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25}, desc: "èµ·æ­¥è¶…å¿«ï¼Œä½†é«”åŠ›æ¶ˆè€—åŠ‡çƒˆã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60}, desc: "å„é …æ•¸å€¼å¹³å‡ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45}, desc: "é«”åŠ›æ³¢å‹•å¤§ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85}, desc: "å…ç–«æ»‘å€’äº‹ä»¶ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90}, desc: "è€åŠ›åè¶³ï¼Œé»˜é»˜æ”€å‡ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70}, desc: "æœ€å¾Œä¸€ç§’å®¹æ˜“å¤§çˆ†ç™¼ã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50}, desc: "é«˜æ•ˆç‡ä»£è¡¨ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75}, desc: "æ•¸æ“šå¹³è¡¡ä¹‹ç‹ã€‚" }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
    let raceStarted = false;
    let finishedHorses = [];
    
    const VIRTUAL_FINISH = 1000;
    const TIME_STEP = 50;       
    const SPEED_SCALE = 0.58; // ç´„ 500 Frames (25ç§’) å®Œè³½

    function init() {
        const savedName = localStorage.getItem('aiot_race_name');
        if (isAdmin) { document.getElementById('start-btn').style.display = 'block'; document.getElementById('admin-panel').style.display = 'block'; }
        
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn'; btn.id = `name-${n}`; btn.innerText = n;
            btn.style.height = '50px'; btn.style.background = '#2a2a2a'; btn.style.color='white'; btn.style.borderRadius='12px'; btn.style.border='1px solid #444';
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        const selectGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot'; div.id = `slot-${i}`;
            div.innerHTML = `
                <div style="font-size:28px; transform: scaleX(-1);">ğŸ</div>
                <div class="stat-container">
                    <div style="font-weight:bold; color:var(--gold); font-size:14px;">${h.trait}</div>
                    <div class="stat-row">æ•ˆç‡ <div class="stat-bar"><div class="stat-fill" style="width:${h.stats.spd}%"></div></div></div>
                    <div class="stat-row">é«”åŠ› <div class="stat-bar"><div class="stat-fill" style="width:${h.stats.sta}%"></div></div></div>
                    <div class="horse-desc">${h.desc}</div>
                </div>`;
            div.onclick = () => selectHorse(i);
            selectGrid.appendChild(div);
        });
        listenFirebase();
        if (savedName) login(savedName);
    }

    function listenFirebase() {
        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (state && state.status === 'racing' && !raceStarted) startTheGame(state.seed, state.participants);
        });
        db.ref('users').on('value', snap => {
            const users = snap.val() || {};
            let count = 0;
            names.forEach(n => {
                const btn = document.getElementById(`name-${n}`);
                if (users[n]) { 
                    count++; btn.style.opacity = '0.2'; btn.style.pointerEvents = 'none';
                    if (n === myName) { 
                        document.getElementById('user-login').style.display = 'none'; 
                        document.getElementById('setup').style.display = 'block'; 
                        document.getElementById('identity-area').style.display = 'flex';
                        document.getElementById('user-badge').innerText = `ğŸ‘¤ æ‚¨æ˜¯ï¼š${n}`;
                    } 
                } else { btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; }
            });
            if(isAdmin) document.getElementById('ready-count').innerText = count;
        });
        db.ref('assignments').on('value', snap => {
            const assignments = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`slot-${i}`); slot.classList.remove('occupied', 'my-pick');
                const owner = Object.keys(assignments).find(name => assignments[name] === i);
                if (owner) { if (owner === myName) slot.classList.add('my-pick'); else slot.classList.add('occupied'); }
            });
        });
    }

    function login(n) { myName = n; localStorage.setItem('aiot_race_name', n); db.ref(`users/${n}`).set(true); document.getElementById('bgm').play().catch(()=>{}); }
    function logout() { if (confirm("æ›´æ›èº«ä»½ï¼Ÿ")) { db.ref(`users/${myName}`).remove(); db.ref(`assignments/${myName}`).remove(); localStorage.removeItem('aiot_race_name'); location.reload(); } }
    function hardReset() { if (confirm("é‡ç½®éŠæˆ²ï¼Ÿ")) { db.ref().set(null); localStorage.removeItem('aiot_race_name'); location.reload(); } }
    function selectHorse(idx) { if (myName) db.ref(`assignments/${myName}`).set(idx); }

    document.getElementById('start-btn').onclick = function() {
        db.ref('assignments').once('value', snap => {
            const p = snap.val() || {};
            if (Object.keys(p).length < 1) return alert("æ²’äººé¸é¦¬ï¼");
            db.ref('gameState').set({ status: 'racing', seed: Math.random(), participants: p });
        });
    };

    function startTheGame(seed, participants) {
        raceStarted = true;
        document.getElementById('setup').style.display = 'none';
        document.getElementById('identity-area').style.display = 'none';
        document.getElementById('track').style.display = 'block';
        document.getElementById('snd-start').play();

        const lanesBox = document.getElementById('lanes-box'); lanesBox.innerHTML = "";
        const list = Object.keys(participants).map((name, idx) => ({ name, horseData: horseLibrary[participants[name]], color: ["#FF5252","#FFD700","#E040FB","#00E676","#2979FF","#FF9100","#40C4FF","#FF1744","#F4FF81","#B2FF59"][idx%10] }));
        
        list.forEach(item => {
            const lane = document.createElement('div'); lane.className = 'lane';
            lane.innerHTML = `
                <div class="horse-container" id="horse-${item.horseData.id}">
                    <div class="trophy" id="trophy-${item.horseData.id}">ğŸ†</div>
                    <div class="status-bubble" id="status-${item.horseData.id}" style="display:none;"></div>
                    <div class="owner-name">${item.name}</div>
                    <div class="horse-icon" style="color:${item.color}">ğŸ</div>
                    <div class="live-stamina"><div class="live-stamina-fill" id="live-sta-${item.horseData.id}"></div></div>
                </div>`;
            lanesBox.appendChild(lane);
        });
        runRaceEngine(seed, list);
    }

    function runRaceEngine(seed, list) {
        let seedVal = seed;
        const syncRand = () => { seedVal = (seedVal * 9301 + 49297) % 233280; return seedVal / 233280; };
        const horses = list.map(item => ({ ...item.horseData, ownerName: item.name, pos: 0, speed: 0, currStamina: 100, lastEventTime: Date.now(), nextCooldown: 2000, finished: false, isStalled: false }));
        
        const timer = setInterval(() => {
            const elapsed = (Date.now()) / 1000;
            horses.forEach(h => {
                if (h.finished) return;
                
                // é«”åŠ›æ¶ˆè€—
                if (!h.isStalled) h.currStamina = Math.max(0, h.currStamina - (h.speed * 0.05 + 0.12));
                const staBar = document.getElementById(`live-sta-${h.id}`);
                if(staBar) {
                    staBar.style.width = h.currStamina + "%";
                    staBar.style.background = h.currStamina < 25 ? 'var(--danger)' : (h.currStamina < 50 ? 'var(--warning)' : 'var(--success)');
                }

                if (h.currStamina <= 0 && !h.isStalled) {
                    h.speed = 0; h.isStalled = true;
                    updateBubble(h.id, "ğŸ¤® çˆ†è‚!", "var(--danger)");
                    setTimeout(() => { h.currStamina = 100; h.isStalled = false; updateBubble(h.id,"","",false); }, 3000);
                }
                
                if (!h.isStalled) {
                    let acc = syncRand() * 0.45; 
                    if (h.id === 1 && h.pos > 700) acc += 5.0; // ä¸‹ç­æˆ°ç¥è¡åˆº
                    h.speed = ((h.speed * 0.9) + acc + (h.stats.spd * 0.005)) * SPEED_SCALE;
                }

                if (Date.now() - h.lastEventTime > h.nextCooldown && !h.isStalled) {
                    h.lastEventTime = Date.now(); h.nextCooldown = 2000 + syncRand()*3000;
                    if (syncRand() < 0.15 && h.id !== 5) { 
                        h.speed = 0; h.pos = Math.max(0, h.pos - 40); updateBubble(h.id, "â›¸ï¸ æ»‘å€’!", "#546e7a"); 
                        setTimeout(() => updateBubble(h.id,"","",false), 1200); 
                    }
                }
                
                h.pos += h.speed;
                const visualLeft = Math.min((h.pos / VIRTUAL_FINISH) * 80, 88); 
                const el = document.getElementById(`horse-${h.id}`);
                if (el) el.style.left = visualLeft + '%';

                if (h.pos >= VIRTUAL_FINISH && !h.finished) { 
                    h.finished = true; finishedHorses.push(h); 
                    el.classList.add('finished-pop');
                    document.getElementById(`trophy-${h.id}`).style.display = 'block';
                    if (finishedHorses.length === 1) document.getElementById('snd-win').play();
                    if (finishedHorses.length === list.length) { clearInterval(timer); setTimeout(showLeaderboard, 1500); } 
                }
            });
        }, TIME_STEP);
    }

    function updateBubble(id, text, color, display = true) {
        const el = document.getElementById(`status-${id}`); if (el) { el.innerText = text; el.style.display = display ? 'block' : 'none'; el.style.background = color; }
    }

    function showLeaderboard() {
        document.getElementById('leaderboard').style.display = 'flex';
        const listEl = document.getElementById('leaderboard-list');
        listEl.innerHTML = "";
        
        finishedHorses.forEach((h, i) => {
            const rank = i + 1;
            let prize = "";
            if (rank === 1) prize = "2500 ç¾é‡‘";
            else if (rank <= 5) prize = "1000 æ–°å…‰ç¦®åˆ¸";
            else if (rank === 6) prize = "500";
            else if (rank === 7) prize = "400";
            else if (rank === 8) prize = "300";
            else if (rank === 9) prize = "200";
            else prize = "100";

            const div = document.createElement('div');
            div.style.cssText = `padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; ${rank===1?'background:#fffde7; border:2px solid gold; border-radius:10px;':''}`;
            div.innerHTML = `<span style="font-weight:bold;">${rank}. ${h.ownerName}</span><span style="color:var(--primary); font-weight:bold;">${prize}</span>`;
            listEl.appendChild(div);
        });
    }
    init();
</script>
</body>
</html>
