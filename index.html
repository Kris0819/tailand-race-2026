<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬åŒæ­¥ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --gold: #FFD700; --red: #ff4757; --dark: #121212; 
            --card: #1e1e1e; --success: #2ed573; --accent: #00E5FF;
        }
        * { box-sizing: border-box; font-family: -apple-system, 'PingFang TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--dark); color: white; margin: 0; padding-bottom: env(safe-area-inset-bottom); overflow-x: hidden; }

        /* ç®¡ç†å“¡æ§åˆ¶å° */
        #admin-panel { 
            background: var(--red); padding: 10px; text-align: center; 
            position: sticky; top: 0; z-index: 1000; display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .admin-btn { background: white; color: var(--red); border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; margin: 0 5px; font-size: 14px; }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .header { text-align: center; padding: 20px 0; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .header h1 { color: var(--gold); margin: 0; font-size: 24px; letter-spacing: 2px; }
        
        /* å§“åé¸æ“‡å€ */
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .name-btn { 
            padding: 20px 10px; background: #2f3542; border: 2px solid transparent; color: white; 
            border-radius: 12px; font-size: 16px; font-weight: bold; transition: 0.2s;
        }
        .name-btn.taken { background: #1a1a1a; color: #444; pointer-events: none; border-color: transparent; }
        .name-btn.me { border-color: var(--success); background: #1a2e23; color: var(--success); }

        /* é¸é¦¬å¡ç‰‡ */
        .horse-list { display: grid; gap: 15px; }
        .horse-card {
            background: var(--card); border-radius: 16px; padding: 18px;
            border: 2px solid #333; position: relative; transition: 0.3s;
        }
        .horse-card.selected { border-color: var(--success); background: #1a2e23; box-shadow: 0 0 15px rgba(46, 213, 115, 0.2); }
        .horse-card.occupied { opacity: 0.5; filter: grayscale(0.8); pointer-events: none; }
        
        .occupant-tag {
            position: absolute; top: -10px; right: 10px;
            background: var(--gold); color: black; padding: 4px 10px;
            border-radius: 20px; font-size: 11px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .stat-group { margin-top: 12px; }
        .stat-row { display: flex; align-items: center; margin-bottom: 6px; }
        .stat-label { width: 35px; font-size: 11px; color: #aaa; }
        .stat-bar-bg { flex: 1; height: 6px; background: #000; border-radius: 3px; overflow: hidden; }
        .stat-fill { height: 100%; border-radius: 3px; transition: width 1s cubic-bezier(0.1, 0.7, 0.1, 1); }

        /* è³½é“ - æ‰‹æ©Ÿå‚ç›´å„ªåŒ– */
        #track { display: none; height: 100vh; background: #111; position: relative; }
        .lane { position: relative; width: 100%; border-bottom: 1px dashed #333; display: flex; align-items: center; }
        .horse-sprite { position: absolute; width: 60px; transition: left 0.1s linear; z-index: 10; text-align: center; }
        .finish-gate { position: absolute; right: 60px; top: 0; bottom: 0; width: 15px; background: repeating-linear-gradient(0deg, #fff 0 10px, #000 10px 20px); opacity: 0.3; }

        /* æ’è¡Œæ¦œ */
        #leaderboard { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 2000; display: none;
            padding: 40px 20px; text-align: center;
        }
        .rank-item { background: #222; margin: 10px 0; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; font-size: 18px; }
    </style>
</head>
<body>

    <div id="admin-panel">
        <button class="admin-btn" onclick="resetGame()">ğŸ§¹ å…¨å ´é‡ç½®</button>
        <button class="admin-btn" onclick="startRaceEngine()">ğŸ é–‹è³½</button>
    </div>

    <div id="view-login" class="container">
        <div class="header">
            <h1>2026 AIOT è³½é¦¬</h1>
            <p style="color: #666; font-size: 14px;">è«‹é¸æ“‡æ‚¨çš„åå­—ç™»å…¥</p>
        </div>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="view-setup" class="container" style="display:none;">
        <div class="header">
            <h1 id="welcome-msg">æŒ‘é¸æˆ°é¦¬</h1>
            <p style="color: var(--gold); font-size: 14px;">æ¯åŒ¹é¦¬åƒ…é™ä¸€äººé¨ä¹˜</p>
        </div>
        <div class="horse-list" id="horse-list"></div>
    </div>

    <div id="track">
        <div class="finish-gate"></div>
        <div id="lanes-container" style="height:100%;"></div>
    </div>

    <div id="leaderboard">
        <h1 style="color:var(--gold);">GAMES OVER</h1>
        <div id="rank-list"></div>
        <button onclick="location.reload()" style="width:100%; margin-top:30px; padding:15px; background:white; border-radius:10px; font-weight:bold;">è¿”å›</button>
    </div>

<script>
    // --- Firebase é…ç½® ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", spd: 55, sta: 95, color: "#2ed573", desc: "é«”åŠ›æ¥µä½³ï¼Œè·‘å¾—æ…¢ä½†ä¸åœæ­‡" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", spd: 45, sta: 60, color: "#ffa502", desc: "çœ‹åˆ°çµ‚é»æœƒç¬é–“çˆ†ç™¼åŠ é€Ÿ" },
        { id: 2, trait: "çˆ†è‚ç‹", spd: 95, sta: 20, color: "#ff4757", desc: "åˆæœŸæ¥µé€Ÿï¼Œä½†å¾ŒåŠæ®µå®¹æ˜“éç†±" },
        { id: 3, trait: "å’–å•¡ä¸­æ¯’", spd: 75, sta: 45, color: "#1e90ff", desc: "é€Ÿåº¦èµ·ä¼æ¥µå¤§ï¼Œå‹è² çœ‹é‹æ°£" },
        { id: 4, trait: "ç”©é‹å°ˆå®¶", spd: 65, sta: 75, color: "#eccc68", desc: "æ•¸æ“šå¹³è¡¡ï¼Œç„¡è¦–ä»»ä½•æ¸›é€Ÿéšœç¤™" }
    ];

    const names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = localStorage.getItem('aiot_user_2026') || ""; 
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';

    function init() {
        if (isAdmin) document.getElementById('admin-panel').style.display = 'block';

        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn'; btn.id = `user-btn-${n}`; btn.innerText = n;
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        const list = document.getElementById('horse-list');
        horseLibrary.forEach((h, i) => {
            const card = document.createElement('div');
            card.className = 'horse-card'; card.id = `h-card-${i}`;
            card.innerHTML = `
                <div id="tag-${i}"></div>
                <div style="font-size:20px; font-weight:bold; color:var(--gold);">${h.trait}</div>
                <div style="font-size:12px; color:#888;">${h.desc}</div>
                <div class="stat-group">
                    <div class="stat-row"><span class="stat-label">æ•ˆç‡</span><div class="stat-bar-bg"><div class="stat-fill" style="width:${h.spd}%; background:${h.color};"></div></div></div>
                    <div class="stat-row"><span class="stat-label">é«”åŠ›</span><div class="stat-bar-bg"><div class="stat-fill" style="width:${h.sta}%; background:#444;"></div></div></div>
                </div>
            `;
            card.onclick = () => selectHorse(i);
            list.appendChild(card);
        });

        syncFirebase();
    }

    function syncFirebase() {
        // 1. ä½¿ç”¨è€…ç‹€æ…‹èˆ‡è‡ªå‹•æ¢å¾©
        db.ref('users').on('value', snap => {
            const data = snap.val() || {};
            
            // å¦‚æœæœ¬åœ°æœ‰åå­—ä½†è³‡æ–™åº«æ²’äº†ï¼Œä»£è¡¨è¢«ç®¡ç†å“¡é‡ç½®
            if (myName && !data[myName]) {
                localStorage.removeItem('aiot_user_2026');
                myName = "";
                location.reload();
                return;
            }

            names.forEach(n => {
                const btn = document.getElementById(`user-btn-${n}`);
                if (data[n]) {
                    btn.classList.add('taken');
                    if (n === myName) btn.classList.add('me');
                } else {
                    btn.classList.remove('taken', 'me');
                }
            });

            if (myName && data[myName]) {
                document.getElementById('view-login').style.display = 'none';
                document.getElementById('view-setup').style.display = 'block';
                document.getElementById('welcome-msg').innerText = `ä½ å¥½ï¼Œ${myName}`;
            }
        });

        // 2. é¸é¦¬ç‹€æ…‹èˆ‡é¨å£«é¡¯ç¤º
        db.ref('assignments').on('value', snap => {
            const data = snap.val() || {};
            document.querySelectorAll('.horse-card').forEach(c => {
                c.classList.remove('occupied', 'selected');
                const tag = c.querySelector('[id^="tag-"]');
                if(tag) tag.innerHTML = '';
            });

            Object.entries(data).forEach(([user, horseIdx]) => {
                const card = document.getElementById(`h-card-${horseIdx}`);
                const tag = document.getElementById(`tag-${horseIdx}`);
                if(card) {
                    if (user === myName) {
                        card.classList.add('selected');
                        tag.innerHTML = `<span class="occupant-tag">ä½ çš„æˆ°é¦¬</span>`;
                    } else {
                        card.classList.add('occupied');
                        tag.innerHTML = `<span class="occupant-tag">é¨å£«: ${user}</span>`;
                    }
                }
            });
        });

        // 3. æ¯”è³½é€²åº¦çœŸåŒæ­¥
        db.ref('raceData/positions').on('value', snap => {
            const posData = snap.val();
            if (!posData) return;
            
            if (document.getElementById('track').style.display === 'none') {
                showTrackUI(Object.keys(posData));
            }

            Object.entries(posData).forEach(([hIdx, leftPos]) => {
                const el = document.getElementById(`horse-box-${hIdx}`);
                if (el) el.style.left = `${leftPos}%`;
            });
        });

        // 4. æ¯”è³½çµæœ
        db.ref('raceData/results').on('value', snap => {
            if (snap.val()) showLeaderboard(snap.val());
        });
    }

    function login(n) {
        db.ref(`users/${n}`).once('value', snap => {
            if (snap.val()) {
                alert("è©²èº«åˆ†å·²è¢«ç™»å…¥");
            } else {
                myName = n;
                localStorage.setItem('aiot_user_2026', n);
                db.ref(`users/${n}`).set(true);
            }
        });
    }

    function selectHorse(idx) {
        if (!myName) return;
        db.ref('assignments').once('value', snap => {
            const data = snap.val() || {};
            const isTaken = Object.values(data).includes(idx);
            if (isTaken && data[myName] !== idx) {
                alert("æ…¢äº†ä¸€æ­¥ï¼");
            } else {
                db.ref(`assignments/${myName}`).set(idx);
            }
        });
    }

    function showTrackUI(activeHorseIds) {
        document.getElementById('view-setup').style.display = 'none';
        document.getElementById('track').style.display = 'block';
        const container = document.getElementById('lanes-container');
        container.innerHTML = '';

        db.ref('assignments').once('value', snap => {
            const assigns = snap.val() || {};
            activeHorseIds.forEach(hid => {
                const owner = Object.keys(assigns).find(k => assigns[k] == hid);
                const lane = document.createElement('div');
                lane.className = 'lane'; lane.style.height = `${100/activeHorseIds.length}%`;
                lane.innerHTML = `
                    <div class="horse-sprite" id="horse-box-${hid}" style="left:0;">
                        <div style="font-size:10px; color:#aaa;">${owner}</div>
                        <div style="font-size:30px;">ğŸ</div>
                    </div>
                `;
                container.appendChild(lane);
            });
        });
    }

    // --- ç®¡ç†å“¡å¼•æ“ ---
    function resetGame() {
        if (confirm("ç¢ºå®šé‡ç½®å…¨å ´ï¼Ÿæ‰€æœ‰äººå°‡è·³å›ç™»å…¥é ã€‚")) {
            db.ref().set(null).then(() => {
                localStorage.removeItem('aiot_user_2026');
                location.reload();
            });
        }
    }

    function startRaceEngine() {
        db.ref('assignments').once('value', snap => {
            const assigns = snap.val();
            if (!assigns) return alert("æ²’äººé¸é¦¬ï¼");
            
            const horseIds = Object.values(assigns);
            const states = horseIds.map(id => ({ id, pos: 0, speed: 0.5 + Math.random(), finished: false }));
            
            const raceTimer = setInterval(() => {
                const updates = {};
                let allDone = true;
                
                states.forEach(s => {
                    if (!s.finished) {
                        s.pos += (Math.random() * 2); 
                        if (s.pos >= 85) { s.pos = 85; s.finished = true; }
                        else allDone = false;
                    }
                    updates[s.id] = s.pos;
                });

                db.ref('raceData/positions').set(updates);
                if (allDone) {
                    clearInterval(raceTimer);
                    const finalRanks = states.sort((a,b) => b.pos - a.pos).map((s, i) => {
                        const owner = Object.keys(assigns).find(k => assigns[k] == s.id);
                        return { rank: i+1, name: owner };
                    });
                    db.ref('raceData/results').set(finalRanks);
                }
            }, 100);
        });
    }

    function showLeaderboard(results) {
        const list = document.getElementById('rank-list');
        list.innerHTML = '';
        results.forEach(r => {
            const div = document.createElement('div');
            div.className = 'rank-item';
            div.innerHTML = `<span>ç¬¬ ${r.rank} å</span><b>${r.name}</b>`;
            list.appendChild(div);
        });
        document.getElementById('leaderboard').style.display = 'block';
    }

    init();
</script>
</body>
</html>
