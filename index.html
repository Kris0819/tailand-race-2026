<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - æ¬Šå¨åŒæ­¥ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #d32f2f; --gold: #ffd700; --silver: #c0c0c0; --bronze: #cd7f32; --track-bg: #2c3e50; --success: #4caf50; --danger: #ff5252; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: #121212; color: white; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        
        /* ç®¡ç†å“¡æ§åˆ¶å° */
        #admin-panel { position: fixed; bottom: 20px; right: 15px; background: #1a2a3a; border: 2px solid var(--gold); padding: 12px; border-radius: 15px; z-index: 9999; display: none; min-width: 180px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .admin-btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 8px; }

        /* é¸é¦¬å€ */
        .setup-area { background: #1e1e1e; padding: 15px; border-radius: 20px; width: 95vw; max-width: 1000px; border: 1px solid #444; display: none; overflow-y: auto; max-height: 80vh; margin-top: 10px; }
        .horse-select-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .horse-slot { background: #252525; padding: 10px; border-radius: 12px; border: 2px solid #333; position: relative; }
        .horse-slot.my-pick { border-color: var(--success); background: #1b2e1b; }
        .horse-slot.occupied { opacity: 0.3; filter: grayscale(1); }
        .occupied-label { position: absolute; top: 40%; left: 0; width: 100%; background: var(--primary); font-size: 11px; text-align: center; transform: rotate(-15deg); z-index: 5; }
        .stat-row { display: flex; align-items: center; margin-top: 2px; font-size: 9px; }
        .stat-bar { flex-grow: 1; height: 3px; background: #000; border-radius: 2px; margin-left: 5px; overflow: hidden; }
        .stat-fill { height: 100%; background: var(--gold); }
        .horse-desc { font-size: 9px; color: #aaa; margin-top: 5px; line-height: 1.2; font-style: italic; }

        /* è³½é“å€ */
        .track-container { position: relative; width: 100vw; flex-grow: 1; background: var(--track-bg); display: none; overflow: hidden; }
        .finish-line { position: absolute; right: 60px; top: 0; bottom: 0; width: 20px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); border-left: 2px solid var(--gold); }
        .lane { position: relative; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .horse-container { position: absolute; left: 5px; display: flex; align-items: center; transition: left 0.1s linear; top: 50%; transform: translateY(-50%); }
        .horse-icon { font-size: 24px; transform: scaleX(-1); }
        .status-bubble { position: absolute; top: -20px; left: 0; background: white; color: black; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: bold; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.3s; }

        #leaderboard { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background: white; color: #111; border-radius: 20px; padding: 20px; z-index: 10000; display: none; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
    </style>
</head>
<body>

    <h3 style="margin: 10px; color: var(--gold);">ğŸ AIOT 2026 å°¾ç‰™è³½é¦¬</h3>

    <div id="user-login" style="background:#1e1e1e; padding:20px; border-radius:20px; position:fixed; top:50%; transform:translateY(-50%); width:85%; border:2px solid var(--gold);">
        <h2 style="text-align:center; color:var(--gold);">ç™»å…¥åƒè³½</h2>
        <div class="name-grid" id="name-grid" style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px;"></div>
    </div>

    <div id="setup" class="setup-area">
        <button onclick="goBackToLogin()" style="background:#444; color:#ccc; border:none; padding:5px 10px; border-radius:5px; font-size:12px; margin-bottom:10px;">â¬… æ›´æ›è§’è‰²</button>
        <div id="picker-info" style="color:var(--gold); font-weight:bold; margin-bottom:10px;"></div>
        <div class="horse-select-grid" id="select-grid"></div>
    </div>

    <div id="admin-panel">
        <div id="admin-ready-count" style="font-size:12px; color:var(--gold);">å°±ç·’: 0/10</div>
        <button id="start-btn" class="admin-btn" style="background:var(--success); color:white;">ğŸ ç«‹å³é–‹è³½</button>
        <button onclick="resetFullGame()" class="admin-btn" style="background:var(--danger); color:white;">ğŸ”¥ å…¨å±€é‡ç½®</button>
    </div>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height:100%; display:flex; flex-direction:column;"></div>
    </div>

    <div id="leaderboard">
        <h2 style="text-align:center; color:var(--primary);">ğŸ† è‹±é›„æ¦œ</h2>
        <div id="leaderboard-list"></div>
        <button onclick="resetFullGame()" style="width:100%; padding:12px; margin-top:15px; background:#333; color:white; border:none; border-radius:8px;">é‡æ–°é–‹å§‹</button>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, bst: 40, lck: 70}, desc: "æ“…é•·åœ¨ä¸»ç®¡è¦–ç·šå¤–ç·©æ­¥å‰é€²ï¼Œé«”åŠ›æ·±ä¸å¯æ¸¬ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65, bst: 95, lck: 60}, desc: "å¹³æ—¥ç¯€èƒ½ï¼Œå¤•é™½è¥¿ä¸‹ä¾¿é–‹å•Ÿè¶…é »æ¨¡å¼ã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, bst: 80, lck: 30}, desc: "èµ·æ­¥å³å·”å³°ï¼Œä½†éœ€æ³¨æ„å¥åº·è­¦è¨Šã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60, bst: 60, lck: 80}, desc: "ç¯€å¥æ„Ÿæ¥µå¼·ï¼Œèƒ½ä»¥ç©©å®šèªé€Ÿå£“åˆ¶å…¨å ´ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, bst: 75, lck: 50}, desc: "ä¾è³´èˆˆå¥®åŠ‘ï¼Œé€Ÿåº¦å–æ±ºæ–¼æ‹¿éµæ¿ƒåº¦ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, bst: 30, lck: 99}, desc: "ç¥ç´šé–ƒé¿ï¼Œä»»ä½•éšœç¤™èˆ‡è²¬ä»»éƒ½ç¢°ä¸åˆ°ç‰ ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, bst: 50, lck: 60}, desc: "æ²’äººæ³¨æ„åˆ°ç‰ å·²æ‚„æ‚„è·‘åˆ°æœ€å‰é¢ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70, bst: 99, lck: 40}, desc: "åœ¨æœ€å¾Œä¸€ç§’å‰ï¼Œæ°¸é æœ‰ç„¡é™å¯èƒ½ã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50, bst: 70, lck: 60}, desc: "ç”¨æ°£å‹¢é©…å‹•å››è‚¢ï¼Œé€Ÿåº¦å¿«åˆ°ç„¡æ³•åé§ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, bst: 65, lck: 70}, desc: "ä¸æ±‚æœ€å¿«ï¼Œä½†çµ•å°æ´»å¾—æ¯”ä»»ä½•é¦¬éƒ½ä¹…ã€‚" }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = localStorage.getItem('my_race_name') || "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';

    function init() {
        if (isAdmin) document.getElementById('admin-panel').style.display = 'block';
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn'; btn.id = `name-${n}`; btn.innerText = n;
            btn.style.cssText = "padding:12px; background:#333; color:white; border:none; border-radius:10px; font-weight:bold;";
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        const horseGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot'; div.id = `slot-${i}`;
            div.innerHTML = `<div style="font-size:20px; transform:scaleX(-1);">ğŸ</div><b>${h.trait}</b>
                <div class="stat-row">é€Ÿåº¦<div class="stat-bar"><div class="stat-fill" style="width:${h.stats.spd}%"></div></div></div>
                <div class="stat-row">é«”åŠ›<div class="stat-bar"><div class="stat-fill" style="width:${h.stats.sta}%"></div></div></div>
                <div class="horse-desc">${h.desc}</div>`;
            div.onclick = () => selectHorse(i);
            horseGrid.appendChild(div);
        });
        listenFirebase();
    }

    function listenFirebase() {
        db.ref().on('value', snap => {
            const data = snap.val() || {};
            const users = data.users || {};
            const assignments = data.assignments || {};
            const gameState = data.gameState || {};
            const liveSync = data.liveSync || {};

            names.forEach(n => {
                const btn = document.getElementById(`name-${n}`);
                if (users[n]) btn.style.opacity = "0.3", btn.style.pointerEvents = "none";
                else btn.style.opacity = "1", btn.style.pointerEvents = "auto";
            });

            if (myName && users[myName]) {
                document.getElementById('user-login').style.display = 'none';
                document.getElementById('setup').style.display = 'block';
                document.getElementById('picker-info').innerText = `ä½ å¥½ ${myName}`;
            } else {
                document.getElementById('user-login').style.display = 'block';
                document.getElementById('setup').style.display = 'none';
                document.getElementById('track').style.display = 'none';
                document.getElementById('leaderboard').style.display = 'none';
            }

            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`slot-${i}`);
                slot.classList.remove('occupied', 'my-pick');
                const owner = Object.keys(assignments).find(name => assignments[name] === i);
                if (owner) owner === myName ? slot.classList.add('my-pick') : slot.classList.add('occupied');
            });

            if (isAdmin) document.getElementById('admin-ready-count').innerText = `å°±ç·’: ${Object.keys(assignments).length}/10`;

            // åŒæ­¥æ¯”è³½ç•«é¢
            if (gameState.status === 'racing') {
                document.querySelectorAll('#setup, #user-login, #admin-panel').forEach(el => el.style.display = 'none');
                document.getElementById('track').style.display = 'block';
                renderLanes(assignments);
                
                // è®€å– Live æ•¸æ“š
                Object.keys(liveSync).forEach(hId => {
                    const hData = liveSync[hId];
                    const hEl = document.getElementById(`horse-${hId}`);
                    const bEl = document.getElementById(`status-${hId}`);
                    if (hEl) {
                        hEl.style.left = hData.pos + 'px';
                        if (hData.event) {
                            bEl.innerText = hData.event;
                            bEl.style.opacity = "1";
                        } else {
                            bEl.style.opacity = "0";
                        }
                    }
                });

                if (gameState.results) showLeaderboard(gameState.results);
            }
        });
    }

    function renderLanes(participants) {
        const box = document.getElementById('lanes-box');
        if (box.children.length > 0) return;
        const list = Object.keys(participants).map(name => ({name, hId: participants[name]}));
        const hHeight = 100 / list.length;
        list.forEach(item => {
            const lane = document.createElement('div'); lane.className = 'lane'; lane.style.height = `${hHeight}%`;
            lane.innerHTML = `<div class="horse-container" id="horse-${item.hId}">
                <div class="status-bubble" id="status-${item.hId}"></div>
                <div class="horse-icon">ğŸ</div><div style="font-size:10px;">${item.name}</div>
            </div>`;
            box.appendChild(lane);
        });
    }

    function login(n) { myName = n; localStorage.setItem('my_race_name', n); db.ref(`users/${n}`).set(true); }
    function goBackToLogin() { db.ref(`users/${myName}`).remove(); db.ref(`assignments/${myName}`).remove(); myName = ""; }
    function selectHorse(idx) { if (myName) db.ref(`assignments/${myName}`).set(idx); }
    function resetFullGame() { db.ref().set(null); location.reload(); }

    document.getElementById('start-btn').onclick = function() {
        db.ref('assignments').once('value', snap => {
            const participants = snap.val() || {};
            db.ref('gameState').set({ status: 'racing', seed: Math.random(), participants: participants });
            if (isAdmin) runAdminEngine(participants);
        });
    };

    // ç®¡ç†å“¡å°ˆå±¬é‹ç®—å¼•æ“
    function runAdminEngine(participants) {
        const horses = Object.keys(participants).map(name => ({
            ...horseLibrary[participants[name]],
            owner: name, pos: 10, speed: 0, stamina: 100, finished: false, event: ""
        }));
        const finishLine = document.getElementById('track').offsetWidth - 80;
        const results = [];

        const timer = setInterval(() => {
            const syncData = {};
            horses.forEach(h => {
                if (h.finished) return;

                h.event = "";
                // äº‹ä»¶é‚è¼¯
                let luckRoll = Math.random() * 100;
                if (luckRoll < (100 - h.stats.lck) * 0.05) { h.speed *= 0.2; h.event = "ğŸ«¨ è…¿è»Ÿï¼"; }
                
                if (h.stamina > 0) {
                    h.speed += (h.stats.spd * 0.005) + (Math.random() * 0.2);
                    h.stamina -= (100 - h.stats.sta) * 0.05 + 0.1;
                } else {
                    h.speed *= 0.95; h.event = "ğŸ˜« çˆ†è‚äº†";
                }

                if (h.pos > finishLine * 0.8 && h.stats.bst > 70) {
                    h.speed += 0.5; h.event = "ğŸ”¥ è¡åˆºï¼";
                }

                h.pos += h.speed;
                if (h.pos >= finishLine) { h.finished = true; results.push(h); }
                
                syncData[h.id] = { pos: h.pos, event: h.event };
            });

            db.ref('liveSync').set(syncData);

            if (results.length === horses.length) {
                clearInterval(timer);
                db.ref('gameState/results').set(results.map(r => ({name: r.owner, prize: "$200"}))); // ç°¡åŒ–åæ¬¡
            }
        }, 100);
    }

    function showLeaderboard(res) {
        document.getElementById('leaderboard').style.display = 'block';
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = res.map((r, i) => `<div style="padding:10px; border-bottom:1px solid #eee;">#${i+1} ${r.name}</div>`).join('');
    }

    init();
</script>
</body>
</html>
