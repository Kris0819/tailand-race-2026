<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT é¦¬å¹´è³½é¦¬å¤§æœƒ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --primary: #ff3e3e; --gold: #ffd700; --track: #222;
            --success: #00ff88; --danger: #ff0055; --sprint: #ffaa00; --recover: #00d4ff;
        }

        body { font-family: 'PingFang TC', sans-serif; background: #0a0a0a; color: white; margin: 0; padding: 0; height: 100vh; overflow: hidden; }

        .btn-ui { border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .btn-ui:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.3); }

        /* Header */
        .header-bar { 
            background: linear-gradient(180deg, #333 0%, #111 100%); 
            padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; 
            height: 60px; border-bottom: 2px solid var(--gold); position: relative; z-index: 1000;
        }

        .page { display: none; height: calc(100vh - 60px); width: 100vw; position: absolute; flex-direction: column; overflow-y: auto; }
        .page.active { display: flex; }
        
        .login-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 20px; width: 100%; box-sizing: border-box; }
        .name-card { 
            background: #222; border: 2px solid #444; border-radius: 12px; padding: 25px 10px;
            text-align: center; font-size: 20px; font-weight: 800; color: #fff; position: relative;
        }
        .name-card.taken { opacity: 0.3; filter: grayscale(1); pointer-events: none; }

        /* é¸é¦¬å¡ç‰‡ */
        .horse-list { padding: 15px; padding-bottom: 120px; }
        .horse-card { 
            background: #1a1a1a; border: 2px solid #333; border-radius: 16px; padding: 15px; 
            margin-bottom: 15px; position: relative; border-left: 6px solid #444; transition: 0.2s;
        }
        .horse-card.selected { border-color: var(--success); background: #12221a; }
        .horse-card.occupied { opacity: 0.5; filter: grayscale(0.5); cursor: not-allowed; }
        .owner-badge { position: absolute; top: 10px; right: 10px; background: var(--primary); color: white; padding: 2px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; z-index: 2; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0; }
        .stat-label { font-size: 10px; color: #888; margin-bottom: 2px; }
        .stat-bar { height: 4px; background: #000; border-radius: 2px; overflow: hidden; }
        .stat-fill { height: 100%; background: var(--gold); }
        .horse-desc { font-size: 12px; color: #bbb; font-style: italic; border-top: 1px solid #333; padding-top: 8px; }

        /* æ¯”è³½è·‘é“ */
        #page-track { background: #111; }
        .track-bg { height: 100%; position: relative; background: #151515; }
        #lanes-render-area { display: flex; flex-direction: column; height: 100%; }
        .lane { position: relative; border-bottom: 1px solid #252525; flex-grow: 1; display: flex; align-items: center; padding-left: 10px; }
        .finish-line { position: absolute; right: 0; top: 0; bottom: 0; width: 40px; background: repeating-linear-gradient(45deg, #fff, #fff 10px, #000 10px, #000 20px); border-left: 4px solid var(--gold); z-index: 5; }

        .horse-pawn { position: absolute; left: 0; display: flex; align-items: center; width: 140px; transition: left 0.15s linear; }
        .horse-visual { font-size: 38px; transform: scaleX(-1); animation: move 0.4s infinite; transition: filter 0.3s; }
        
        /* ç‰¹æ•ˆ Class */
        .effect-sprint { filter: drop-shadow(0 0 15px var(--gold)) scaleX(-1) !important; }
        .effect-exhausted { filter: drop-shadow(0 0 15px var(--danger)) scaleX(-1) !important; }
        .effect-slip { animation: slip-shake 0.2s infinite !important; }

        @keyframes move { 0%, 100% { transform: scaleX(-1) translateY(0); } 50% { transform: scaleX(-1) translateY(-6px); } }
        @keyframes slip-shake { 
            0% { transform: scaleX(-1) rotate(0deg); } 
            25% { transform: scaleX(-1) rotate(20deg) translateY(-2px); }
            75% { transform: scaleX(-1) rotate(-20deg) translateY(2px); }
            100% { transform: scaleX(-1) rotate(0deg); }
        }

        .speech-bubble {
            position: absolute; top: -55px; left: 10px; background: white; color: black;
            padding: 5px 12px; border-radius: 12px; font-size: 13px; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 20; white-space: nowrap;
        }
        .speech-bubble::after { content: ''; position: absolute; bottom: -8px; left: 15px; border-width: 8px 8px 0; border-style: solid; border-color: white transparent; }
        .bubble-danger { background: var(--danger); color: white; }
        .bubble-danger::after { border-color: var(--danger) transparent; }
        .bubble-recover { background: var(--recover); color: #000; }
        .bubble-recover::after { border-color: var(--recover) transparent; }

        .stamina-container { width: 50px; height: 4px; background: #000; border-radius: 2px; margin-top: 5px; overflow: hidden; }
        .stamina-fill { height: 100%; background: var(--success); transition: width 0.3s; }

        #countdown-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
            display: none; align-items: center; justify-content: center;
            z-index: 2000; font-size: 150px; font-weight: 900; color: var(--gold);
        }

        .admin-monitor-box { background: #1a1a1a; border: 1px solid #333; margin: 15px; padding: 12px; border-radius: 10px; }
        .player-status-tag { display: inline-block; padding: 3px 10px; border-radius: 5px; font-size: 11px; margin: 3px; background: #222; border: 1px solid #444; }
        .player-status-tag.ready { border-color: var(--success); color: var(--success); }
        .admin-persistent-ctrl { position: fixed; bottom: 20px; left: 20px; z-index: 9999; display: none; flex-direction: column; gap: 10px; }
    </style>
</head>
<body>

<audio id="bgm" loop src="https://assets.mixkit.co/music/preview/mixkit-fast-game-action-loop-460.mp3"></audio>
<div id="countdown-overlay">READY</div>

<div class="header-bar" id="header">
    <div id="header-left">
        <button class="btn-ui" id="btn-back" onclick="logout()" style="background:#444; color:white; padding:8px 15px; display:none;">â¬… è¿”å›é¸äºº</button>
    </div>
    <div id="header-user-info" style="text-align:right;">
        <div id="label-user-name" style="font-weight:bold; color:var(--gold);">GUEST</div>
    </div>
</div>

<div id="page-login" class="page active">
    <div id="admin-login-monitor" style="display:none;" class="admin-monitor-box">
        <div style="font-size:12px; color:var(--gold); margin-bottom:8px;">[ADMIN] å³æ™‚é¸é¦¬é€²åº¦ï¼š</div>
        <div id="admin-status-grid"></div>
    </div>
    <div style="text-align:center; padding:20px 0;">
        <h1 style="color:var(--gold); margin:0; letter-spacing:4px;">AIOT 2026 é¦¬å¹´è³½é¦¬çé‡‘è³½</h1>
        <p style="color:#666;">é»æ“Šä½ çš„åå­—åŠ å…¥æ¯”è³½</p>
    </div>
    <div class="login-grid" id="login-grid"></div>
</div>

<div id="page-setup" class="page">
    <div style="text-align:center; padding: 25px 15px 10px;">
        <h2 style="color:var(--gold); margin:0; font-size:24px;">ğŸ è«‹é¸æ“‡æ‚¨çš„åƒè³½æˆ°é¦¬</h2>
        <div style="font-size:12px; color:#aaa; margin-top:12px; line-height:1.6; background:#1a1a1a; padding:12px; border-radius:10px; text-align:left; border:1px solid #333;">
            <b style="color:var(--gold);">ğŸ“Š å±¬æ€§å½±éŸ¿èªªæ˜ï¼š</b><br>
            â€¢ <b>é€Ÿåº¦ï¼š</b>åŸºç¤ç§»å‹•é€Ÿåº¦ã€‚é€Ÿåº¦è¶Šå¿«ï¼Œé«”åŠ›æ¶ˆè€—ä¹Ÿè¶Šå¿«ã€‚<br>
            â€¢ <b>é«”åŠ›ï¼š</b>å½±éŸ¿çºŒèˆªåŠ›ã€‚æ•¸å€¼è¶Šé«˜ï¼Œè¶Šä¸å®¹æ˜“é€²å…¥ã€Œçˆ†è‚ã€èººå¹³ç‹€æ…‹ã€‚<br>
            â€¢ <b>çˆ†ç™¼ï¼š</b>è¡åˆºæ™‚çš„å¢ç›Šå¼·åº¦ã€‚æ•¸å€¼è¶Šé«˜ï¼Œè§¸ç™¼è¡åˆºæ™‚å™´ç™¼è¶Šé ã€‚<br>
            â€¢ <b>é‹æ°£ï¼š</b>æ•¸å€¼è¶Šé«˜ï¼Œè¶Šä¸å®¹æ˜“ç™¼ç”Ÿæ»‘å€’æ„å¤–ï¼Œä¸”è§¸ç™¼è¡åˆºæ©Ÿç‡è¶Šé«˜ã€‚
        </div>
    </div>
    <div class="horse-list" id="horse-selection-list"></div>
</div>

<div id="page-track" class="page">
    <div class="track-bg">
        <div class="finish-line"></div>
        <div id="lanes-render-area"></div>
    </div>
</div>

<div class="admin-persistent-ctrl" id="admin-ctrl">
    <button class="btn-ui" id="admin-start-btn" onclick="adminStart()" style="background:var(--success); color:black; padding:15px 30px; font-size:18px;">ğŸ é–‹å§‹æ¯”è³½</button>
    <button class="btn-ui" id="admin-reset-btn" onclick="adminReset()" style="background:var(--danger); color:white; padding:10px 20px;">ğŸ”„ é‡ç½®å…¨å ´</button>
</div>

<div id="leaderboard-overlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10000; display:none; align-items:center; justify-content:center;">
    <div style="background:white; color:black; width:85%; border-radius:20px; padding:30px; text-align:center;">
        <h2 style="color:var(--danger);">ğŸ† æ’è¡Œæ¦œ ğŸ† </h2>
        <div id="rankings-list" style="margin:20px 0; font-weight:bold; text-align: left;"></div>
        <button class="btn-ui" onclick="adminReset()" style="background:#111; color:white; width:100%; padding:15px; display:none;" id="lb-reset-btn">ä¸‹ä¸€è¼ªæ¯”è³½</button>
    </div>
</div>

<script>
    // =====================================================================
    // Firebase è¨­å®š
    // =====================================================================
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // =====================================================================
    // éŠæˆ²æ•¸æ“šå®šç¾©
    // =====================================================================
    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, burst: 40, lck: 70}, desc: "æ“…é•·åœ¨ä¸»ç®¡è¦–ç·šå¤–ç·©æ­¥å‰é€²ï¼Œé«”åŠ›æ·±ä¸å¯æ¸¬ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 55, sta: 65, burst: 95, lck: 60}, desc: "ä¸€æ—¦å¤•é™½è¥¿ä¸‹ï¼Œé«”åŠ›å†ä½ä¹Ÿèƒ½çˆ†ç™¼è¡åˆºã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, burst: 85, lck: 30}, desc: "èµ·æ­¥ç¬é–“å³å·”å³°ï¼Œä½†çˆ†è‚å€’æ•¸æ˜¯ä»–çš„æ—¥å¸¸ã€‚" },
        { id: 3, trait: "æœƒè­°æˆ°é¬¥æ©Ÿ", stats: {spd: 75, sta: 60, burst: 60, lck: 80}, desc: "ç¯€å¥æ„Ÿæ¥µå¼·ï¼Œä»¥ç©©å®šçš„é«˜èªé€Ÿå£“åˆ¶å…¨å ´ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, burst: 75, lck: 55}, desc: "ä¾è³´å’–å•¡å› æé€Ÿï¼Œæ²’å’–å•¡æ™‚é«”åŠ›æ‰è¶…å¿«ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, burst: 30, lck: 99}, desc: "æ‹¥æœ‰ç¥ç´šé–ƒé¿ï¼Œå¹¾ä¹ä¸æœƒæ»‘å€’ï¼Œé‹æ°£é»æ»¿ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, burst: 50, lck: 65}, desc: "é›–ç„¶æ²’å­˜åœ¨æ„Ÿï¼Œä½†é«”åŠ›é©šäººä¸”è·‘å¾—ç•°å¸¸ç©©ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 40, sta: 70, burst: 99, lck: 40}, desc: "å¹³æ™‚éƒ½åœ¨æ··ï¼Œæœ€å¾Œé—œé ­è¡åˆºåŠ›é‡ç„¡äººèƒ½åŠã€‚" },
        { id: 8, trait: "ç”¨å˜´åšäº‹", stats: {spd: 85, sta: 50, burst: 70, lck: 65}, desc: "ç”¨æ°£å‹¢é©…å‹•å››è‚¢ï¼Œçˆ†ç™¼åŠ›èˆ‡é€Ÿåº¦å…¼å…·çš„å‹ç”·ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, burst: 65, lck: 70}, desc: "ä¸æ±‚æœ€å¿«ï¼Œä½†é«”åŠ›èˆ‡é‹æ°£è®“ä»–å§‹çµ‚åœ¨ç¬¬ä¸€æ¢¯éšŠã€‚" },
        { id: 10, trait: "é€šéˆç‹", stats: {spd: 50, sta: 50, burst: 40, lck: 100}, desc: "èƒ½é çŸ¥éœ€æ±‚ï¼Œé è‘—ç¥ç´šç›´è¦ºé¿é–‹æ‰€æœ‰éšœç¤™ã€‚" },
        { id: 11, trait: "ç°¡å ±å¤§å¸«", stats: {spd: 90, sta: 30, burst: 90, lck: 40}, desc: "ç•«é¢å¾ˆè¯éº—ï¼Œä½†çºŒèˆªåŠ›æ¥µä½ï¼Œæ²’è¬›å®Œå°±æ–·é›»ã€‚" },
        { id: 12, trait: "Debugç‹", stats: {spd: 65, sta: 65, burst: 65, lck: 95}, desc: "åªè¦ä»–åœ¨ï¼Œç¨‹å¼ç¢¼è‡ªå‹•ä¿®å¾©ï¼Œæ€éº¼ä¿®çš„?ä¸çŸ¥é“ï¼Œé‹æ°£å°±æ˜¯ä¸€åˆ‡ã€‚" },
        { id: 13, trait: "èŒ¶æ°´é–“å®ˆé–€å“¡", stats: {spd: 40, sta: 100, burst: 20, lck: 80}, desc: "æ¯å¤©æº–æ™‚å ±åˆ°ï¼Œé«”åŠ›å…¨å ´æœ€ç¡¬ï¼Œæ…¢æ…¢ç£¨åˆ°çµ‚é»ã€‚" },
        { id: 14, trait: "Teasm æ½›æ°´å“¡", stats: {spd: 75, sta: 75, burst: 50, lck: 50}, desc: "æ²’äº‹ä¸å›è¨Šï¼Œä¸€æ—¦å›è¨Šæ¯å°±æ˜¯ä¸€é³´é©šäººã€‚" }
    ];

    const names = ["Julia", "Molly", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "Juli", "Jason", "Kris"];
    let myName = localStorage.getItem('race_user') || "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
    let serverOffset = 0;
    const rankEmojis = ["ğŸ¥³", "ğŸ˜", "ğŸ˜Š", "ğŸ˜", "ğŸ¤”", "ğŸ˜“", "ğŸ˜«", "ğŸ˜­", "ğŸ’€", "ğŸª¦"];

    db.ref(".info/serverTimeOffset").on("value", s => serverOffset = s.val());

    // =====================================================================
    // åˆå§‹åŒ–ï¼šlogin grid + horse selection cards
    // =====================================================================
    function init() {
        if (isAdmin) {
            document.getElementById('admin-ctrl').style.display = 'flex';
            document.getElementById('admin-login-monitor').style.display = 'block';
            document.getElementById('lb-reset-btn').style.display = 'block';
            document.getElementById('label-user-name').innerText = "ADMIN";
        }

        // --- Login Grid ---
        const loginGrid = document.getElementById('login-grid');
        names.forEach(n => {
            const d = document.createElement('div');
            d.className = 'name-card'; d.id = `user-${n}`; d.innerText = n;
            d.onclick = () => {
                myName = n;
                localStorage.setItem('race_user', n);
                db.ref(`users/${n}`).set(true);
                document.getElementById('bgm').play();
            };
            loginGrid.appendChild(d);
        });

        // --- Horse Selection List ---
        const setupGrid = document.getElementById('horse-selection-list');
        horseLibrary.forEach((h, i) => {
            const d = document.createElement('div');
            d.className = 'horse-card'; d.id = `slot-${i}`;
            d.innerHTML = `
                <div class="owner-badge" id="owner-${i}" style="display:none;"></div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:30px;">ğŸ</span>
                    <div style="font-weight:bold; color:var(--gold); font-size:18px;">${h.trait}</div>
                </div>
                <div class="stat-grid">
                    ${renderStat("é€Ÿåº¦", h.stats.spd)} ${renderStat("é«”åŠ›", h.stats.sta)}
                    ${renderStat("çˆ†ç™¼", h.stats.burst)} ${renderStat("é‹æ°£", h.stats.lck)}
                </div>
                <div class="horse-desc">${h.desc}</div>
            `;
            d.onclick = () => {
                if (!myName) return;
                db.ref('assignments').once('value', snap => {
                    const a = snap.val() || {};
                    if (Object.entries(a).some(([p, idx]) => idx === i && p !== myName)) {
                        alert("æ…¢äº†ï¼è¢«é¸èµ°å›‰ï¼");
                    } else {
                        db.ref(`assignments/${myName}`).set(i);
                    }
                });
            };
            setupGrid.appendChild(d);
        });

        listenFirebase();
    }

    function renderStat(label, val) {
        return `<div><div class="stat-label">${label}</div><div class="stat-bar"><div class="stat-fill" style="width:${val}%"></div></div></div>`;
    }

    function logout() {
        if (myName) { db.ref(`users/${myName}`).remove(); db.ref(`assignments/${myName}`).remove(); }
        localStorage.removeItem('race_user'); myName = ""; location.reload();
    }

    // =====================================================================
    // Firebase Listeners
    // =====================================================================
    function listenFirebase() {
        // --- users ---
        db.ref('users').on('value', snap => {
            const u = snap.val();
            if (!u && myName && !isAdmin) { localStorage.removeItem('race_user'); location.reload(); return; }
            const users = u || {};
            names.forEach(n => {
                const el = document.getElementById(`user-${n}`);
                users[n] ? el.classList.add('taken') : el.classList.remove('taken');
            });
            if (myName && users[myName]) {
                switchPage('page-setup');
                if (!isAdmin) document.getElementById('label-user-name').innerText = myName;
                document.getElementById('btn-back').style.display = 'block';
            } else {
                switchPage('page-login');
                document.getElementById('btn-back').style.display = 'none';
            }
            updateAdminMonitor(users);
        });

        // --- assignments ---
        db.ref('assignments').on('value', snap => {
            const a = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const el = document.getElementById(`slot-${i}`);
                const badge = document.getElementById(`owner-${i}`);
                const owner = Object.keys(a).find(k => a[k] === i);
                el.classList.remove('selected', 'occupied');
                if (owner) {
                    badge.style.display = 'block';
                    badge.innerText = `${owner} å·²é¸`;
                    if (owner === myName) el.classList.add('selected');
                    else el.classList.add('occupied');
                } else {
                    badge.style.display = 'none';
                }
            });
        });

        // --- gameStateï¼ˆæ¯”è³½å•Ÿå‹•/ç‹€æ…‹ï¼‰ ---
        db.ref('gameState').on('value', snap => {
            const s = snap.val();
            if (s && s.status === 'racing') {
                if (isAdmin) document.getElementById('admin-start-btn').style.display = 'none';
                // åˆ‡åˆ°è·‘é“é ä¸¦é–‹å§‹ç›£å¬ snapshot
                switchPage('page-track');
                setupTrackLanes(s.raceData);
                startListeningSnapshot();
            } else if (s && s.status === 'finished' && s.results) {
                // æ¯”è³½çµæŸï¼Œå±•ç¤ºæ¦œ
                showLeaderboard(s.results);
            } else {
                // idle
                if (isAdmin) document.getElementById('admin-start-btn').style.display = 'block';
                document.getElementById('leaderboard-overlay').style.display = 'none';
                stopListeningSnapshot();
                if (document.getElementById('page-track').classList.contains('active')) {
                    setTimeout(() => location.reload(), 500);
                }
            }
        });
    }

    function updateAdminMonitor(users) {
        if (!isAdmin) return;
        db.ref('assignments').once('value', snap => {
            const a = snap.val() || {};
            const container = document.getElementById('admin-status-grid');
            container.innerHTML = Object.keys(users).map(name =>
                `<span class="player-status-tag ${a[name] !== undefined ? 'ready' : ''}">${name}: ${a[name] !== undefined ? horseLibrary[a[name]].trait : "æœªé¸é¦¬"}</span>`
            ).join('');
        });
    }

    function switchPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('header').style.display = (id === 'page-track') ? 'none' : 'flex';
    }

    // =====================================================================
    // ADMINï¼šç”Ÿæˆéš¨æ©Ÿäº‹ä»¶ + å•Ÿå‹•æ¬Šå¨æ€§éŠæˆ²è¿´åœˆ
    // =====================================================================
    let adminLoopTimer = null; // setInterval handle

    function adminStart() {
        db.ref('assignments').once('value', snap => {
            const players = snap.val();
            if (!players) return alert("ç„¡äººåƒè³½ï¼");

            // ç‚ºæ¯ä½é¸æ‰‹ç”Ÿæˆå›ºå®šçš„éš¨æ©Ÿäº‹ä»¶åºåˆ—ï¼ˆæ™‚åˆ» + é¡å‹ï¼‰
            // é€™äº›äº‹ä»¶å¯«é€² gameStateï¼Œæ‰€æœ‰ç«¯éƒ½çœ‹åˆ°åŒä¸€ä»½
            const raceData = {};
            Object.entries(players).forEach(([name, hIdx]) => {
                const h = horseLibrary[hIdx];
                const events = [];
                for (let j = 0; j < 3; j++) {
                    const t = 8 + (j * 8) + Math.random() * 5;
                    // ç”¨é‹æ°£æ±ºå®šæ˜¯è¡åˆºé‚„æ˜¯æ»‘å€’
                    const type = (Math.random() * 100 < h.stats.lck) ? 'burst' : 'slip';
                    events.push({ t, type });
                }
                raceData[name] = { hIdx, events };
            });

            // startTime è¨­ç‚º server æ™‚é–“ + 4ç§’ï¼ˆå€’æ•¸ï¼‰
            const startTime = Date.now() + serverOffset + 4000;

            db.ref('gameState').set({
                status: 'racing',
                startTime,
                raceData
            });

            // å•Ÿå‹•æ¬Šå¨æ€§éŠæˆ²è¿´åœˆï¼ˆåªåœ¨ admin ç«¯è·‘ï¼‰
            startAdminGameLoop(startTime, raceData);
        });
    }

    /**
     * Admin ç«¯çš„éŠæˆ²è¿´åœˆã€‚
     * æ¯ 100ms è¨ˆç®—ä¸€æ¬¡æ‰€æœ‰é¸æ‰‹çš„æœ€æ–°é€²åº¦ï¼Œ
     * ç„¶å¾Œå°‡å¿«ç…§å¯«é€² Firebase â†’ æ‰€æœ‰ client åªéœ€å¾å¿«ç…§æ¸²æŸ“ã€‚
     */
    function startAdminGameLoop(startTime, raceData) {
        if (adminLoopTimer) clearInterval(adminLoopTimer);

        // åˆå§‹åŒ–æ¯å€‹é¸æ‰‹çš„ç‹€æ…‹ï¼ˆé€™ä»½æ•¸æ“šåƒ…å­˜æ´»åœ¨ admin å…§å­˜è£¡ï¼‰
        const runners = Object.entries(raceData).map(([name, data]) => ({
            name,
            stats: horseLibrary[data.hIdx].stats,
            events: data.events,
            progress: 0,
            stamina: 100,
            isRecovering: false,
            recoveryEndTime: 0,
            finished: false,
            finishTime: null,
            // ç•¶å‰æ´»å‹•çš„äº‹ä»¶ç‹€æ…‹ï¼ˆç”¨æ–¼å‚³çµ¦ client é¡¯ç¤ºæ°£æ³¡/ç‰¹æ•ˆï¼‰
            activeEffect: null   // null | 'burst' | 'slip' | 'exhausted' | 'recovering'
        }));

        let lastElapsed = -999; // ä¸Šä¸€æ¬¡è¨ˆç®—çš„ elapsedï¼ˆç”¨æ–¼è¨ˆç®— dtï¼‰

        adminLoopTimer = setInterval(() => {
            const now = Date.now() + serverOffset;
            const elapsed = (now - startTime) / 1000;

            // å€’æ•¸éšæ®µä¸è¨ˆç®—é€²åº¦
            if (elapsed < 0) {
                // ä»åœ¨å€’æ•¸ï¼Œä¸å¯« snapshotï¼ˆclient è‡ªå·±æ ¹æ“š startTime é¡¯ç¤ºå€’æ•¸ï¼‰
                lastElapsed = elapsed;
                return;
            }

            // è¨ˆç®— dtï¼ˆå¾ä¸Šæ¬¡è¿´åœˆç¶“éçš„ç§’æ•¸ï¼‰
            // ç¬¬ä¸€å¹€é€²å…¥æ­£å¼æ¯”è³½æ™‚ï¼Œdt å¾ 0 é–‹å§‹
            const dt = (lastElapsed < 0) ? 0.1 : (elapsed - lastElapsed);
            lastElapsed = elapsed;

            let allFinished = true;

            runners.forEach(r => {
                if (r.finished) return;
                allFinished = false;

                // --- æ¢å¾©ä¸­ï¼ˆçˆ†è‚èººå¹³ï¼‰---
                if (r.isRecovering) {
                    r.activeEffect = 'recovering';
                    if (elapsed >= r.recoveryEndTime) {
                        // æ¢å¾©å®Œæˆ
                        r.isRecovering = false;
                        r.stamina = 100;
                        r.activeEffect = null;
                    }
                    return; // æ¢å¾©ä¸­ä¸ç§»å‹•
                }

                // --- è¨ˆç®—é€Ÿåº¦èˆ‡é«”åŠ›æ¶ˆè€— ---
                let spd = (r.stats.spd / 100) * 0.035;
                let drain = (1.5 - r.stats.sta / 100) * 2.5;
                r.activeEffect = null;

                // æª¢æŸ¥æ˜¯å¦æœ‰æ´»å‹•äº‹ä»¶
                r.events.forEach(ev => {
                    if (elapsed >= ev.t && elapsed <= ev.t + 1.5) {
                        if (ev.type === 'burst') {
                            spd *= (1.5 + r.stats.burst / 100);
                            drain *= 5;
                            r.activeEffect = 'burst';
                        } else {
                            // æ»‘å€’ï¼šå¾Œé€€ä¸€é»
                            r.progress = Math.max(0, r.progress - 0.012 * dt);
                            r.activeEffect = 'slip';
                        }
                    }
                });

                // ç§»å‹•
                r.progress += spd * dt;
                r.stamina = Math.max(0, r.stamina - drain * dt);

                // é«”åŠ›è€—ç›¡ â†’ é€²å…¥çˆ†è‚æ¢å¾©
                if (r.stamina <= 0) {
                    r.isRecovering = true;
                    r.recoveryEndTime = elapsed + 5;
                    r.activeEffect = 'exhausted';
                }

                // åˆ°é”çµ‚é»
                if (r.progress >= 1) {
                    r.progress = 1;
                    r.finished = true;
                    r.finishTime = elapsed;
                    r.activeEffect = 'finished';
                }
            });

            // --- å°‡å¿«ç…§å¯«å…¥ Firebase ---
            const snapshot = {};
            runners.forEach(r => {
                snapshot[r.name] = {
                    progress: r.progress,
                    stamina: r.stamina,
                    activeEffect: r.activeEffect,
                    isRecovering: r.isRecovering,
                    recoveryEndTime: r.recoveryEndTime,
                    finished: r.finished,
                    finishTime: r.finishTime
                };
            });

            db.ref('gameState/snapshot').set(snapshot);

            // --- å…¨éƒ¨è·‘å®Œ â†’ çµæŸæ¯”è³½ ---
            if (runners.every(r => r.finished)) {
                clearInterval(adminLoopTimer);
                adminLoopTimer = null;

                // ç­‰ä¸€ç§’è®“æœ€å¾Œçš„å¿«ç…§å‚³æ’­ï¼Œç„¶å¾Œå¯«å…¥çµæœ
                setTimeout(() => {
                    const sorted = [...runners].sort((a, b) => a.finishTime - b.finishTime);
                    const results = sorted.map((r, i) => ({
                        name: r.name,
                        finishTime: r.finishTime,
                        rank: i + 1
                    }));
                    db.ref('gameState').update({ status: 'finished', results });
                }, 1000);
            }
        }, 100); // æ¯ 100ms è·‘ä¸€æ¬¡
    }

    function stopAdminGameLoop() {
        if (adminLoopTimer) { clearInterval(adminLoopTimer); adminLoopTimer = null; }
    }

    function adminReset() {
        stopAdminGameLoop();
        stopListeningSnapshot();
        db.ref('users').remove();
        db.ref('assignments').remove();
        db.ref('gameState').set({ status: 'idle' });
    }

    // =====================================================================
    // CLIENTï¼šç›£å¬ snapshot â†’ æ¸²æŸ“è·‘é“
    // =====================================================================
    let snapshotListener = null;
    let trackSetupDone = false;
    let playerOrder = []; // ä¿æŒæ¸²æŸ“é¡ºåºå›ºå®š

    /**
     * ç¬¬ä¸€æ¬¡é€²å…¥è·‘é“é æ™‚ï¼Œæ ¹æ“š raceData å»ºç«‹ lane DOM
     */
    function setupTrackLanes(raceData) {
        if (trackSetupDone) return;
        trackSetupDone = true;
        playerOrder = Object.keys(raceData);

        const renderArea = document.getElementById('lanes-render-area');
        renderArea.innerHTML = "";

        playerOrder.forEach((name, idx) => {
            const div = document.createElement('div');
            div.className = 'lane';
            div.innerHTML = `
                <div class="horse-pawn" id="pawn-${idx}">
                    <div id="bubble-${idx}"></div>
                    <div class="horse-visual" id="vis-${idx}">ğŸ</div>
                    <div style="margin-left:10px;">
                        <div style="font-size:10px; font-weight:bold;">${name}</div>
                        <div class="stamina-container"><div class="stamina-fill" id="stam-${idx}" style="width:100%"></div></div>
                    </div>
                </div>
            `;
            renderArea.appendChild(div);
        });
    }

    /**
     * é–‹å§‹ç›£å¬ gameState/snapshotï¼Œæ”¶åˆ°æ–°å¿«ç…§å°±ç›´æ¥å¥—ç”¨åˆ° DOM
     */
    function startListeningSnapshot() {
        if (snapshotListener) return; // å·²ç¶“åœ¨ç›£å¬

        // å…ˆè™•ç†å€’æ•¸ï¼ˆæ ¹æ“š startTimeï¼‰
        db.ref('gameState/startTime').once('value', snap => {
            const startTime = snap.val();
            if (startTime) handleCountdown(startTime);
        });

        snapshotListener = db.ref('gameState/snapshot').on('value', snap => {
            const snapshot = snap.val();
            if (!snapshot) return;
            renderFromSnapshot(snapshot);
        });
    }

    function stopListeningSnapshot() {
        if (snapshotListener) {
            db.ref('gameState/snapshot').off('value', snapshotListener);
            snapshotListener = null;
        }
        trackSetupDone = false;
        playerOrder = [];
    }

    /**
     * å€’æ•¸å€’è¨ˆæ™‚é¡¯ç¤ºï¼ˆclient ç«¯æ ¹æ“š startTime è‡ªå·±ç®—ï¼Œä¸å½±éŸ¿æ¯”è³½é€²åº¦ï¼‰
     */
    function handleCountdown(startTime) {
        function tick() {
            const now = Date.now() + serverOffset;
            const remaining = (startTime - now) / 1000;
            if (remaining > 0) {
                const overlay = document.getElementById('countdown-overlay');
                overlay.style.display = 'flex';
                overlay.innerText = remaining > 3 ? "READY" : Math.ceil(remaining);
                requestAnimationFrame(tick);
            } else {
                document.getElementById('countdown-overlay').style.display = 'none';
            }
        }
        tick();
    }

    /**
     * å¾å¿«ç…§æ•¸æ“šç›´æ¥æ›´æ–° DOMï¼ˆé€™æ˜¯å”¯ä¸€å½±éŸ¿ç•«é¢çš„ä¾†æºï¼‰
     */
    function renderFromSnapshot(snapshot) {
        const renderArea = document.getElementById('lanes-render-area');
        if (!renderArea) return;
        const finishLineX = renderArea.offsetWidth - 140;

        playerOrder.forEach((name, i) => {
            const data = snapshot[name];
            if (!data) return;

            const pawn = document.getElementById(`pawn-${i}`);
            const vis = document.getElementById(`vis-${i}`);
            const bub = document.getElementById(`bubble-${i}`);
            const stamFill = document.getElementById(`stam-${i}`);
            if (!pawn || !vis || !bub || !stamFill) return;

            // --- ä½ç½® ---
            pawn.style.left = (data.progress * finishLineX) + "px";

            // --- é«”åŠ›æ¢ ---
            stamFill.style.width = data.stamina + "%";

            // --- è¦–è¦ºç‰¹æ•ˆ + æ°£æ³¡ï¼ˆæ ¹æ“š activeEffectï¼‰---
            vis.className = "horse-visual";
            bub.className = "";
            bub.innerText = "";

            switch (data.activeEffect) {
                case 'burst':
                    vis.classList.add('effect-sprint');
                    bub.className = "speech-bubble";
                    bub.innerText = "ğŸ”¥ è¡åˆºï¼";
                    break;
                case 'slip':
                    vis.classList.add('effect-slip');
                    bub.className = "speech-bubble bubble-danger";
                    bub.innerText = "â›¸ï¸ æ»‘å€’ï¼";
                    break;
                case 'exhausted':
                    vis.classList.add('effect-exhausted');
                    bub.className = "speech-bubble bubble-danger";
                    bub.innerText = "ğŸ˜µ å·²çˆ†è‚...";
                    break;
                case 'recovering':
                    vis.classList.add('effect-exhausted');
                    // è¨ˆç®—å‰©é¤˜æ¢å¾©æ™‚é–“
                    // recoveryEndTime æ˜¯ elapsed å–®ä½ï¼Œæˆ‘å€‘ç„¡æ³•åœ¨æ­¤ç²¾ç¢ºç®—å‡ºï¼Œ
                    // æ‰€ä»¥ç”¨ä¸€å€‹é€šç”¨è¨Šæ¯
                    bub.className = "speech-bubble bubble-recover";
                    bub.innerText = "ğŸ©¹ èººå¹³ä¸­...";
                    break;
                case 'finished':
                    bub.className = "speech-bubble";
                    // æ‰¾åˆ°é€™å€‹äººçš„æ’å
                    const finishedCount = Object.values(snapshot).filter(s => s.finished).length;
                    // æ’åéœ€è¦å¾ results æ‹¿ï¼Œé€™è£¡å…ˆé¡¯ç¤º ğŸ
                    bub.innerText = "ğŸ";
                    break;
                default:
                    // ç„¡ç‰¹æ•ˆï¼Œæ¸…é™¤
                    break;
            }
        });
    }

    /**
     * æ¯”è³½çµæŸ â†’ å±•ç¤ºæ¦œï¼ˆç”± gameState.status === 'finished' è§¸ç™¼ï¼‰
     */
    function showLeaderboard(results) {
        // results æ˜¯ admin å¯«é€²ä¾†çš„é™£åˆ—ï¼Œå·²ç¶“æŒ‰åæ¬¡æ’å¥½
        document.getElementById('leaderboard-overlay').style.display = 'flex';
        document.getElementById('rankings-list').innerHTML = results.map((r, i) =>
            `<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee;">
                <span>${rankEmojis[i] || ""} #${i + 1} ${r.name}</span>
                <span style="color:var(--primary)">${getPrize(i + 1)}</span>
            </div>`
        ).join('');
    }

    function getPrize(r) {
        return r === 1 ? "ç¾é‡‘ $2500" : (r <= 5 ? "æ–°å…‰ç¦®å· $1000 " : ({ 6: "ç¾é‡‘ $500", 7: "ç¾é‡‘ $400", 8: "ç¾é‡‘ $300", 9: "ç¾é‡‘ $200", 10: "ç¾é‡‘ $100" }[r] || "-"));
    }

    // =====================================================================
    // å•Ÿå‹•
    // =====================================================================
    init();
</script>
</body>
</html>
