<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT é¦¬å¹´è³½é¦¬å¤§æœƒ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        :root { 
            --pixel-gold: #ffcc00;
            --pixel-brown: #8b4513;
            --pixel-dark: #2d1b00;
            --pixel-grass: #4a7c59;
            --pixel-sky: #5fcde4;
            --pixel-red: #ff4444;
            --pixel-green: #44ff88;
            --pixel-orange: #ff8844;
            --pixel-blue: #4488ff;
            --pixel-white: #fff5e1;
            --pixel-shadow: #1a0d00;
        }

        * {
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        body { 
            font-family: 'Press Start 2P', monospace; 
            background: var(--pixel-dark); 
            color: var(--pixel-white); 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            overflow: hidden;
            font-size: 11px;
        }

        .pixel-border {
            box-shadow: 
                0 -2px 0 var(--pixel-shadow),
                0 2px 0 var(--pixel-shadow),
                -2px 0 0 var(--pixel-shadow),
                2px 0 0 var(--pixel-shadow),
                -2px -2px 0 var(--pixel-shadow),
                2px -2px 0 var(--pixel-shadow),
                -2px 2px 0 var(--pixel-shadow),
                2px 2px 0 var(--pixel-shadow);
        }

        .pixel-border-inner {
            box-shadow: 
                inset 0 -2px 0 rgba(0,0,0,0.5),
                inset 0 2px 0 rgba(255,255,255,0.2),
                inset -2px 0 0 rgba(0,0,0,0.3),
                inset 2px 0 0 rgba(255,255,255,0.1);
        }

        .btn-ui { 
            font-family: 'Press Start 2P', monospace;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            transition: none;
            position: relative;
            font-size: 11px;
            text-transform: uppercase;
            background: var(--pixel-gold);
            color: var(--pixel-dark);
            box-shadow: 
                0 4px 0 var(--pixel-brown),
                0 4px 0 2px var(--pixel-shadow);
        }
        
        .btn-ui:hover {
            background: #ffd700;
            transform: translateY(1px);
            box-shadow: 
                0 3px 0 var(--pixel-brown),
                0 3px 0 2px var(--pixel-shadow);
        }
        
        .btn-ui:active { 
            transform: translateY(4px); 
            box-shadow: none;
        }

        .header-bar { 
            background: 
                repeating-linear-gradient(
                    0deg,
                    var(--pixel-brown) 0px,
                    var(--pixel-brown) 2px,
                    #6b3410 2px,
                    #6b3410 4px
                );
            padding: 12px 15px;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 50px;
            border-bottom: 4px solid var(--pixel-gold);
            box-shadow: 0 4px 0 var(--pixel-shadow);
            position: relative;
            z-index: 1000;
        }

        .header-bar::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            height: 4px;
            background: repeating-linear-gradient(
                90deg,
                var(--pixel-gold) 0px,
                var(--pixel-gold) 8px,
                transparent 8px,
                transparent 16px
            );
        }

        .page { 
            display: none; 
            height: calc(100vh - 54px); 
            width: 100vw; 
            position: absolute; 
            flex-direction: column; 
            overflow-y: auto;
            background: 
                repeating-linear-gradient(
                    0deg,
                    rgba(0,0,0,0.1) 0px,
                    rgba(0,0,0,0.1) 1px,
                    transparent 1px,
                    transparent 2px
                );
        }
        .page.active { display: flex; }
        
        .login-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            padding: 20px; 
            width: 100%; 
            box-sizing: border-box;
        }
        
        .name-card { 
            background: 
                linear-gradient(135deg, 
                    var(--pixel-brown) 0%,
                    #6b3410 50%,
                    var(--pixel-brown) 100%
                );
            padding: 30px 15px;
            text-align: center; 
            font-size: 14px;
            font-weight: 400;
            color: var(--pixel-gold);
            position: relative;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 
                0 4px 0 var(--pixel-shadow),
                inset 0 -2px 0 rgba(0,0,0,0.5),
                inset 0 2px 0 rgba(255,255,255,0.2);
        }

        .name-card::before {
            content: 'â˜…';
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: var(--pixel-gold);
        }

        .name-card:hover {
            background: 
                linear-gradient(135deg, 
                    #9b5513 0%,
                    #7b4413 50%,
                    #9b5513 100%
                );
            transform: translateY(2px);
            box-shadow: 
                0 2px 0 var(--pixel-shadow),
                inset 0 -2px 0 rgba(0,0,0,0.5),
                inset 0 2px 0 rgba(255,255,255,0.2);
        }
        
        .name-card.taken { 
            opacity: 0.3;
            filter: grayscale(1);
            pointer-events: none;
            background: #333;
        }

        .name-card.taken::before {
            content: 'âœ–';
            color: var(--pixel-red);
        }

        .horse-list { 
            padding: 15px; 
            padding-bottom: 120px;
        }
        
        .horse-card { 
            background: 
                linear-gradient(to bottom,
                    #3a2a1a 0%,
                    #2a1a0a 100%
                );
            border: 3px solid var(--pixel-brown);
            padding: 15px; 
            margin-bottom: 15px;
            position: relative;
            transition: all 0.2s;
            box-shadow: 
                4px 4px 0 var(--pixel-shadow),
                inset 0 0 0 1px rgba(255,255,255,0.1);
        }

        .horse-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: repeating-linear-gradient(
                90deg,
                var(--pixel-gold) 0px,
                var(--pixel-gold) 4px,
                transparent 4px,
                transparent 8px
            );
        }

        .horse-card:hover {
            border-color: var(--pixel-gold);
            transform: translateX(2px);
            box-shadow: 
                6px 6px 0 var(--pixel-shadow),
                inset 0 0 0 1px var(--pixel-gold);
        }
        
        .horse-card.selected { 
            border-color: var(--pixel-green);
            background: 
                linear-gradient(to bottom,
                    #2a3a2a 0%,
                    #1a2a1a 100%
                );
            animation: pixel-glow 1s infinite;
        }

        @keyframes pixel-glow {
            0%, 100% { 
                box-shadow: 
                    4px 4px 0 var(--pixel-shadow),
                    0 0 10px var(--pixel-green);
            }
            50% { 
                box-shadow: 
                    4px 4px 0 var(--pixel-shadow),
                    0 0 20px var(--pixel-green);
            }
        }
        
        .horse-card.occupied { 
            opacity: 0.5;
            filter: grayscale(0.8);
            cursor: not-allowed;
        }
        
        .owner-badge { 
            position: absolute;
            top: -10px;
            right: 10px;
            background: var(--pixel-red);
            color: white;
            padding: 5px 14px;
            font-size: 9px;
            font-weight: bold;
            z-index: 2;
            box-shadow: 2px 2px 0 var(--pixel-shadow);
        }

        .stat-grid { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 12px 0;
        }
        
        .stat-label { 
            font-size: 9px;
            color: var(--pixel-gold);
            margin-bottom: 4px;
            text-shadow: 1px 1px 0 var(--pixel-shadow);
        }
        
        .stat-bar { 
            height: 8px;
            background: var(--pixel-shadow);
            border: 2px solid var(--pixel-brown);
            position: relative;
            box-shadow: inset 0 2px 0 rgba(0,0,0,0.5);
        }
        
        .stat-fill { 
            height: 100%;
            background: 
                repeating-linear-gradient(
                    90deg,
                    var(--pixel-gold) 0px,
                    var(--pixel-gold) 2px,
                    #ffdd44 2px,
                    #ffdd44 4px
                );
            box-shadow: 
                inset 0 -1px 0 rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.3);
            position: relative;
            animation: stat-shimmer 2s infinite;
        }

        @keyframes stat-shimmer {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }
        
        .horse-desc { 
            font-size: 9px;
            color: #ccc;
            line-height: 1.6;
            border-top: 2px solid var(--pixel-brown);
            padding-top: 10px;
            margin-top: 10px;
        }

        #page-track { 
            background: 
                linear-gradient(to bottom,
                    var(--pixel-sky) 0%,
                    #7dd4e8 30%,
                    var(--pixel-grass) 60%,
                    #3a5c40 100%
                );
        }

        .track-bg { 
            height: 100%;
            position: relative;
            background-image:
                repeating-linear-gradient(
                    0deg,
                    transparent 0px,
                    transparent 2px,
                    rgba(0,0,0,0.1) 2px,
                    rgba(0,0,0,0.1) 4px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 2px,
                    rgba(0,0,0,0.05) 2px,
                    rgba(0,0,0,0.05) 4px
                );
        }

        .track-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30%;
            background-image:
                radial-gradient(ellipse 60px 20px at 20% 20%, white 40%, transparent 50%),
                radial-gradient(ellipse 80px 25px at 60% 15%, white 40%, transparent 50%),
                radial-gradient(ellipse 50px 18px at 85% 25%, white 40%, transparent 50%);
            opacity: 0.6;
            animation: clouds-move 30s linear infinite;
        }

        @keyframes clouds-move {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 0%; }
        }

        #lanes-render-area { 
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .lane { 
            position: relative;
            border-bottom: 3px solid rgba(0,0,0,0.3);
            flex-grow: 1;
            display: flex;
            align-items: center;
            padding-left: 10px;
            background: 
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 40px,
                    rgba(255,255,255,0.05) 40px,
                    rgba(255,255,255,0.05) 80px
                );
        }

        .lane::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 100%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent 0%,
                    rgba(74, 124, 89, 0.3) 50%,
                    transparent 100%
                );
        }
        
        .finish-line { 
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 50px;
            background: 
                repeating-linear-gradient(
                    45deg,
                    var(--pixel-white) 0px,
                    var(--pixel-white) 8px,
                    var(--pixel-shadow) 8px,
                    var(--pixel-shadow) 16px
                );
            border-left: 4px solid var(--pixel-gold);
            z-index: 5;
            box-shadow: -4px 0 0 var(--pixel-brown);
        }

        .finish-line::before {
            content: 'ğŸ';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            animation: flag-wave 0.5s infinite;
        }

        @keyframes flag-wave {
            0%, 100% { transform: translateX(-50%) rotate(-5deg); }
            50% { transform: translateX(-50%) rotate(5deg); }
        }

        .horse-pawn { 
            position: absolute;
            left: 0;
            display: flex;
            align-items: center;
            width: 140px;
            transition: left 0.1s linear;
            z-index: 10;
            filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.5));
        }
        
        .horse-visual { 
            font-size: 38px;
            transform: scaleX(-1);
            animation: pixel-trot 0.3s steps(2) infinite;
            filter: drop-shadow(0 2px 0 rgba(0,0,0,0.3));
        }

        @keyframes pixel-trot {
            0%, 100% { transform: scaleX(-1) translateY(0); }
            50% { transform: scaleX(-1) translateY(-4px); }
        }
        
        .effect-sprint { 
            animation: pixel-sprint 0.15s steps(2) infinite !important;
            filter: 
                drop-shadow(0 0 8px var(--pixel-gold)) 
                drop-shadow(0 0 12px var(--pixel-orange))
                drop-shadow(0 2px 0 rgba(0,0,0,0.3)) !important;
        }

        @keyframes pixel-sprint {
            0%, 100% { transform: scaleX(-1) translateY(0) rotate(0deg); }
            25% { transform: scaleX(-1) translateY(-6px) rotate(-2deg); }
            75% { transform: scaleX(-1) translateY(-2px) rotate(2deg); }
        }
        
        .effect-exhausted { 
            filter: 
                grayscale(0.5) 
                drop-shadow(0 0 6px var(--pixel-red))
                drop-shadow(0 2px 0 rgba(0,0,0,0.3)) !important;
            animation: pixel-exhausted 0.5s steps(2) infinite !important;
        }

        @keyframes pixel-exhausted {
            0%, 100% { transform: scaleX(-1) translateY(0); }
            50% { transform: scaleX(-1) translateY(2px); }
        }
        
        .effect-slip { 
            animation: pixel-slip 0.1s steps(3) infinite !important;
        }

        @keyframes pixel-slip {
            0% { transform: scaleX(-1) rotate(0deg) translateX(0); }
            33% { transform: scaleX(-1) rotate(15deg) translateX(-2px); }
            66% { transform: scaleX(-1) rotate(-15deg) translateX(2px); }
            100% { transform: scaleX(-1) rotate(0deg) translateX(0); }
        }

        .speech-bubble {
            position: absolute;
            top: -60px;
            left: 10px;
            background: var(--pixel-white);
            color: var(--pixel-dark);
            padding: 8px 16px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 
                3px 3px 0 var(--pixel-shadow),
                inset 0 0 0 2px var(--pixel-brown);
            z-index: 20;
            white-space: nowrap;
            animation: bubble-pop 0.2s steps(3);
        }

        @keyframes bubble-pop {
            0% { transform: scale(0); }
            60% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .speech-bubble::after { 
            content: '';
            position: absolute;
            bottom: -8px;
            left: 15px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid var(--pixel-white);
            filter: drop-shadow(2px 2px 0 var(--pixel-shadow));
        }
        
        .bubble-danger { 
            background: var(--pixel-red);
            color: white;
            animation: bubble-shake 0.1s steps(2) infinite;
        }

        @keyframes bubble-shake {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-2px); }
        }
        
        .bubble-danger::after { 
            border-top-color: var(--pixel-red);
        }
        
        .bubble-recover { 
            background: var(--pixel-blue);
            color: white;
        }
        
        .bubble-recover::after { 
            border-top-color: var(--pixel-blue);
        }

        .stamina-container { 
            width: 60px;
            height: 8px;
            background: var(--pixel-shadow);
            border: 2px solid var(--pixel-brown);
            margin-top: 4px;
            overflow: hidden;
            box-shadow: inset 0 2px 0 rgba(0,0,0,0.5);
        }
        
        .stamina-fill { 
            height: 100%;
            background: 
                repeating-linear-gradient(
                    90deg,
                    var(--pixel-green) 0px,
                    var(--pixel-green) 2px,
                    #55ff99 2px,
                    #55ff99 4px
                );
            transition: width 0.05s linear;
            box-shadow: 
                inset 0 -1px 0 rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }

        #countdown-overlay {
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(
                    circle,
                    rgba(0,0,0,0.7) 0%,
                    rgba(0,0,0,0.9) 100%
                );
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            font-size: 80px;
            color: var(--pixel-gold);
            text-shadow: 
                4px 4px 0 var(--pixel-shadow),
                0 0 20px var(--pixel-orange);
            animation: countdown-pulse 0.5s steps(3) infinite;
        }

        @keyframes countdown-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .admin-monitor-box { 
            background: 
                linear-gradient(to bottom,
                    #2a1a0a 0%,
                    #1a0a00 100%
                );
            border: 3px solid var(--pixel-brown);
            margin: 15px;
            padding: 12px;
            box-shadow: 
                4px 4px 0 var(--pixel-shadow),
                inset 0 0 0 1px rgba(255,255,255,0.1);
        }
        
        .player-status-tag { 
            display: inline-block;
            padding: 6px 14px;
            font-size: 9px;
            margin: 4px;
            background: var(--pixel-dark);
            border: 2px solid var(--pixel-brown);
            color: var(--pixel-white);
            box-shadow: 2px 2px 0 var(--pixel-shadow);
        }
        
        .player-status-tag.ready { 
            border-color: var(--pixel-green);
            color: var(--pixel-green);
            background: rgba(68, 255, 136, 0.1);
            animation: ready-blink 1s steps(2) infinite;
        }

        @keyframes ready-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .admin-persistent-ctrl { 
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        #leaderboard-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        #leaderboard-overlay > div {
            background: 
                linear-gradient(to bottom,
                    var(--pixel-white) 0%,
                    #f5e5d1 100%
                );
            color: var(--pixel-dark);
            width: 85%;
            max-width: 400px;
            padding: 25px;
            text-align: center;
            border: 4px solid var(--pixel-gold);
            box-shadow: 
                8px 8px 0 var(--pixel-shadow),
                inset 0 0 0 2px var(--pixel-brown);
            animation: leaderboard-appear 0.3s steps(5);
        }

        @keyframes leaderboard-appear {
            0% { transform: scale(0) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        #leaderboard-overlay h2 {
            color: var(--pixel-red);
            font-size: 18px;
            margin: 0 0 20px 0;
            text-shadow: 2px 2px 0 var(--pixel-shadow);
            animation: title-bounce 0.5s steps(3) infinite;
        }

        @keyframes title-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        #rankings-list {
            margin: 20px 0;
            font-size: 11px;
            text-align: left;
        }

        #rankings-list > div {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 2px solid var(--pixel-brown);
            background: 
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 2px,
                    rgba(0,0,0,0.02) 2px,
                    rgba(0,0,0,0.02) 4px
                );
        }

        #rankings-list > div:nth-child(1) {
            background: 
                linear-gradient(to right,
                    rgba(255, 215, 0, 0.3) 0%,
                    rgba(255, 215, 0, 0.1) 100%
                );
            font-size: 13px;
        }

        #rankings-list > div:nth-child(2) {
            background: 
                linear-gradient(to right,
                    rgba(192, 192, 192, 0.3) 0%,
                    rgba(192, 192, 192, 0.1) 100%
                );
        }

        #rankings-list > div:nth-child(3) {
            background: 
                linear-gradient(to right,
                    rgba(205, 127, 50, 0.3) 0%,
                    rgba(205, 127, 50, 0.1) 100%
                );
        }

        .pixel-title {
            position: relative;
            display: inline-block;
            padding: 12px 24px;
            background: var(--pixel-brown);
            color: var(--pixel-gold);
            border: 3px solid var(--pixel-gold);
            box-shadow: 
                4px 4px 0 var(--pixel-shadow),
                inset 0 0 0 2px var(--pixel-dark);
            margin: 10px 0;
            font-size: 14px;
            letter-spacing: 2px;
            animation: title-glow 2s steps(4) infinite;
        }

        @keyframes title-glow {
            0%, 100% { 
                box-shadow: 
                    4px 4px 0 var(--pixel-shadow),
                    inset 0 0 0 2px var(--pixel-dark),
                    0 0 10px var(--pixel-gold);
            }
            50% { 
                box-shadow: 
                    4px 4px 0 var(--pixel-shadow),
                    inset 0 0 0 2px var(--pixel-dark),
                    0 0 20px var(--pixel-gold);
            }
        }

        .info-box {
            background: 
                linear-gradient(to bottom,
                    #3a2a1a 0%,
                    #2a1a0a 100%
                );
            padding: 15px;
            border: 3px solid var(--pixel-brown);
            margin: 12px 15px;
            font-size: 9px;
            line-height: 2;
            color: var(--pixel-white);
            box-shadow: 
                4px 4px 0 var(--pixel-shadow),
                inset 0 0 0 1px rgba(255,255,255,0.1);
        }

        .info-box b {
            color: var(--pixel-gold);
            text-shadow: 1px 1px 0 var(--pixel-shadow);
        }

        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--pixel-dark);
            border: 2px solid var(--pixel-brown);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--pixel-brown);
            border: 2px solid var(--pixel-gold);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--pixel-gold);
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .pixel-stars {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            box-shadow: 
                20px 30px white,
                40px 10px white,
                70px 50px white,
                90px 20px white,
                120px 40px white;
            animation: twinkle 3s infinite;
        }
    </style>
</head>
<body>

<div id="countdown-overlay">READY</div>

<div class="header-bar" id="header">
    <div id="header-left">
        <button class="btn-ui" id="btn-back" onclick="logout()" style="background:var(--pixel-red); color:white; display:none;">â† è¿”å›</button>
    </div>
    <div id="header-user-info" style="text-align:right;">
        <div id="label-user-name" style="font-size:12px; color:var(--pixel-gold); text-shadow: 2px 2px 0 var(--pixel-shadow);">GUEST</div>
    </div>
</div>

<div id="page-login" class="page active">
    <div id="admin-login-monitor" style="display:none;" class="admin-monitor-box">
        <div style="font-size:10px; color:var(--pixel-gold); margin-bottom:8px; text-shadow: 1px 1px 0 var(--pixel-shadow);">
            [ADMIN] å³æ™‚é¸é¦¬é€²åº¦ï¼š
        </div>
        <div id="admin-status-grid"></div>
    </div>
    <div style="text-align:center; padding:20px 0;">
        <h1 class="pixel-title" style="margin:20px auto; display:inline-block;">
            ğŸ´ AIOT 2026<br>é¦¬å¹´è³½é¦¬çé‡‘è³½ ğŸ´
        </h1>
        <p style="color:var(--pixel-gold); font-size:10px; margin-top:15px;">
            é»æ“Šä½ çš„åå­—åŠ å…¥æ¯”è³½
        </p>
    </div>
    <div class="login-grid" id="login-grid"></div>
</div>

<div id="page-setup" class="page">
    <div style="text-align:center; padding: 20px 15px 10px;">
        <h2 class="pixel-title" style="font-size:13px; margin:10px auto; display:inline-block;">
            ğŸ é¸æ“‡æˆ°é¦¬ ğŸ
        </h2>
    </div>
    <div class="info-box">
        <b style="font-size:10px;">ğŸ“Š å±¬æ€§å½±éŸ¿èªªæ˜ï¼š</b><br><br>
        <b>â€¢ é€Ÿåº¦ï¼š</b>åŸºç¤ç§»å‹•é€Ÿåº¦ã€‚é€Ÿåº¦è¶Šå¿«ï¼Œé«”åŠ›æ¶ˆè€—ä¹Ÿè¶Šå¿«ã€‚<br>
        <b>â€¢ é«”åŠ›ï¼š</b>å½±éŸ¿çºŒèˆªåŠ›ã€‚æ•¸å€¼è¶Šé«˜ï¼Œè¶Šä¸å®¹æ˜“é€²å…¥ã€Œçˆ†è‚ã€ç‹€æ…‹ã€‚<br>
        <b>â€¢ çˆ†ç™¼ï¼š</b>è¡åˆºæ™‚çš„å¢ç›Šå¼·åº¦ã€‚æ•¸å€¼è¶Šé«˜ï¼Œè§¸ç™¼è¡åˆºæ™‚å™´ç™¼è¶Šé ã€‚<br>
        <b>â€¢ é‹æ°£ï¼š</b>æ•¸å€¼è¶Šé«˜ï¼Œè¶Šä¸å®¹æ˜“æ»‘å€’ï¼Œä¸”è§¸ç™¼è¡åˆºæ©Ÿç‡è¶Šé«˜ã€‚
    </div>
    <div class="horse-list" id="horse-selection-list"></div>
</div>

<div id="page-track" class="page">
    <div class="track-bg">
        <div class="pixel-stars" style="top:20px; left:30px;"></div>
        <div class="pixel-stars" style="top:50px; left:200px; animation-delay: 1s;"></div>
        <div class="pixel-stars" style="top:80px; left:350px; animation-delay: 2s;"></div>
        <div class="finish-line"></div>
        <div id="lanes-render-area"></div>
    </div>
</div>

<div class="admin-persistent-ctrl" id="admin-ctrl">
    <button class="btn-ui" id="admin-start-btn" onclick="adminStart()" style="background:var(--pixel-green); color:var(--pixel-dark); padding:14px 28px; font-size:11px;">
        ğŸ é–‹å§‹æ¯”è³½
    </button>
    <button class="btn-ui" id="admin-reset-btn" onclick="adminReset()" style="background:var(--pixel-red); color:white; padding:12px 24px; font-size:10px;">
        ğŸ”„ é‡ç½®å…¨å ´
    </button>
</div>

<div id="leaderboard-overlay">
    <div>
        <h2>ğŸ† æ’è¡Œæ¦œ ğŸ†</h2>
        <div id="rankings-list"></div>
        <button class="btn-ui" onclick="adminReset()" style="background:var(--pixel-brown); color:var(--pixel-gold); width:100%; padding:12px; display:none; margin-top:15px;" id="lb-reset-btn">
            ä¸‹ä¸€è¼ªæ¯”è³½
        </button>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, burst: 40, lck: 70}, desc: "æ“…é•·åœ¨ä¸»ç®¡è¦–ç·šå¤–ç·©æ­¥å‰é€²ï¼Œé«”åŠ›æ·±ä¸å¯æ¸¬ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 55, sta: 65, burst: 95, lck: 60}, desc: "ä¸€æ—¦å¤•é™½è¥¿ä¸‹ï¼Œé«”åŠ›å†ä½ä¹Ÿèƒ½çˆ†ç™¼è¡åˆºã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, burst: 85, lck: 30}, desc: "èµ·æ­¥ç¬é–“å³å·”å³°ï¼Œä½†çˆ†è‚å€’æ•¸æ˜¯ä»–çš„æ—¥å¸¸ã€‚" },
        { id: 3, trait: "æœƒè­°æˆ°é¬¥æ©Ÿ", stats: {spd: 75, sta: 60, burst: 60, lck: 80}, desc: "ç¯€å¥æ„Ÿæ¥µå¼·,ä»¥ç©©å®šçš„é«˜èªé€Ÿå£“åˆ¶å…¨å ´ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, burst: 75, lck: 55}, desc: "ä¾è³´å’–å•¡å› æé€Ÿï¼Œæ²’å’–å•¡æ™‚é«”åŠ›æ‰è¶…å¿«ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, burst: 30, lck: 99}, desc: "æ“æœ‰ç¥ç´šé–ƒé¿ï¼Œå¹¾ä¹ä¸æœƒæ»‘å€’ï¼Œé‹æ°£é»æ»¿ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, burst: 50, lck: 65}, desc: "é›–ç„¶æ²’å­˜åœ¨æ„Ÿï¼Œä½†é«”åŠ›é©šäººä¸”è·‘å¾—ç•°å¸¸ç©©ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 40, sta: 70, burst: 99, lck: 40}, desc: "å¹³æ™‚éƒ½åœ¨æ··ï¼Œæœ€å¾Œé—œé ­è¡åˆºåŠ›é‡ç„¡äººèƒ½åŠã€‚" },
        { id: 8, trait: "ç”¨å˜´åšäº‹", stats: {spd: 85, sta: 50, burst: 70, lck: 65}, desc: "ç”¨æ°£å‹¢é©…å‹•å››è‚¢ï¼Œçˆ†ç™¼åŠ›èˆ‡é€Ÿåº¦å…¼å…·çš„å‹ç”·ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, burst: 65, lck: 70}, desc: "ä¸æ±‚æœ€å¿«ï¼Œä½†é«”åŠ›èˆ‡é‹æ°£è®“ä»–å§‹çµ‚åœ¨ç¬¬ä¸€æ¢¯éšŠã€‚" },
        { id: 10, trait: "é€šéˆç‹", stats: {spd: 50, sta: 50, burst: 40, lck: 100}, desc: "èƒ½é çŸ¥éœ€æ±‚ï¼Œé è‘—ç¥ç´šç›´è¦ºé¿é–‹æ‰€æœ‰éšœç¤™ã€‚" },
        { id: 11, trait: "ç°¡å ±å¤§å¸«", stats: {spd: 90, sta: 30, burst: 90, lck: 40}, desc: "ç•«é¢å¾ˆè¯éº—ï¼Œä½†çºŒèˆªåŠ›æ¥µä½ï¼Œæ²’è¬›å®Œå°±æ–·é›»ã€‚" },
        { id: 12, trait: "Debugç‹", stats: {spd: 65, sta: 65, burst: 65, lck: 95}, desc: "åªè¦ä»–åœ¨ï¼Œç¨‹å¼ç¢¼è‡ªå‹•ä¿®å¾©ï¼Œæ€éº¼ä¿®çš„?ä¸çŸ¥é“ï¼Œé‹æ°£å°±æ˜¯ä¸€åˆ‡ã€‚" },
        { id: 13, trait: "èŒ¶æ°´é–“å®ˆé–€å“¡", stats: {spd: 40, sta: 100, burst: 20, lck: 80}, desc: "æ¯å¤©æº–æ™‚å ±åˆ°ï¼Œé«”åŠ›å…¨å ´æœ€ç¡¬ï¼Œæ…¢æ…¢ç£¨åˆ°çµ‚é»ã€‚" },
        { id: 14, trait: "Teasm æ½›æ°´å“¡", stats: {spd: 75, sta: 75, burst: 50, lck: 50}, desc: "æ²’äº‹ä¸å›è¨Šï¼Œä¸€æ—¦å›è¨Šæ¯å°±æ˜¯ä¸€é³´é©šäººã€‚" }
    ];

    const names = ["Julia", "Molly", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "Juli", "Jason", "Kris"];
    let myName = localStorage.getItem('race_user') || "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
    let serverOffset = 0;
    const rankEmojis = ["ğŸ¥³", "ğŸ˜", "ğŸ˜Š", "ğŸ˜", "ğŸ¤”", "ğŸ˜“", "ğŸ˜«", "ğŸ˜­", "ğŸ’€", "ğŸª¦"];

    db.ref(".info/serverTimeOffset").on("value", s => serverOffset = s.val());

    function init() {
        if (isAdmin) {
            document.getElementById('admin-ctrl').style.display = 'flex';
            document.getElementById('admin-login-monitor').style.display = 'block';
            document.getElementById('lb-reset-btn').style.display = 'block';
            document.getElementById('label-user-name').innerText = "ADMIN";
        }
        const loginGrid = document.getElementById('login-grid');
        names.forEach(n => {
            const d = document.createElement('div');
            d.className = 'name-card'; d.id = `user-${n}`; d.innerText = n;
            d.onclick = () => { 
                myName = n; 
                localStorage.setItem('race_user', n); 
                db.ref(`users/${n}`).set(true);
            };
            loginGrid.appendChild(d);
        });

        const setupGrid = document.getElementById('horse-selection-list');
        horseLibrary.forEach((h, i) => {
            const d = document.createElement('div');
            d.className = 'horse-card'; d.id = `slot-${i}`;
            d.innerHTML = `
                <div class="owner-badge" id="owner-${i}" style="display:none;"></div>
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
                    <span style="font-size:32px;">ğŸ</span>
                    <div style="font-weight:bold; color:var(--pixel-gold); font-size:12px; text-shadow: 1px 1px 0 var(--pixel-shadow);">${h.trait}</div>
                </div>
                <div class="stat-grid">
                    ${renderStat("é€Ÿåº¦", h.stats.spd)} ${renderStat("é«”åŠ›", h.stats.sta)}
                    ${renderStat("çˆ†ç™¼", h.stats.burst)} ${renderStat("é‹æ°£", h.stats.lck)}
                </div>
                <div class="horse-desc">${h.desc}</div>
            `;
            d.onclick = () => { if(!myName) return; db.ref('assignments').once('value', snap => {
                const a = snap.val() || {}; if (Object.entries(a).some(([p, idx]) => idx === i && p !== myName)) alert("æ…¢äº†ï¼è¢«é¸èµ°å›‰ï¼"); else db.ref(`assignments/${myName}`).set(i);
            });};
            setupGrid.appendChild(d);
        });
        listenFirebase();
    }

    function renderStat(label, val) { 
        return `<div>
            <div class="stat-label">${label}</div>
            <div class="stat-bar">
                <div class="stat-fill" style="width:${val}%"></div>
            </div>
        </div>`; 
    }

    function logout() {
        if(myName) { db.ref(`users/${myName}`).remove(); db.ref(`assignments/${myName}`).remove(); }
        localStorage.removeItem('race_user'); myName = ""; location.reload();
    }

    function listenFirebase() {
        db.ref('users').on('value', snap => {
            const u = snap.val();
            if (!u && myName && !isAdmin) { localStorage.removeItem('race_user'); location.reload(); return; }
            const users = u || {};
            names.forEach(n => { const el = document.getElementById(`user-${n}`); users[n] ? el.classList.add('taken') : el.classList.remove('taken'); });
            if (myName && users[myName]) { switchPage('page-setup'); if(!isAdmin) document.getElementById('label-user-name').innerText = myName; document.getElementById('btn-back').style.display = 'block';
            } else { switchPage('page-login'); document.getElementById('btn-back').style.display = 'none'; }
            updateAdminMonitor(users);
        });

        db.ref('assignments').on('value', snap => {
            const a = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const el = document.getElementById(`slot-${i}`); const badge = document.getElementById(`owner-${i}`); const owner = Object.keys(a).find(k => a[k] === i);
                el.classList.remove('selected', 'occupied');
                if (owner) { badge.style.display = 'block'; badge.innerText = `${owner} å·²é¸`; if (owner === myName) el.classList.add('selected'); else el.classList.add('occupied');
                } else badge.style.display = 'none';
            });
        });

        db.ref('gameState').on('value', snap => {
            const s = snap.val();
            if (s && s.status === 'racing') {
                if(isAdmin) document.getElementById('admin-start-btn').style.display = 'none';
                runRace(s);
            } else {
                if(isAdmin) document.getElementById('admin-start-btn').style.display = 'block';
                document.getElementById('leaderboard-overlay').style.display = 'none';
                if (document.getElementById('page-track').classList.contains('active')) {
                    setTimeout(() => { if (!s || s.status !== 'racing') location.reload(); }, 500);
                }
            }
        });
    }

    function updateAdminMonitor(users) {
        if (!isAdmin) return;
        db.ref('assignments').once('value', snap => {
            const a = snap.val() || {}; const container = document.getElementById('admin-status-grid');
            container.innerHTML = Object.keys(users).map(name => `<span class="player-status-tag ${a[name] !== undefined ? 'ready' : ''}">${name}: ${a[name] !== undefined ? horseLibrary[a[name]].trait : "æœªé¸é¦¬"}</span>`).join('');
        });
    }

    function switchPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('header').style.display = (id === 'page-track') ? 'none' : 'flex';
    }

    function adminStart() {
        db.ref('assignments').once('value', snap => {
            const players = snap.val(); if (!players) return alert("ç„¡äººåƒè³½ï¼");
            const raceData = {}; Object.entries(players).forEach(([name, hIdx]) => {
                const h = horseLibrary[hIdx]; const events = [];
                for(let j=0; j<3; j++) events.push({ t: 8 + (j * 8) + Math.random() * 5, type: (Math.random()*100 < h.stats.lck) ? 'burst' : 'slip' });
                raceData[name] = { hIdx, events };
            });
            db.ref('gameState').set({ status: 'racing', startTime: Date.now() + serverOffset + 4000, raceData });
        });
    }

    function adminReset() { 
        db.ref('users').remove(); 
        db.ref('assignments').remove();
        db.ref('gameState').set({ status: 'idle' });
        setTimeout(() => location.reload(), 300);
    }

    function runRace(state) {
        switchPage('page-track');
        const renderArea = document.getElementById('lanes-render-area'); 
        renderArea.innerHTML = "";
        const players = Object.entries(state.raceData);
        
        players.forEach(([name, data], idx) => {
            const div = document.createElement('div'); 
            div.className = 'lane';
            div.innerHTML = `
                <div class="horse-pawn" id="pawn-${idx}">
                    <div id="bubble-${idx}"></div>
                    <div class="horse-visual" id="vis-${idx}">ğŸ</div>
                    <div style="margin-left:10px;">
                        <div style="font-size:10px; font-weight:bold; text-shadow: 1px 1px 0 rgba(0,0,0,0.5);">${name}</div>
                        <div class="stamina-container"><div class="stamina-fill" id="stam-${idx}" style="width:100%"></div></div>
                    </div>
                </div>
            `;
            renderArea.appendChild(div);
        });

        const finishLineX = renderArea.offsetWidth - 140;

        if (isAdmin) {
            // Adminæ¨¡å¼ï¼šè¨ˆç®—ä¸¦å»£æ’­
            runRaceAsAdmin(state, players, finishLineX);
        } else {
            // ç©å®¶æ¨¡å¼ï¼šæ¥æ”¶ä¸¦é¡¯ç¤º
            runRaceAsPlayer(state, players, finishLineX);
        }
    }

    // Adminæ¨¡å¼ï¼šåŸ·è¡Œè¨ˆç®—ä¸¦å»£æ’­ç‹€æ…‹
    function runRaceAsAdmin(state, players, finishLineX) {
        const runners = players.map(([name, data]) => ({ 
            name, 
            stats: horseLibrary[data.hIdx].stats, 
            events: data.events, 
            progress: 0, 
            stamina: 100, 
            isRecovering: false, 
            recoveryEndTime: 0, 
            finished: false,
            finishTime: 0
        }));
        
        let lastT = Date.now() + serverOffset;
        let isRacing = true;
        let lastBroadcast = 0;

        function frame() {
            if (!isRacing) return;
            const now = Date.now() + serverOffset; 
            const dt = (now - lastT) / 1000; 
            lastT = now; 
            const elapsed = (now - state.startTime) / 1000;
            
            if (elapsed < 0) { 
                const count = Math.ceil(Math.abs(elapsed)); 
                document.getElementById('countdown-overlay').style.display = 'flex'; 
                document.getElementById('countdown-overlay').innerText = count > 3 ? "READY" : count; 
                
                // å»£æ’­å€’æ•¸ç‹€æ…‹
                if (now - lastBroadcast > 200) {
                    lastBroadcast = now;
                    db.ref('gameState/sync').set({
                        phase: 'countdown',
                        count: count > 3 ? "READY" : count,
                        timestamp: now
                    });
                }
                
                requestAnimationFrame(frame); 
                return; 
            }
            
            if (document.getElementById('countdown-overlay').style.display !== 'none') {
                document.getElementById('countdown-overlay').style.display = 'none';
            }

            // è¨ˆç®—æ‰€æœ‰runnerçš„ç‹€æ…‹
            runners.forEach((r, i) => {
                if (r.finished) return;
                const bub = document.getElementById(`bubble-${i}`);
                const stamFill = document.getElementById(`stam-${i}`);
                const vis = document.getElementById(`vis-${i}`);
                vis.className = "horse-visual";

                if (r.isRecovering) {
                    vis.classList.add('effect-exhausted');
                    const rem = r.recoveryEndTime - elapsed;
                    if (rem > 3.5) { 
                        bub.className = "speech-bubble bubble-danger"; 
                        bub.innerText = "ğŸ˜µ å·²çˆ†è‚..."; 
                    } else { 
                        bub.className = "speech-bubble bubble-recover"; 
                        bub.innerText = `ğŸ©¹ èººå¹³ä¸­ ${Math.ceil(rem)}s`; 
                    }
                    if (elapsed >= r.recoveryEndTime) { 
                        r.isRecovering = false; 
                        r.stamina = 100; 
                        bub.innerText = ""; 
                        bub.className = ""; 
                    }
                } else {
                    let spd = (r.stats.spd / 100) * 0.035; 
                    let drain = (1.5 - r.stats.sta/100) * 5;
                    let eventActive = false;
                    let currentEvent = null;
                    
                    r.events.forEach(ev => {
                        if (elapsed >= ev.t && elapsed <= ev.t + 1.5) {
                            eventActive = true;
                            currentEvent = ev.type;
                            if (ev.type === 'burst') { 
                                spd *= (1.5 + r.stats.burst/100); 
                                drain *= 6;
                                bub.className = "speech-bubble"; 
                                bub.innerText = "ğŸ”¥ è¡åˆºï¼"; 
                                vis.classList.add('effect-sprint'); 
                            } else { 
                                r.progress = Math.max(0, r.progress - 0.012 * dt); 
                                bub.className = "speech-bubble bubble-danger"; 
                                bub.innerText = "â›¸ï¸ æ»‘å€’ï¼"; 
                                vis.classList.add('effect-slip'); 
                            }
                        }
                    });
                    
                    if (!eventActive) { 
                        bub.innerText = ""; 
                        bub.className = ""; 
                    }
                    
                    r.progress += spd * dt; 
                    r.stamina = Math.max(0, r.stamina - drain * dt); 
                    if(stamFill) stamFill.style.width = r.stamina + "%";
                    
                    if (r.stamina <= 0 && !r.isRecovering) { 
                        r.isRecovering = true; 
                        r.recoveryEndTime = elapsed + 5; 
                    }
                }
                
                const pawn = document.getElementById(`pawn-${i}`);
                if(pawn) pawn.style.left = (r.progress * finishLineX) + "px";
                
                if (r.progress >= 1 && !r.finished) { 
                    r.finished = true; 
                    r.finishTime = elapsed;
                    bub.className = "finish-emoji"; 
                    bub.innerText = rankEmojis[runners.filter(r=>r.finished).length - 1] || "ğŸ"; 
                }
            });

            // æ¯100mså»£æ’­ä¸€æ¬¡ç‹€æ…‹
            if (now - lastBroadcast > 100) {
                lastBroadcast = now;
                
                const syncData = {
                    phase: 'racing',
                    elapsed: elapsed,
                    timestamp: now,
                    runners: runners.map((r, idx) => {
                        // æ‰¾å‡ºç•¶å‰äº‹ä»¶
                        let currentEvent = null;
                        r.events.forEach(ev => {
                            if (elapsed >= ev.t && elapsed <= ev.t + 1.5) {
                                currentEvent = ev.type;
                            }
                        });
                        
                        return {
                            name: r.name,
                            progress: r.progress,
                            stamina: r.stamina,
                            isRecovering: r.isRecovering,
                            recoveryEndTime: r.recoveryEndTime,
                            finished: r.finished,
                            finishTime: r.finishTime,
                            currentEvent: currentEvent
                        };
                    })
                };
                
                db.ref('gameState/sync').set(syncData);
            }

            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰äººå®Œè³½
            if (runners.every(r => r.finished)) { 
                isRacing = false;
                const sorted = [...runners].sort((a,b) => a.finishTime - b.finishTime);
                
                // å»£æ’­æœ€çµ‚çµæœ
                db.ref('gameState/sync').set({
                    phase: 'finished',
                    results: sorted.map(r => ({
                        name: r.name,
                        finishTime: r.finishTime
                    })),
                    timestamp: now
                });
                
                setTimeout(() => finishGame(sorted), 1000); 
            } else { 
                requestAnimationFrame(frame); 
            }
        }
        requestAnimationFrame(frame);
    }

    // ç©å®¶æ¨¡å¼ï¼šç›£è½ä¸¦é¡¯ç¤ºAdminçš„ç‹€æ…‹
    function runRaceAsPlayer(state, players, finishLineX) {
        const syncRef = db.ref('gameState/sync');
        
        syncRef.on('value', snap => {
            const syncData = snap.val();
            if (!syncData) return;

            // è™•ç†å€’æ•¸éšæ®µ
            if (syncData.phase === 'countdown') {
                document.getElementById('countdown-overlay').style.display = 'flex';
                document.getElementById('countdown-overlay').innerText = syncData.count;
                return;
            }

            // è™•ç†æ¯”è³½éšæ®µ
            if (syncData.phase === 'racing') {
                document.getElementById('countdown-overlay').style.display = 'none';
                
                syncData.runners.forEach((runner, i) => {
                    const pawn = document.getElementById(`pawn-${i}`);
                    const stamFill = document.getElementById(`stam-${i}`);
                    const vis = document.getElementById(`vis-${i}`);
                    const bub = document.getElementById(`bubble-${i}`);

                    if (!pawn || !stamFill || !vis || !bub) return;

                    // æ›´æ–°ä½ç½®
                    pawn.style.left = (runner.progress * finishLineX) + "px";
                    
                    // æ›´æ–°é«”åŠ›æ¢
                    stamFill.style.width = runner.stamina + "%";

                    // æ›´æ–°è¦–è¦ºæ•ˆæœ
                    vis.className = "horse-visual";
                    
                    if (runner.finished) {
                        bub.className = "finish-emoji";
                        const finishedCount = syncData.runners.filter(r => r.finished).length;
                        const rank = syncData.runners.filter(r => r.finished).findIndex(r => r.name === runner.name);
                        bub.innerText = rankEmojis[rank] || "ğŸ";
                    } else if (runner.isRecovering) {
                        vis.classList.add('effect-exhausted');
                        const rem = runner.recoveryEndTime - syncData.elapsed;
                        if (rem > 3.5) {
                            bub.className = "speech-bubble bubble-danger";
                            bub.innerText = "ğŸ˜µ å·²çˆ†è‚...";
                        } else {
                            bub.className = "speech-bubble bubble-recover";
                            bub.innerText = `ğŸ©¹ èººå¹³ä¸­ ${Math.ceil(rem)}s`;
                        }
                    } else if (runner.currentEvent) {
                        if (runner.currentEvent === 'burst') {
                            vis.classList.add('effect-sprint');
                            bub.className = "speech-bubble";
                            bub.innerText = "ğŸ”¥ è¡åˆºï¼";
                        } else if (runner.currentEvent === 'slip') {
                            vis.classList.add('effect-slip');
                            bub.className = "speech-bubble bubble-danger";
                            bub.innerText = "â›¸ï¸ æ»‘å€’ï¼";
                        }
                    } else {
                        bub.innerText = "";
                        bub.className = "";
                    }
                });
            }

            // è™•ç†å®Œè³½éšæ®µ
            if (syncData.phase === 'finished') {
                syncRef.off(); // åœæ­¢ç›£è½
                setTimeout(() => finishGame(syncData.results), 500);
            }
        });
    }

    function finishGame(results) {
        const sorted = [...results].sort((a,b) => a.finishTime - b.finishTime);
        document.getElementById('leaderboard-overlay').style.display = 'flex';
        document.getElementById('rankings-list').innerHTML = sorted.map((r, i) => `<div style="display:flex; justify-content:space-between; padding:12px;"><span>${rankEmojis[i] || ""} #${i+1} ${r.name}</span><span style="color:var(--pixel-red); font-weight:bold;">${getPrize(i+1)}</span></div>`).join('');
    }

    function getPrize(r) { return r === 1 ? "ç¾é‡‘ $2500" : (r <= 5 ? "æ–°å…‰ç¦®å· $1000 " : {6:"ç¾é‡‘ $500", 7:"ç¾é‡‘ $400", 8:"ç¾é‡‘ $300", 9:"ç¾é‡‘ $200", 10:"ç¾é‡‘ $100"}[r] || "-"); }
    init();
</script>
</body>
</html>
